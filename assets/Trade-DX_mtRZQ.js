import{a0 as ae,a1 as ne,j as e,u as b,a2 as Q,a3 as ie,B as j,a4 as O,J as de,M as X,N as ce,K as $,o as H,r as N,a5 as P,a6 as R,a7 as S,L as D,O as B,T as Y,a8 as oe,a9 as le,A as U,aa as me,ab as ue,ac as fe,ad as xe,ae as q,af as pe,ag as W,ah as he,ai as ge,aj as je,Z as z,G as _e,ak as be,H as ve,al as Ne,am as F,an as ye}from"./index-BC4e_IOi.js";import{T as Ce,a as Te,b as ke,c as we,d as I}from"./Filters-R7VyAfv4.js";import{F as ee}from"./friend-id-display-Jx1QYbUL.js";import{C as L}from"./CardLine-CHrVgNAJ.js";import{C as Fe}from"./Card-DdykXFO-.js";import{C as $e}from"./CardsTable-CduGIIt6.js";import{f as Se}from"./utils-BTouiBj-.js";import{A as te,a as Ie,b as Le}from"./alert-DlzIllVm.js";import{S as Ae}from"./index-B11lf-RE.js";import{S as re,u as Ee,a as Me,F as Oe,b as A,c as E,d as M,e as Pe,f as Re,g as Ue}from"./form-BgSMm5eO.js";import{M as se,C as He}from"./react-tooltip.min-D9yRlHdi.js";import"./FancyCard-ItcsBftH.js";import"./trash-2-BdEsq-Bp.js";import"./index-VmvPa3qA.js";function G(t){return ae(ne,t)}const K=({cards:t,selected:n,setSelected:r})=>{const c=[...t].sort((u,i)=>{const d=p=>{const h=p.split("-"),g=h[0]||"",v=h.length>1?parseInt(h[1],10):0;return{setName:g,cardNumber:v}},o=d(u.card_id),m=d(i.card_id);return o.setName!==m.setName?o.setName.localeCompare(m.setName):o.cardNumber-m.cardNumber});function s(u){function i(){n?.card_id===u.card_id?r(null):r(u)}return e.jsx("li",{className:"rounded cursor-pointer",onClick:i,children:e.jsx(L,{className:`w-full ${n?.card_id===u.card_id&&"bg-green-900"} hover:bg-neutral-600`,card_id:u.card_id,rarity:"hidden"})},u.card_id)}return e.jsx("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2 overflow-y-auto",children:e.jsx("ul",{className:"space-y-1",children:c.map(s)})})};function Z(t){return t?e.jsx(L,{card_id:t.card_id,details:"hidden"}):"—"}const De=({yourId:t,friendId:n,yourCard:r,friendCard:c,setYourCard:s,setFriendCard:u})=>{const{t:i}=b("trade-matches"),{toast:d}=Q(),o=ie(),m=r&&c&&r.rarity===c.rarity;async function p(){if(!m)return;const h={offering_friend_id:t,receiving_friend_id:n,offer_card_id:r.card_id,receiver_card_id:c.card_id,status:"offered"};try{o.mutate(h)}catch(g){console.log("TradeOffer: Error inserting trade",g),d({title:i("tradeFailed"),variant:"default"})}s(null),u(null),d({title:i("tradeOffered"),variant:"default"}),O("Offer trade")}return!r&&!c?e.jsx("div",{className:"sticky top-0 z-10 flex rounded-lg border-1 bg-neutral-900 border-neutral-700 border-solid p-2 w-full items-center justify-around text-center h-[166px] sm:h-[110px]",children:e.jsx("h4",{className:"text-lg font-medium",children:i("selectCardsToTrade")})}):e.jsxs("div",{className:"sticky top-0 z-10 bg-neutral-900 rounded-lg border-1 border-neutral-700 border-solid p-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-x-4 gap-y-1 p-1",children:[e.jsxs("div",{className:"w-full sm:w-1/2",children:[e.jsx("h4",{className:"text-lg font-medium",children:i("youGive")}),Z(r)]}),e.jsxs("div",{className:"w-full sm:w-1/2",children:[e.jsx("h4",{className:"text-lg font-medium",children:i("youReceive")}),Z(c)]})]}),e.jsx(j,{className:"block w-full sm:w-96 mx-auto mt-1 text-center",type:"button",variant:"outline",onClick:p,disabled:!m,children:i("offerTrades")})]})};function J(t,n){const r=new Set(n),c=t.filter(s=>r.has(s)).map(s=>Y(s)).filter(s=>S.includes(s.rarity)&&oe.includes(s.expansion));return Object.groupBy(c,s=>s.rarity)}function Be(){const{t}=b(["trade-matches","common"]),{friendId:n}=de(),{data:r,isLoading:c,isError:s}=X(n),{data:u=new Map,isLoading:i,isError:d}=ce(n),{data:o}=$(),{data:m=new Map}=H(),[p,h]=N.useState(null),[g,v]=N.useState(null);if(!o)return null;if(r===null)return e.jsx("p",{className:"text-xl text-center py-8",children:t("notFound")});if(s||d)return e.jsx("p",{className:"text-xl text-center py-8",children:t("common:error")});if(c||i)return e.jsx("div",{className:"mx-auto mt-12 animate-spin rounded-full size-12 border-4 border-white border-t-transparent"});if(!r?.is_active_trading)return e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-xl ",children:t("inActiveTradePage",{username:r?.username})}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:t("inActiveTradeDescription")})]});const T=J(R(m,o.trade_rarity_settings),P(u,r.trade_rarity_settings)),y=J(R(u,r.trade_rarity_settings),P(m,o.trade_rarity_settings)),a=S.some(x=>(T[x]??[]).length>0&&(y[x]??[]).length>0);return e.jsxs("div",{className:"kap-4 justify-center w-full m-auto px-1 sm:px-2",children:[e.jsxs("div",{className:"mb-4 mx-1 flex justify-between",children:[e.jsxs("h1",{children:[e.jsx("span",{className:"text-2xl font-light",children:t("tradingWith")}),e.jsxs("span",{className:"text-2xl font-bold",children:[" ",r.username," "]}),e.jsx("span",{className:"block sm:inline text-sm",children:e.jsx(ee,{friendId:r.friend_id})})]}),e.jsx(D,{to:`/collection/${n}`,children:e.jsxs(j,{children:["Collection",e.jsx(B,{})]})})]}),e.jsx(De,{yourId:o.friend_id,friendId:r.friend_id,yourCard:p,friendCard:g,setYourCard:h,setFriendCard:v}),!a&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-xl ",children:t("noPossibleTrades")}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:t("noPossibleTradesDescription")})]}),S.map(x=>e.jsxs("div",{className:"mt-4",children:[e.jsxs("h3",{className:"text-xl font-semibold mb-2 text-center",children:["[ ",x," ]"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-4",children:[e.jsxs("div",{className:"w-full sm:w-1/2",children:[e.jsx("h4",{className:"text-md font-medium mb-1 ml-2",children:t("youHave")}),T[x]?e.jsx(K,{cards:T[x],selected:p,setSelected:h}):e.jsx("div",{className:"text-center text-neutral-500 rounded-lg border-1 border-neutral-700 border-solid p-2",children:"No cards to trade"})]}),e.jsxs("div",{className:"w-full sm:w-1/2",children:[e.jsx("h4",{className:"text-md font-medium mb-1 ml-2",children:t("friendHas")}),y[x]?e.jsx(K,{cards:y[x],selected:g,setSelected:v}):e.jsx("div",{className:"text-center text-neutral-500  rounded-lg border-1 border-neutral-700 border-solid p-2",children:"No cards to trade"})]})]})]},x))]})}function Ve(){const{t}=b("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(te,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(Ae,{className:"h-4 w-4"}),e.jsx(Ie,{children:t("notLoggedIn.title")}),e.jsx(Le,{children:t("notLoggedIn.description")})]})})}const We=["lookingFor","forTrade"];function ze(){const{t}=b(["pages/trade","filters"]),{data:n}=le(),{data:r,isLoading:c}=$(),{data:s,isLoading:u}=H(),[i,d]=N.useState([]),[o,m]=N.useState("lookingFor"),p=f=>(i.length===0?S:i).includes(f.rarity),h=f=>{if(!s)throw new Error("populateCards called before collection loaded");const _=Y(f),C=s.get(f)?.amount_owned??0;return{..._,amount_owned:C}},g=N.useMemo(()=>r&&s&&P(s,r.trade_rarity_settings).map(h),[s,r]),v=N.useMemo(()=>g?.filter(p),[g,i]),T=N.useMemo(()=>r&&s&&R(s,r.trade_rarity_settings).map(h),[s,r]),y=N.useMemo(()=>T?.filter(p),[T,i]);if(c||u)return e.jsx("div",{className:"mx-auto mt-12 animate-spin rounded-full size-12 border-4 border-white border-t-transparent"});if(!n||!r)return e.jsx(Ve,{});if(!v||!y)return e.jsx("p",{className:"text-xl text-center py-8",children:"Something went wrong"});const a=()=>{let f="";r?.is_public&&(f+=`${t("publicTradePage")} https://tcgpocketcollectiontracker.com/#/trade/${r?.friend_id}
`),r?.username&&(f+=`${t("friendID")} ${r.friend_id} (${r.username})

`),f+=`${t("lookingForCards")}
`;const _=v.sort((l,w)=>{const V=l.expansion.localeCompare(w.expansion);return V!==0?V:l.rarity.localeCompare(w.rarity)});for(let l=0;l<_.length;l++)(l>0?_[l-1].expansion:"")!==_[l].expansion&&(f+=`
${_[l].set_details}:
`),f+=`${_[l].rarity} ${_[l].card_id} - ${_[l].name}
`;const C=v.map(l=>l.rarity);f+=`

${t("forTradeCards")}
`;const k=y.filter(l=>C.includes(l.rarity)).sort((l,w)=>l.rarity.localeCompare(w.rarity));for(let l=0;l<k.length;l++)(l>0?k[l-1].expansion:"")!==k[l].expansion&&(f+=`
${k[l].set_details}:
`),f+=`${k[l].rarity} ${k[l].card_id} - ${k[l].name}
`;return f},x=async()=>{const f=a();U({title:t("copiedInClipboard"),variant:"default",duration:3e3}),await navigator.clipboard.writeText(f)};return e.jsx($e,{cards:o==="lookingFor"?v:y,render:f=>e.jsx(Fe,{card:f,editable:!1}),children:e.jsxs("div",{className:"flex flex-wrap gap-2 mx-2 mb-2",children:[e.jsx(Ce,{options:We,value:o,onChange:m,show:t}),e.jsx(Te,{options:S,value:i,onChange:d,show:Se,asChild:!0}),e.jsx(j,{variant:"outline",onClick:x,children:"Copy to clipboard"})]})})}function Ge({partner:t}){const{t:n}=b("trade-matches");return e.jsxs("div",{className:"max-w-md w-full flex justify-between items-center mx-auto px-4",children:[e.jsx("p",{className:"mr-2",children:t.username}),e.jsx(D,{to:`/trade/${t.friend_id}`,children:e.jsxs(j,{variant:"outline",className:"my-auto",children:[n("viewTradePartner"),e.jsx(B,{})]})})]})}function Ke(){const{t}=b(["trade-matches","common"]),{data:n,isLoading:r,isError:c}=me();return r?e.jsxs("p",{className:"text-xl text-center py-8",children:[t("common:loading"),e.jsx("br",{}),t("longOperation")]}):c?e.jsx("p",{className:"text-xl text-center py-8",children:t("common:error")}):n?.length?e.jsx("div",{className:"flex flex-col gap-4",children:n.map(s=>e.jsx(Ge,{partner:s},s.friend_id))}):e.jsx("p",{className:"text-xl text-center py-8",children:t("noTradePartners")})}const Ze=({row:t,selectedTradeId:n,setSelectedTradeId:r})=>{const{t:c}=b("trade-matches"),{data:s}=$();if(!s)return null;const u=t.offering_friend_id===s.friend_id?t.offer_card_id:t.receiver_card_id,i=t.offering_friend_id===s.friend_id?t.receiver_card_id:t.offer_card_id;function d(m){n===m.id?r(void 0):r(m.id)}const o=m=>{const p={offered:{icon:m.offering_friend_id===s.friend_id?"→":"←",color:"bg-amber-600"},accepted:{icon:"↔",color:"bg-lime-600"},declined:{icon:"X",color:"bg-stone-600"},finished:{icon:"✓",color:"bg-indigo-600"}};return e.jsxs("div",{className:"flex items-center",children:[e.jsx(se,{id:`tooltip-${m.id}`}),e.jsx("span",{className:`rounded-full text-center w-7 md:w-9 ${p[m.status].color}`,"data-tooltip-id":`tooltip-${m.id}`,"data-tooltip-content":c(`status.${m.status}`),children:p[m.status].icon})]})};return e.jsxs("li",{className:`flex cursor-pointer rounded gap-1 md:gap-4 p-1 ${n===t.id&&"bg-green-900"} hover:bg-neutral-500`,onClick:()=>d(t),children:[o(t),e.jsxs("div",{className:"flex flex-col sm:flex-row w-full justify-between gap-1 md:gap-4",children:[e.jsx(L,{className:"sm:w-1/2",card_id:u,increment:-1}),e.jsx(L,{className:"sm:w-1/2",card_id:i,increment:1})]})]})};function Je({trades:t,viewHistory:n}){const{t:r}=b("trade-matches"),{toast:c}=Q(),{data:s}=$(),{data:u=new Map}=H(),i=ue();function d(a){return a.offering_friend_id===s?.friend_id&&!a.offerer_ended||a.receiving_friend_id===s?.friend_id&&!a.receiver_ended}const o=n?t.filter(a=>!d(a)):t.filter(d),[m,p]=N.useState(void 0),h=fe();if(!s)return null;const g=(a,x)=>{const f=xe(a);return{card_id:a,internal_id:f,amount_owned:(u.get(f)?.amount_owned??0)+x}},v=async a=>{if(a.offer_card_id!==a.receiver_card_id)if(a.offering_friend_id===s.friend_id){const x=[g(a.offer_card_id,-1),g(a.receiver_card_id,1)];i.mutate({updates:x}),c({title:r("collectionUpdated"),variant:"default"})}else if(a.receiving_friend_id===s.friend_id){const x=[g(a.offer_card_id,1),g(a.receiver_card_id,-1)];i.mutate({updates:x}),c({title:r("collectionUpdated"),variant:"default"})}else console.log(a,"can't match friend id")},T=a=>{const x=async C=>{h.mutate({id:a.id,trade:{status:C}}),p(a.id),O(`Updated trade: ${C}`)},f=async()=>{const C=a.offering_friend_id===s.friend_id?{offerer_ended:!0}:a.receiving_friend_id===s.friend_id?{receiver_ended:!0}:null;if(C===null){console.log(a," doesn't match your friend_id");return}h.mutate({id:a.id,trade:C}),p(void 0),O("Updated trade: ended")},_=a.offering_friend_id===s.friend_id&&a.offerer_ended||a.receiving_friend_id===s.friend_id&&a.receiver_ended;switch(a.status){case"offered":return e.jsxs(e.Fragment,{children:[a.receiving_friend_id===s.friend_id&&e.jsx(j,{type:"button",onClick:async()=>x("accepted"),children:r("actionAccept")}),e.jsx(j,{type:"button",onClick:async()=>x("declined"),children:a.receiving_friend_id===s.friend_id?r("actionDecline"):r("actionCancel")})]});case"accepted":return e.jsxs(e.Fragment,{children:[e.jsx(j,{type:"button",onClick:async()=>x("finished"),children:r("actionComplete")}),e.jsx(j,{type:"button",onClick:async()=>x("declined"),children:r("actionCancel")})]});case"declined":return _?null:e.jsx(j,{type:"button",onClick:f,children:r("actionHide")});case"finished":return _?null:e.jsxs(e.Fragment,{children:[e.jsx(j,{type:"button",onClick:async()=>{await v(a),await f()},children:r("actionUpdate")}),e.jsx(j,{type:"button",onClick:f,children:r("actionHide")})]});default:return console.log(`Unknown trade status ${a.status}`),null}},y=o.find(a=>a.id===m);return o.length===0?null:e.jsxs("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-1 sm:p-2",children:[e.jsxs("div",{className:"hidden sm:flex px-1",children:[e.jsx("div",{className:"w-9"}),e.jsx("h4",{className:"text-lg font-medium w-1/2 ml-8",children:r("youGive")}),e.jsx("h4",{className:"text-lg font-medium w-1/2 ml-8",children:r("youReceive")})]}),e.jsx("ul",{className:"flex flex-col gap-2 sm:gap-0",children:o.toSorted((a,x)=>a.created_at>x.created_at?-1:1).map(a=>e.jsx(Ze,{row:a,selectedTradeId:m,setSelectedTradeId:p},a.id))}),y&&e.jsx("div",{className:"flex gap-4 text-center items-center mt-2",children:T(y)})]})}function Qe({friendId:t}){const{t:n}=b("trade-matches"),{data:r}=q(),{data:c}=X(t),[s,u]=N.useState(!1);if(!r)return null;const i=r.filter(d=>d.offering_friend_id===t||d.receiving_friend_id===t);return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1 mx-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-md",children:n("tradingWith")}),e.jsxs("span",{className:"text-md font-bold",children:[" ",c?.username||"loading"," "]}),c&&e.jsx(ee,{friendId:c.friend_id,showFriendId:!1,className:"ml-1"})]}),e.jsxs("span",{className:"flex gap-4",children:[e.jsxs("label",{htmlFor:`history-${t}`,className:"my-auto flex items-center",children:[n("viewHistory"),e.jsx(re,{id:`history-${t}`,className:"ml-2 my-auto",checked:s,onCheckedChange:u})]}),e.jsx(D,{to:`/trade/${t}`,children:e.jsxs(j,{variant:"outline",className:"my-auto",children:[n("openTradeWith"),e.jsx(B,{})]})})]})]}),c!==null&&e.jsx(Je,{trades:i,viewHistory:s})]})}function Xe(){const{t}=b("trade-matches"),{data:n}=$(),{data:r}=q();if(!r||!n)return null;if(r.length===0)return e.jsx("p",{children:t("noTradeOffers")});const c=qe(r,n.friend_id),s=Object.fromEntries(Object.entries(c).map(([d,o])=>[d,+(Ye(o,n.friend_id).length===0)])),u=Object.fromEntries(Object.entries(c).map(([d,o])=>[d,Math.max(...o.map(m=>new Date(m.updated_at).getTime()))])),i=Object.keys(c).toSorted((d,o)=>s[d]!==s[o]?s[d]-s[o]:u[o]-u[d]);return e.jsx("div",{className:"flex flex-col items-center mx-auto gap-6 sm:px-4 mb-12 w-full",children:i.map(d=>e.jsx(Qe,{friendId:d},d))})}function Ye(t,n){return t.filter(r=>r.offering_friend_id===n?!r.offerer_ended:!r.receiver_ended)}function qe(t,n){return Object.groupBy(t,r=>r.offering_friend_id===n?r.receiving_friend_id:r.receiving_friend_id===n?r.offering_friend_id:(console.log("Fetched row does not match user friend_id",r),"undefined"))}function et(){const{t}=b("trade-matches"),{data:n}=$(),r=pe(),c=W({is_active_trading:je(),trade_rarity_settings:he(W({rarity:ge(_e),to_collect:G().min(0).max(100),to_keep:G().min(0).max(100)}))}),s=Ee({resolver:Me(c),values:{is_active_trading:n?.is_active_trading||!1,trade_rarity_settings:n?.trade_rarity_settings||[]}}),u=async i=>{try{r.mutate({username:n?.username,is_active_trading:i.is_active_trading,trade_rarity_settings:i.trade_rarity_settings}),U({title:t("accountSaved"),variant:"default"})}catch(d){console.error("error saving account",d),U({title:t("errorSavingAccount"),variant:"destructive"})}};return!n||!n.username?e.jsx(te,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:t("noAccount")}):e.jsxs("div",{children:[e.jsx(Oe,{...s,children:e.jsxs("form",{onSubmit:s.handleSubmit(u),className:"border-1 border-neutral-700 space-y-2 p-4 mx-auto",children:[e.jsx(A,{control:s.control,name:"is_active_trading",render:({field:i})=>e.jsx(E,{className:"flex flex-col items-start",children:e.jsx(M,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(Pe,{className:"flex sm:w-72",children:t("isActiveTrading")}),e.jsx("div",{className:"grow-1",children:e.jsx(re,{checked:i.value,onCheckedChange:i.onChange})}),e.jsx(Re,{className:"grow",children:i.value?"active":"disabled"}),e.jsx(se,{id:"activeInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(He,{className:"h-4 w-4","data-tooltip-id":"activeInput","data-tooltip-content":t("activeTradingInputTooltip")})]})})})}),e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex items-center gap-x-4 mb-2",children:[e.jsx("div",{className:"flex-1",children:t("rarity")}),e.jsx("div",{className:"flex-1",children:t("toCollect")}),e.jsx("div",{className:"flex-1",children:t("toKeep")})]}),s.watch("trade_rarity_settings").map((i,d)=>e.jsxs("div",{className:"flex items-center gap-x-4 mb-2",children:[e.jsx("div",{className:"flex-1",children:i.rarity}),e.jsx(A,{control:s.control,name:`trade_rarity_settings.${d}.to_collect`,render:({field:o})=>e.jsx(E,{className:"flex-1",children:e.jsx(M,{children:e.jsx(z,{className:"w-24",type:"number",...o})})})}),e.jsx(A,{control:s.control,name:`trade_rarity_settings.${d}.to_keep`,render:({field:o})=>e.jsx(E,{className:"flex-1",children:e.jsx(M,{children:e.jsx(z,{className:"w-24",type:"number",...o})})})})]},d))]}),e.jsx("div",{className:"w-full flex justify-end mt-8",children:e.jsx(j,{type:"submit",children:t("save")})})]})}),e.jsx(Ue,{className:"mt-4"})]})}function pt(){const{t}=b("trade-matches"),n=be(),r=ve(),c=n.pathname.split("/").pop()||"offers";return N.useEffect(()=>{n.pathname==="/trade"&&r("/trade/offers")},[n.pathname,r]),e.jsxs(ke,{className:"flex flex-col mx-auto max-w-[900px]",value:c,onValueChange:s=>r(`/trade/${s}`),children:[e.jsxs(we,{className:"gap-4 mb-6 rounded-lg border-b-1 border-neutral-700 border-solid dark:bg-transparent pb-2",children:[e.jsx(I,{className:"text-md",value:"cards",children:t("tabCards")}),e.jsx(I,{className:"text-md",value:"offers",children:t("tabOffers")}),e.jsx(I,{className:"text-md",value:"matches",children:t("tabMatches")}),e.jsx(I,{className:"text-md",value:"settings",children:t("tabSettings")})]}),e.jsxs(Ne,{children:[e.jsx(F,{path:"/",element:e.jsx(ye,{to:"/trade/offers",replace:!0})}),e.jsx(F,{path:"cards",element:e.jsx(ze,{})}),e.jsx(F,{path:"offers",element:e.jsx(Xe,{})}),e.jsx(F,{path:"matches",element:e.jsx(Ke,{})}),e.jsx(F,{path:"settings",element:e.jsx(et,{})}),e.jsx(F,{path:":friendId",element:e.jsx(Be,{})})]})]})}export{pt as default};
