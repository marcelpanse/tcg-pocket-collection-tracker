import{a0 as ee,a1 as te,j as e,f as N,a2 as Y,a3 as se,D as p,a4 as P,M as re,B as ae,N as Z,O as ne,C as S,p as J,r as g,T as $,a5 as R,a6 as z,a7 as F,L as O,a8 as ie,a9 as de,aa as ce,ab as le,ac as oe,ad as Q,ae as me,af as U,ag as ue,ah as fe,ai as xe,Z as B,E as H,J as he,aj as pe,K as je,ak as _e,al as C,am as ge}from"./index-CBMXlKxj.js";import{T as be,a as Ne,b as w}from"./tabs-BKy5Qzqp.js";import{F as X}from"./friend-id-display-BGs0cGkE.js";import{C as k}from"./CardLine-BIIkRRhD.js";import{C as L}from"./chevron-right-IWMrNg8y.js";import{g as ve,u as ye}from"./filters-dVRGtIBR.js";import{S as Ce}from"./SearchInput-Ds7LW1s0.js";import{S as q,u as Te,a as ke,F as Se,b as I,c as A,d as E,e as we,f as $e}from"./form-DmKJ5UlK.js";import{M,C as D}from"./react-tooltip.min-zooaCMC9.js";import{A as Fe}from"./alert-CFf1o-0-.js";import"./index-BJbqDFvn.js";import"./index-7DmMOMYR.js";function V(t){return ee(te,t)}const K=({cards:t,selected:n,setSelected:s})=>{const i=[...t].sort((m,d)=>{const c=x=>{const j=x.split("-"),_=j[0]||"",b=j.length>1?parseInt(j[1],10):0;return{setName:_,cardNumber:b}},o=c(m.card_id),l=c(d.card_id);return o.setName!==l.setName?o.setName.localeCompare(l.setName):o.cardNumber-l.cardNumber});function r(m){function d(){n?.card_id===m.card_id?s(null):s(m)}return e.jsx("li",{className:"rounded cursor-pointer",onClick:d,children:e.jsx(k,{className:`w-full ${n?.card_id===m.card_id&&"bg-green-900"} hover:bg-neutral-600`,card_id:m.card_id,rarity:"hidden"})},m.card_id)}return e.jsx("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2 overflow-y-auto",children:e.jsx("ul",{className:"space-y-1",children:i.map(r)})})};function W(t){return t?e.jsx(k,{card_id:t.card_id,details:"hidden"}):"—"}const Ie=({yourId:t,friendId:n,yourCard:s,friendCard:i,setYourCard:r,setFriendCard:m})=>{const{t:d}=N("trade-matches"),{toast:c}=Y(),o=se(),l=s&&i&&s.rarity===i.rarity;async function x(){if(!l)return;const j={offering_friend_id:t,receiving_friend_id:n,offer_card_id:s.card_id,receiver_card_id:i.card_id,status:"offered"};try{o.mutate(j)}catch(_){console.log("TradeOffer: Error inserting trade",_),c({title:d("tradeFailed"),variant:"default"})}r(null),m(null),c({title:d("tradeOffered"),variant:"default"}),P("Offer trade")}return!s&&!i?e.jsx("div",{className:"sticky top-0 z-10 flex rounded-lg border-1 bg-neutral-900 border-neutral-700 border-solid p-2 w-full items-center justify-around text-center h-[166px] sm:h-[110px]",children:e.jsx("h4",{className:"text-lg font-medium",children:d("selectCardsToTrade")})}):e.jsxs("div",{className:"sticky top-0 z-10 bg-neutral-900 rounded-lg border-1 border-neutral-700 border-solid p-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-x-4 gap-y-1 p-1",children:[e.jsxs("div",{className:"w-full sm:w-1/2",children:[e.jsx("h4",{className:"text-lg font-medium",children:d("youGive")}),W(s)]}),e.jsxs("div",{className:"w-full sm:w-1/2",children:[e.jsx("h4",{className:"text-lg font-medium",children:d("youReceive")}),W(i)]})]}),e.jsx(p,{className:"block w-full sm:w-96 mx-auto mt-1 text-center",type:"button",variant:"outline",onClick:x,disabled:!l,children:d("offerTrades")})]})};function G(t,n){const s=new Set(n),i=t.filter(r=>s.has(r)).map(r=>$(r)).filter(r=>F.includes(r.rarity)&&ie.includes(r.expansion));return Object.groupBy(i,r=>r.rarity)}function Ae(){const{t}=N(["trade-matches","common"]),{friendId:n}=re(),[s]=ae(),{data:i,isLoading:r,isError:m}=Z(n),{data:d=new Map,isLoading:c,isError:o}=ne(n),{data:l}=S(),{data:x=new Map}=J(),[j,_]=g.useState(null),[b,y]=g.useState(()=>{const u=s.get("friend_card");return u?$(Number(u))??null:null});if(g.useEffect(()=>{const u=s.get("friend_card");if(!u||!d||!x)return;const T=$(Number(u));if(!T)return;const v=document.getElementById(T.rarity);v&&v.scrollIntoView({behavior:"smooth"})},[s,d,x]),!l)return null;if(i===null)return e.jsx("p",{className:"text-xl text-center py-8",children:t("notFound")});if(m||o)return e.jsx("p",{className:"text-xl text-center py-8",children:t("common:error")});if(r||c)return e.jsx("div",{className:"mx-auto mt-12 animate-spin rounded-full size-12 border-4 border-white border-t-transparent"});if(!i?.is_active_trading)return e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-xl ",children:t("inActiveTradePage",{username:i?.username})}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:t("inActiveTradeDescription")})]});const f=G(z(x,l.trade_rarity_settings),R(d,i.trade_rarity_settings)),a=G(z(d,i.trade_rarity_settings),R(x,l.trade_rarity_settings)),h=F.some(u=>(f[u]??[]).length>0&&(a[u]??[]).length>0);return e.jsxs("div",{className:"kap-4 justify-center w-full m-auto px-1 sm:px-2",children:[e.jsx("title",{children:`Trade with ${i.username} – TCG Pocket Collection Tracker`}),e.jsxs("div",{className:"mb-4 mx-1 flex justify-between",children:[e.jsxs("h1",{children:[e.jsx("span",{className:"text-2xl font-light",children:t("tradingWith")}),e.jsxs("span",{className:"text-2xl font-bold",children:[" ",i.username," "]}),e.jsx("span",{className:"block sm:inline text-sm",children:e.jsx(X,{friendId:i.friend_id})})]}),e.jsx(O,{to:`/collection/${n}`,children:e.jsxs(p,{children:["Collection",e.jsx(L,{})]})})]}),e.jsx(Ie,{yourId:l.friend_id,friendId:i.friend_id,yourCard:j,friendCard:b,setYourCard:_,setFriendCard:y}),!h&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-xl ",children:t("noPossibleTrades")}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:t("noPossibleTradesDescription")})]}),F.map(u=>e.jsxs("div",{className:"mt-4",children:[e.jsxs("h3",{id:u,className:"text-xl font-semibold mb-2 text-center",children:["[ ",u," ]"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-4",children:[e.jsxs("div",{className:"w-full sm:w-1/2",children:[e.jsx("h4",{className:"text-md font-medium mb-1 ml-2",children:t("youHave")}),f[u]?e.jsx(K,{cards:f[u],selected:j,setSelected:_}):e.jsx("div",{className:"text-center text-neutral-500 rounded-lg border-1 border-neutral-700 border-solid p-2",children:"No cards to trade"})]}),e.jsxs("div",{className:"w-full sm:w-1/2",children:[e.jsx("h4",{className:"text-md font-medium mb-1 ml-2",children:t("friendHas")}),a[u]?e.jsx(K,{cards:a[u],selected:b,setSelected:y}):e.jsx("div",{className:"text-center text-neutral-500  rounded-lg border-1 border-neutral-700 border-solid p-2",children:"No cards to trade"})]})]})]},u))]})}function Ee(){const{t}=N(["trade-matches","common"]),n=g.useRef(null),[s,i]=g.useState(""),[r,m]=g.useState(),[d,c]=g.useState(!1),o=g.useMemo(()=>ve({search:s,rarity:[...F]},new Map),[s]),{data:l,isLoading:x,isError:j}=de(d,r),_=g.useCallback(f=>o[f].card_id,[]),b=ye({getScrollElement:()=>n.current,count:o.length,getItemKey:_,estimateSize:()=>32});if(!d)return e.jsxs("div",{className:"sm:w-sm mx-auto",children:[e.jsx(Ce,{setValue:i}),e.jsx("div",{ref:n,className:"my-2 h-96 rounded border border-neutral-700 px-1 overflow-y-auto",children:e.jsx("ul",{style:{height:`${b.getTotalSize()}px`},className:"relative",children:b.getVirtualItems().map(f=>{const a=o[f.index];return e.jsx("button",{type:"button",className:"absolute top-0 left-0 w-full cursor-pointer",style:{height:`${f.size}px`,transform:`translateY(${f.start}px)`},onClick:()=>m(h=>h===a.internal_id?void 0:a.internal_id),children:e.jsx(k,{className:`w-full ${r===a.internal_id&&"bg-green-900"} hover:bg-neutral-600`,card_id:a.card_id})},f.key)})})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(p,{className:"w-1/2",disabled:!r,onClick:()=>{c(!0)},children:r?`Search ${$(r)?.name}`:"Select card to search"}),e.jsx(p,{className:"w-1/2",onClick:()=>{m(void 0),c(!0)},children:"Search all cards"})]})]});if(x)return e.jsxs("p",{className:"text-xl text-center py-8",children:[t("common:loading"),e.jsx("br",{}),t("longOperation")]});if(j||!l)return e.jsx("p",{className:"text-xl text-center py-8",children:t("common:error")});if(l.length===0)return e.jsx("p",{className:"text-xl text-center py-8",children:t("noTradePartners")});const y=r?`?friend_card=${r}`:"";return e.jsx("div",{className:"flex flex-col gap-4",children:l.map(f=>e.jsxs("div",{className:"max-w-md w-full flex justify-between items-center mx-auto px-4",children:[e.jsx("p",{className:"mr-2",children:f.username}),e.jsx(O,{to:`/trade/${f.friend_id}${y}`,children:e.jsxs(p,{variant:"outline",className:"my-auto",children:[t("viewTradePartner",{tradeMatches:f.trade_matches}),e.jsx(L,{})]})})]},f.friend_id))})}const Pe=({row:t,selectedTradeId:n,setSelectedTradeId:s})=>{const{t:i}=N("trade-matches"),{data:r}=S();if(!r)return null;const m=t.offering_friend_id===r.friend_id?t.offer_card_id:t.receiver_card_id,d=t.offering_friend_id===r.friend_id?t.receiver_card_id:t.offer_card_id;function c(l){n===l.id?s(void 0):s(l.id)}const o=l=>{const x={offered:{icon:l.offering_friend_id===r.friend_id?"→":"←",color:"bg-amber-600"},accepted:{icon:"↔",color:"bg-lime-600"},declined:{icon:"X",color:"bg-stone-600"},finished:{icon:"✓",color:"bg-indigo-600"}};return e.jsxs("div",{className:"flex items-center",children:[e.jsx(M,{id:`tooltip-${l.id}`}),e.jsx("span",{className:`rounded-full text-center w-7 md:w-9 ${x[l.status].color}`,"data-tooltip-id":`tooltip-${l.id}`,"data-tooltip-content":i(`status.${l.status}`),children:x[l.status].icon})]})};return e.jsxs("li",{className:`flex cursor-pointer rounded gap-1 md:gap-4 p-1 ${n===t.id&&"bg-green-900"} hover:bg-neutral-500`,onClick:()=>c(t),children:[o(t),e.jsxs("div",{className:"flex flex-col sm:flex-row w-full justify-between gap-1 md:gap-4",children:[e.jsx(k,{className:"sm:w-1/2",card_id:m,increment:-1}),e.jsx(k,{className:"sm:w-1/2",card_id:d,increment:1})]})]})};function Me({trades:t,viewHistory:n}){const{t:s}=N("trade-matches"),{toast:i}=Y(),{data:r}=S(),{data:m=new Map}=J(),d=ce();function c(a){return a.offering_friend_id===r?.friend_id&&!a.offerer_ended||a.receiving_friend_id===r?.friend_id&&!a.receiver_ended}const o=n?t.filter(a=>!c(a)):t.filter(c),[l,x]=g.useState(void 0),j=le();if(!r)return null;const _=(a,h)=>{const u=oe(a);return{card_id:a,internal_id:u,amount_owned:(m.get(u)?.amount_owned??0)+h}},b=async a=>{if(a.offer_card_id!==a.receiver_card_id)if(a.offering_friend_id===r.friend_id){const h=[_(a.offer_card_id,-1),_(a.receiver_card_id,1)];d.mutate({updates:h}),i({title:s("collectionUpdated"),variant:"default"})}else if(a.receiving_friend_id===r.friend_id){const h=[_(a.offer_card_id,1),_(a.receiver_card_id,-1)];d.mutate({updates:h}),i({title:s("collectionUpdated"),variant:"default"})}else console.log(a,"can't match friend id")},y=a=>{const h=async v=>{j.mutate({id:a.id,trade:{status:v}}),x(a.id),P(`Updated trade: ${v}`)},u=async()=>{const v=a.offering_friend_id===r.friend_id?{offerer_ended:!0}:a.receiving_friend_id===r.friend_id?{receiver_ended:!0}:null;if(v===null){console.log(a," doesn't match your friend_id");return}j.mutate({id:a.id,trade:v}),x(void 0),P("Updated trade: ended")},T=a.offering_friend_id===r.friend_id&&a.offerer_ended||a.receiving_friend_id===r.friend_id&&a.receiver_ended;switch(a.status){case"offered":return e.jsxs(e.Fragment,{children:[a.receiving_friend_id===r.friend_id&&e.jsx(p,{type:"button",onClick:async()=>h("accepted"),children:s("actionAccept")}),e.jsx(p,{type:"button",onClick:async()=>h("declined"),children:a.receiving_friend_id===r.friend_id?s("actionDecline"):s("actionCancel")})]});case"accepted":return e.jsxs(e.Fragment,{children:[e.jsx(p,{type:"button",onClick:async()=>h("finished"),children:s("actionComplete")}),e.jsx(p,{type:"button",onClick:async()=>h("declined"),children:s("actionCancel")})]});case"declined":return T?null:e.jsx(p,{type:"button",onClick:u,children:s("actionHide")});case"finished":return T?null:e.jsxs(e.Fragment,{children:[e.jsx(p,{type:"button",onClick:async()=>{await b(a),await u()},children:s("actionUpdate")}),e.jsx(p,{type:"button",onClick:u,children:s("actionHide")})]});default:return console.log(`Unknown trade status ${a.status}`),null}},f=o.find(a=>a.id===l);return o.length===0?null:e.jsxs("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-1 sm:p-2",children:[e.jsxs("div",{className:"hidden sm:flex px-1",children:[e.jsx("div",{className:"w-9"}),e.jsx("h4",{className:"text-lg font-medium w-1/2 ml-8",children:s("youGive")}),e.jsx("h4",{className:"text-lg font-medium w-1/2 ml-8",children:s("youReceive")})]}),e.jsx("ul",{className:"flex flex-col gap-2 sm:gap-0",children:o.toSorted((a,h)=>a.created_at>h.created_at?-1:1).map(a=>e.jsx(Pe,{row:a,selectedTradeId:l,setSelectedTradeId:x},a.id))}),f&&e.jsx("div",{className:"flex gap-4 text-center items-center mt-2",children:y(f)})]})}function Oe({friendId:t}){const{t:n}=N("trade-matches"),{data:s}=Q(),{data:i}=Z(t),[r,m]=g.useState(!1);if(!s)return null;const d=s.filter(c=>c.offering_friend_id===t||c.receiving_friend_id===t);return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1 mx-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-md",children:n("tradingWith")}),e.jsxs("span",{className:"text-md font-bold",children:[" ",i?.username||"loading"," "]}),i&&e.jsx(X,{friendId:i.friend_id,showFriendId:!1,className:"ml-1"})]}),e.jsxs("span",{className:"flex gap-4",children:[e.jsxs("label",{htmlFor:`history-${t}`,className:"my-auto flex items-center",children:[n("viewHistory"),e.jsx(q,{id:`history-${t}`,className:"ml-2 my-auto",checked:r,onCheckedChange:m})]}),e.jsx(O,{to:`/trade/${t}`,children:e.jsxs(p,{variant:"outline",className:"my-auto",children:[n("openTradeWith"),e.jsx(L,{})]})})]})]}),i!==null&&e.jsx(Me,{trades:d,viewHistory:r})]})}function Le(){const{t}=N("trade-matches"),{data:n}=S(),{data:s}=Q();if(!s||!n)return null;if(s.length===0)return e.jsx("p",{children:t("noTradeOffers")});const i=ze(s,n.friend_id),r=Object.fromEntries(Object.entries(i).map(([c,o])=>[c,+(Re(o,n.friend_id).length===0)])),m=Object.fromEntries(Object.entries(i).map(([c,o])=>[c,Math.max(...o.map(l=>new Date(l.updated_at).getTime()))])),d=Object.keys(i).toSorted((c,o)=>r[c]!==r[o]?r[c]-r[o]:m[o]-m[c]);return e.jsx("div",{className:"flex flex-col items-center mx-auto gap-6 sm:px-4 mb-12 w-full",children:d.map(c=>e.jsx(Oe,{friendId:c},c))})}function Re(t,n){return t.filter(s=>s.offering_friend_id===n?!s.offerer_ended:!s.receiver_ended)}function ze(t,n){return Object.groupBy(t,s=>s.offering_friend_id===n?s.receiving_friend_id:s.receiving_friend_id===n?s.offering_friend_id:(console.log("Fetched row does not match user friend_id",s),"undefined"))}function Ue(){const{t}=N("trade-matches"),{data:n}=S(),s=me(),i=U({is_active_trading:xe(),trade_rarity_settings:ue(U({rarity:fe(he),to_collect:V().min(0).max(100),to_keep:V().min(0).max(100)}))}),r=Te({resolver:ke(i),values:{is_active_trading:n?.is_active_trading||!1,trade_rarity_settings:n?.trade_rarity_settings||[]}}),m=async d=>{s.mutate({username:n?.username,is_active_trading:d.is_active_trading,trade_rarity_settings:d.trade_rarity_settings},{onSuccess:()=>H({title:t("accountSaved"),variant:"default"}),onError:c=>{console.error("error saving account",c),H({title:t("errorSavingAccount"),variant:"destructive"})}})};return!n||!n.username?e.jsx(Fe,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:t("noAccount")}):e.jsxs("div",{children:[e.jsx(Se,{...r,children:e.jsxs("form",{onSubmit:r.handleSubmit(m),className:"rounded-md border-1 border-neutral-700 space-y-2 p-4 mx-auto max-w-xl",children:[e.jsx("h2",{className:"text-xl text-center mb-6",children:"Trading settings"}),e.jsx(I,{control:r.control,name:"is_active_trading",render:({field:d})=>e.jsx(A,{className:"flex flex-col items-start",children:e.jsx(E,{children:e.jsxs(we,{className:"flex",children:[t("isActiveTrading"),e.jsx(q,{className:"ml-2",checked:d.value,onCheckedChange:d.onChange})]})})})}),e.jsxs("div",{className:"grid grid-cols-3 gap-y-2 gap-x-8 w-fit mt-6",children:[e.jsx("span",{children:t("rarity")}),e.jsxs("span",{className:"flex items-center",children:[t("toCollect"),e.jsx(M,{id:"to-collect"}),e.jsx(D,{className:"size-4 ml-1","data-tooltip-id":"to-collect","data-tooltip-content":t("toCollectTooltip")})]}),e.jsxs("span",{className:"flex items-center",children:[t("toKeep"),e.jsx(M,{id:"to-collect"}),e.jsx(D,{className:"size-4 ml-1","data-tooltip-id":"to-collect","data-tooltip-content":t("toKeepTooltip")})]}),r.watch("trade_rarity_settings").map((d,c)=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1",children:d.rarity},`label-${d.rarity}`),e.jsx(I,{control:r.control,name:`trade_rarity_settings.${c}.to_collect`,render:({field:o})=>e.jsx(A,{className:"flex-1",children:e.jsx(E,{children:e.jsx(B,{className:"w-24",type:"number",...o})})})},`to-collect-${d.rarity}`),e.jsx(I,{control:r.control,name:`trade_rarity_settings.${c}.to_keep`,render:({field:o})=>e.jsx(A,{className:"flex-1",children:e.jsx(E,{children:e.jsx(B,{className:"w-24",type:"number",...o})})})},`to-keep-${d.rarity}`)]}))]}),e.jsxs(p,{type:"submit",className:"block ml-auto mt-4",disabled:s.isPending,children:[t("save"),s.isPending&&e.jsx("div",{className:"ml-2 inline-block animate-spin rounded-full size-4 border-2 border-black border-t-transparent"})]})]})}),e.jsx($e,{className:"mt-4 mx-auto w-fit"})]})}function qe(){const{t}=N("trade-matches"),n=pe(),s=je(),i=n.pathname.split("/").pop()||"offers";return g.useEffect(()=>{n.pathname==="/trade"&&s("/trade/offers")},[n.pathname,s]),e.jsxs(be,{className:"flex flex-col mx-auto max-w-[900px]",value:i,onValueChange:r=>s(`/trade/${r}`),children:[e.jsxs(Ne,{className:"gap-4 mb-6 rounded-lg border-b-1 border-neutral-700 border-solid dark:bg-transparent pb-2",children:[e.jsx(w,{className:"text-md",value:"cards",children:t("tabCards")}),e.jsx(w,{className:"text-md",value:"offers",children:t("tabOffers")}),e.jsx(w,{className:"text-md",value:"matches",children:t("tabMatches")}),e.jsx(w,{className:"text-md",value:"settings",children:t("tabSettings")})]}),e.jsxs(_e,{children:[e.jsx(C,{path:"/",element:e.jsx(ge,{to:"/trade/offers",replace:!0})}),e.jsx(C,{path:"cards",element:e.jsx("p",{children:"You can now manage your trading cards on your collection page."})}),e.jsx(C,{path:"offers",element:e.jsx(Le,{})}),e.jsx(C,{path:"matches",element:e.jsx(Ee,{})}),e.jsx(C,{path:"settings",element:e.jsx(Ue,{})}),e.jsx(C,{path:":friendId",element:e.jsx(Ae,{})})]})]})}export{qe as default};
