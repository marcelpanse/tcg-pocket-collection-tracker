import{_ as ce,Z as le,u as y,j as e,r as o,U as A,C as q,l as ue,v as W,O as ee,Q as me,B as b,V as Z,W as xe,X as fe,N as re,Y as G,z as pe,$ as _e,J as he,K as ge}from"./index-COEZSbC_.js";import{T as ae,a as ne,b as I,c as M,C as B}from"./tabs-eHwEqSsu.js";import{N as K,M as L,C as H}from"./NumberFilter-_f3_YDRV.js";import{R as je}from"./useWindowDimensionsHook-DZJgvK5c.js";import{C as be}from"./CardDetail-O0y1RLDm.js";import{A as R,a as V,b as D}from"./alert-05eVNJnz.js";import{S as U}from"./siren-BVKwsZfF.js";import{u as Ce,a as ve,F as Ne,b as P,c as z,d as Q,e as X,S as se,f as ye,g as we}from"./switch-BpYxwrKP.js";import{i as O}from"./Card-ZpfqZ4tT.js";import"./index-DDOQuXD3.js";function te(r){return ce(le,r)}function ke(){const{t:r}=y("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(R,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(U,{className:"h-4 w-4"}),e.jsx(V,{children:r("noCardsNeeded.title")}),e.jsx(D,{children:r("noCardsNeeded.description")})]})})}function Te(){const{t:r}=y("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(R,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(U,{className:"h-4 w-4"}),e.jsx(V,{children:r("noSellableCards.title")}),e.jsx(D,{children:r("noSellableCards.description")})]})})}function Fe(){const{t:r}=y("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(R,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(U,{className:"h-4 w-4"}),e.jsx(V,{children:r("noTradeableCards.title")}),e.jsx(D,{children:r("noTradeableCards.description")})]})})}function Se(){const{t:r}=y("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(R,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(U,{className:"h-4 w-4"}),e.jsx(V,{children:r("notLoggedIn.title")}),e.jsx(D,{children:r("notLoggedIn.description")})]})})}function $e(){const{t:r}=y("pages/trade"),{user:f,account:i}=o.use(A),{ownedCards:a,selectedCardId:_,setSelectedCardId:m}=o.use(q),[x,l]=o.useState([]),[c,g]=o.useState(0),[u,p]=o.useState(2),[h,T]=o.useState(3),[C,F]=o.useState("looking_for"),t=o.useMemo(()=>ue.filter(n=>n.tradeable).map(n=>n.id),[]),j=n=>x.length===0?!0:n.rarity!==""&&x.includes(n.rarity),w=o.useMemo(()=>W.filter(n=>a.findIndex(s=>s.card_id===n.card_id)===-1||a[a.findIndex(s=>s.card_id===n.card_id)].amount_owned<=c).filter(n=>ee[n.rarity]!==null&&t.includes(n.expansion)),[a,c]),S=o.useMemo(()=>w.filter(j),[w,x]),v=o.useMemo(()=>{const n=a.filter(s=>s.amount_owned>=u);return W.filter(s=>n.findIndex(N=>N.card_id===s.card_id)>-1).map(s=>({...s,amount_owned:n.find(N=>N.card_id===s.card_id)?.amount_owned})).filter(s=>ee[s.rarity]!==null&&t.includes(s.expansion))},[a,u]),J=o.useMemo(()=>v.filter(j),[v,x]),E=o.useMemo(()=>{const n=a.filter(s=>s.amount_owned>=h);return W.filter(s=>n.findIndex(N=>N.card_id===s.card_id)>-1).map(s=>({...s,amount_owned:n.find(N=>N.card_id===s.card_id)?.amount_owned})).filter(s=>me[s.rarity]!==null)},[a,h]),ie=o.useMemo(()=>E.filter(j),[E,x]),de=()=>{let n="";i?.is_public&&(n+=`${r("publicTradePage")} https://tcgpocketcollectiontracker.com/#/collection/${i?.friend_id}/trade
`),i?.username&&(n+=`${r("friendID")} ${i.friend_id} (${i.username})

`),n+=`${r("lookingForCards")}
`;const s=S.sort((d,$)=>{const Y=d.expansion.localeCompare($.expansion);return Y!==0?Y:d.rarity.localeCompare($.rarity)});for(let d=0;d<s.length;d++)(d>0?s[d-1].expansion:"")!==s[d].expansion&&(n+=`
${s[d].set_details}:
`),n+=`${s[d].rarity} ${s[d].card_id} - ${s[d].name}
`;const N=S.map(d=>d.rarity);n+=`

${r("forTradeCards")}
`;const k=J.filter(d=>N.includes(d.rarity)).sort((d,$)=>d.rarity.localeCompare($.rarity));for(let d=0;d<k.length;d++)(d>0?k[d-1].expansion:"")!==k[d].expansion&&(n+=`
${k[d].set_details}:
`),n+=`${k[d].rarity} ${k[d].card_id} - ${k[d].name}
`;return n},oe=async()=>{const n=de();Z({title:r("copiedInClipboard"),variant:"default",duration:3e3}),await navigator.clipboard.writeText(n)};return f?e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsxs(ae,{defaultValue:C,onValueChange:F,children:[e.jsxs("div",{className:"mx-auto max-w-[900px] flex flex-row flex-wrap align-center gap-x-4 gap-y-2",children:[e.jsxs(ne,{className:"flex-grow m-auto flex-wrap h-auto border-1 border-neutral-700 rounded-md",children:[e.jsx(I,{value:"looking_for",children:r("lookingFor")}),e.jsx(I,{value:"for_trade",children:r("forTrade")}),e.jsx(I,{value:"buying_tokens",children:r("buyingTokens")})]}),e.jsx(je,{rarityFilter:x,setRarityFilter:l}),e.jsxs("div",{className:"sm:mt-1 flex flex-row flex-wrap align-center gap-x-4 gap-y-1",children:[C==="looking_for"&&e.jsx(K,{numberFilter:c,setNumberFilter:g,options:[0,1,2,3,4,5],labelKey:"maxNum"}),C==="for_trade"&&e.jsx(K,{numberFilter:u,setNumberFilter:p,options:[2,3,4,5],labelKey:"minNum"}),C==="buying_tokens"&&e.jsx(K,{numberFilter:h,setNumberFilter:T,options:[2,3,4,5],labelKey:"minNum"}),e.jsx(b,{variant:"outline",onClick:oe,children:"Copy to clipboard"})]})]}),e.jsxs("div",{className:"mx-auto max-w-[900px] mt-6",children:[e.jsx(M,{value:"looking_for",children:w&&w.length>0?e.jsx(B,{cards:S,extraOffset:105}):e.jsx(ke,{})}),e.jsx(M,{value:"for_trade",children:v&&v.length>0?e.jsx(B,{cards:J,extraOffset:105}):e.jsx(Fe,{})}),e.jsx(M,{value:"buying_tokens",children:E&&E.length>0?e.jsx(B,{cards:ie,extraOffset:105}):e.jsx(Te,{})})]})]}),_&&e.jsx(be,{cardId:_,onClose:()=>m("")})]}):e.jsx(Se,{})}function Ie(){const{t:r}=y("trade-matches"),{user:f,account:i,setAccount:a}=o.useContext(A),_=xe({is_active_trading:fe(),min_number_of_cards_to_keep:te().min(1).max(10),max_number_of_cards_wanted:te().min(1).max(10)}),m=Ce({resolver:ve(_),values:{is_active_trading:i?.is_active_trading||!1,min_number_of_cards_to_keep:i?.min_number_of_cards_to_keep||1,max_number_of_cards_wanted:i?.max_number_of_cards_wanted||1}}),x=async l=>{try{const c=await G.from("accounts").upsert({email:f?.user.email,username:i?.username,is_active_trading:l.is_active_trading,min_number_of_cards_to_keep:l.min_number_of_cards_to_keep,max_number_of_cards_wanted:l.max_number_of_cards_wanted}).select().single();if(!c.data)throw console.error("Could not save account",i),new Error("Could not save account");a(c.data),Z({title:r("accountSaved"),variant:"default"})}catch(c){console.error("error saving account",c),Z({title:r("errorSavingAccount"),variant:"destructive"})}};return e.jsxs("div",{children:[e.jsx(Ne,{...m,children:e.jsxs("form",{onSubmit:m.handleSubmit(x),className:"border-1 border-neutral-700 space-y-2 p-4 mx-auto",children:[e.jsx(P,{control:m.control,name:"is_active_trading",render:({field:l})=>e.jsx(z,{className:"flex flex-col items-start",children:e.jsx(Q,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(X,{className:"flex sm:w-72",children:r("isActiveTrading")}),e.jsx("div",{className:"grow-1",children:e.jsx(se,{checked:l.value,onCheckedChange:l.onChange})}),e.jsx(ye,{className:"grow",children:l.value?"active":"disabled"}),e.jsx(L,{id:"activeInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(H,{className:"h-4 w-4","data-tooltip-id":"activeInput","data-tooltip-content":r("activeTradingInputTooltip")})]})})})}),e.jsx(P,{control:m.control,name:"min_number_of_cards_to_keep",render:({field:l})=>e.jsx(z,{className:"flex flex-col items-start",children:e.jsx(Q,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(X,{className:"flex sm:w-72",children:r("minNumberOfCardsToKeep")}),e.jsx("div",{className:"grow-1",children:e.jsx(re,{className:"w-24",type:"number",...l})}),e.jsx(L,{id:"minInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(H,{className:"h-4 w-4","data-tooltip-id":"minInput","data-tooltip-content":r("minInputTooltip")})]})})})}),e.jsx(P,{control:m.control,name:"max_number_of_cards_wanted",render:({field:l})=>e.jsx(z,{className:"flex flex-col items-start",children:e.jsx(Q,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(X,{className:"flex sm:w-72",children:r("maxNumberOfCardsWanted")}),e.jsx("div",{className:"grow-1",children:e.jsx(re,{className:"w-24",type:"number",...l})}),e.jsx(L,{id:"maxInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(H,{className:"h-4 w-4","data-tooltip-id":"maxInput","data-tooltip-content":r("maxInputTooltip")})]})})})}),e.jsx("div",{className:"w-full flex justify-end mt-8",children:e.jsx(b,{type:"submit",children:r("save")})})]})}),e.jsx(we,{className:"mt-4"})]})}const Me=({row:r,selectedTradeId:f,setSelectedTradeId:i})=>{const{account:a}=o.useContext(A),{ownedCards:_}=o.useContext(q);if(!a)return null;const m=r.offering_friend_id===a.friend_id?r.offer_card_id:r.receiver_card_id,x=r.offering_friend_id===a.friend_id?r.receiver_card_id:r.offer_card_id;function l(u){const p=pe(u);return p?e.jsxs("span",{className:"flex rounded px-1 w-1/2 bg-zinc-800",children:[e.jsxs("span",{className:"min-w-10",children:[p.rarity," "]}),e.jsxs("span",{className:"min-w-14 me-4",children:[p.card_id," "]}),e.jsx("span",{children:p.name}),e.jsxs("span",{className:"text-neutral-400 ml-auto",children:["×",_.find(h=>h.card_id===p.card_id)?.amount_owned||0]})]}):e.jsx("span",{className:"w-1/2 text-center",children:"?"})}function c(u){f===u.id?i(void 0):i(u.id)}const g=u=>{const p={offered:{icon:u.offering_friend_id===a.friend_id?"→":"←",color:"bg-amber-600"},accepted:{icon:"↔",color:"bg-lime-600"},declined:{icon:"X",color:"bg-stone-600"},finished:{icon:"✓",color:"bg-indigo-600"}};return e.jsxs(e.Fragment,{children:[e.jsx(L,{id:`tooltip-${u.id}`}),e.jsx("span",{className:`rounded-full text-center w-9 ${p[u.status].color}`,"data-tooltip-id":`tooltip-${u.id}`,"data-tooltip-content":u.status,children:p[u.status].icon})]})};return e.jsxs("li",{className:`flex cursor-pointer justify-between rounded gap-4 p-1 my-1 ${f===r.id&&"bg-green-900"} hover:bg-neutral-500`,onClick:()=>c(r),children:[g(r),l(m),l(x)]})};function Ae({trades:r,update:f,viewHistory:i}){const{t:a}=y("trade-matches"),{toast:_}=_e();function m(t){return t.offering_friend_id===c?.friend_id&&!t.offerer_ended||t.receiving_friend_id===c?.friend_id&&!t.receiver_ended}const{ownedCards:x,setOwnedCards:l}=o.useContext(q),{account:c,user:g}=o.useContext(A),u=i?r.filter(t=>!m(t)):r.filter(m),[p,h]=o.useState(void 0);if(!c||!g)return null;const T=async t=>{t.offering_friend_id===c.friend_id?(await O([t.offer_card_id],-1,x,l,g),await O([t.receiver_card_id],1,x,l,g),_({title:a("collectionUpdated"),variant:"default"})):t.receiving_friend_id===c.friend_id?(await O([t.offer_card_id],1,x,l,g),await O([t.receiver_card_id],-1,x,l,g),_({title:a("collectionUpdated"),variant:"default"})):console.log(t,"can't match friend id")},C=t=>{const j=async v=>{await f(t.id,{status:v}),h(t.id)},w=async()=>{const v=t.offering_friend_id===c.friend_id?{offerer_ended:!0}:t.receiving_friend_id===c.friend_id?{receiver_ended:!0}:null;if(v===null){console.log(t," doesn't match your friend_id");return}await f(t.id,v),h(void 0)},S=t.offering_friend_id===c.friend_id&&t.offerer_ended||t.receiving_friend_id===c.friend_id&&t.receiver_ended;switch(t.status){case"offered":return e.jsxs(e.Fragment,{children:[t.receiving_friend_id===c.friend_id&&e.jsx(b,{type:"button",onClick:async()=>j("accepted"),children:a("actionAccept")}),e.jsx(b,{type:"button",onClick:async()=>j("declined"),children:t.receiving_friend_id===c.friend_id?a("actionDecline"):a("actionCancel")})]});case"accepted":return e.jsxs(e.Fragment,{children:[e.jsx(b,{type:"button",onClick:async()=>j("finished"),children:a("actionComplete")}),e.jsx(b,{type:"button",onClick:async()=>j("declined"),children:a("actionCancel")})]});case"declined":return S?null:e.jsx(b,{type:"button",onClick:w,children:a("actionHide")});case"finished":return S?null:e.jsxs(e.Fragment,{children:[e.jsx(b,{type:"button",onClick:async()=>{await T(t),await w()},children:a("actionUpdate")}),e.jsx(b,{type:"button",onClick:w,children:a("actionHide")})]});default:return console.log(`Unknown trade status ${t.status}`),null}},F=u.find(t=>t.id===p);return u.length===0?e.jsx("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2 text-center",children:a("noActiveTrades")}):e.jsxs("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2",children:[e.jsxs("div",{className:"flex gap-4 px-1",children:[e.jsx("div",{className:"w-9"}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:a("youGive")}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:a("youReceive")})]}),e.jsx("ul",{children:u.toSorted((t,j)=>t.created_at>j.created_at?-1:1).map(t=>e.jsx(Me,{row:t,selectedTradeId:p,setSelectedTradeId:h},t.id))}),F&&e.jsx("div",{className:"flex gap-4 text-center items-center mt-2",children:C(F)})]})}function Ee(r,f){return Object.groupBy(r,i=>i.offering_friend_id===f?i.receiving_friend_id:i.receiving_friend_id===f?i.offering_friend_id:"undefined")}function Oe({friendId:r,initialTrades:f}){const{t:i}=y("trade-matches"),[a,_]=o.useState(null),m=he(),[x,l]=o.useState(f),[c,g]=o.useState(!1);async function u(p,h){const T=new Date,{error:C}=await G.from("trades").update({updated_at:T,...h}).eq("id",p);if(C){console.log("Error updating trades: ",C);return}console.log("successfully updated trade"),l(F=>F.map(t=>t.id===p?{...t,updated_at:T,...h}:t))}return o.useEffect(()=>{a||ge(r).then(_)}),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 mx-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-sm",children:i("tradingWith")}),e.jsxs("span",{className:"text-xl font-medium",children:[" ",a?.username||"loading"," "]}),e.jsxs("span",{className:"text-xs",children:["(",r,")"]})]}),e.jsxs("span",{className:"flex gap-4",children:[e.jsxs("label",{htmlFor:`history-${r}`,className:"my-auto flex items-center",children:["View history",e.jsx(se,{id:`history-${r}`,className:"ml-2 my-auto",checked:c,onCheckedChange:g})]}),e.jsx(b,{className:"my-auto",onClick:()=>m(`/trade/${r}`),children:i("openTradeWith")})]})]}),a!==null&&e.jsx(Ae,{trades:x,update:u,viewHistory:c})]})}function Le(){const{t:r}=y("trade-matches"),{account:f}=o.useContext(A),[i,a]=o.useState(null);if(o.useEffect(()=>{f&&i===null&&(console.log("Refrehing trades"),G.from("trades").select().then(({data:m,error:x})=>{x?console.log("Error fetching trades: ",x):a(m)}))}),i===null||!f)return null;if(i.length===0)return e.jsx("p",{children:r("noTradeOffers")});const _=Ee(i,f.friend_id);return e.jsx("div",{className:"flex flex-col items-center mx-auto gap-12",children:Object.keys(_).map(m=>e.jsx(Oe,{friendId:m,initialTrades:_[m],account:f},m))})}function Qe(){return e.jsxs(ae,{className:"flex flex-col mx-auto max-w-[900px]",defaultValue:"offers",children:[e.jsxs(ne,{className:"gap-4 mb-6 rounded-lg border-b-1 border-neutral-700 border-solid dark:bg-transparent pb-2",children:[e.jsx(I,{className:"text-md",value:"cards",children:"Cards"}),e.jsx(I,{className:"text-md",value:"offers",children:"Offers"}),e.jsx(I,{className:"text-md",value:"settings",children:"Settings"})]}),e.jsx(M,{value:"cards",children:e.jsx($e,{})}),e.jsx(M,{value:"offers",children:e.jsx(Le,{})}),e.jsx(M,{value:"settings",children:e.jsx(Ie,{})})]})}export{Qe as default};
