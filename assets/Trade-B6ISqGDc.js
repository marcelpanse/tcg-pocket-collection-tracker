import{_ as ne,Z as se,u as v,j as e,r as c,U as E,C as B,s as ie,E as z,X as G,B as b,Y as W,$ as de,a0 as ce,W as J,a1 as H,J as oe,t as le,a2 as ue,V as me,a3 as fe}from"./index-eSFM90zN.js";import{T as te,a as ae,b as I,c as A,C as Q}from"./tabs-CQR7Wokw.js";import{N as Y,M as L,C as O}from"./NumberFilter-BKCpvrhv.js";import{R as xe}from"./useWindowDimensionsHook-X--cl-D-.js";import{C as pe}from"./CardDetail--yIe1yXQ.js";import{A as K,a as P,b as X}from"./alert-D9ddlDC4.js";import{S as Z}from"./siren-3HdNyJ8m.js";import{u as _e,a as he,F as ge,b as R,c as V,d as D,e as U,S as re,f as je,g as be}from"./switch-Ja6w4y0K.js";import"./index-DiLIGsqc.js";function ee(t){return ne(se,t)}function ve(){const{t}=v("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(K,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(Z,{className:"h-4 w-4"}),e.jsx(P,{children:t("noCardsNeeded.title")}),e.jsx(X,{children:t("noCardsNeeded.description")})]})})}function Ce(){const{t}=v("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(K,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(Z,{className:"h-4 w-4"}),e.jsx(P,{children:t("noTradeableCards.title")}),e.jsx(X,{children:t("noTradeableCards.description")})]})})}function Ne(){const{t}=v("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(K,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(Z,{className:"h-4 w-4"}),e.jsx(P,{children:t("notLoggedIn.title")}),e.jsx(X,{children:t("notLoggedIn.description")})]})})}function ye(){const{t}=v("pages/trade"),{user:f,account:r}=c.use(E),{ownedCards:n,selectedCardId:_,setSelectedCardId:o}=c.use(B),[p,m]=c.useState([]),[d,y]=c.useState(0),[g,C]=c.useState(2),[l,x]=c.useState("looking_for"),N=c.useMemo(()=>ie.filter(i=>i.tradeable).map(i=>i.id),[]),k=i=>p.length===0?!0:i.rarity!==""&&p.includes(i.rarity),j=c.useMemo(()=>z.filter(i=>n.findIndex(u=>u.card_id===i.card_id)===-1||n[n.findIndex(u=>u.card_id===i.card_id)].amount_owned<=d).filter(i=>G[i.rarity]!==null&&N.includes(i.expansion)),[n,d]),a=c.useMemo(()=>j.filter(k),[j,p]),h=c.useMemo(()=>{const i=n.filter(u=>u.amount_owned>=g);return z.filter(u=>i.findIndex($=>$.card_id===u.card_id)>-1).map(u=>({...u,amount_owned:i.find($=>$.card_id===u.card_id)?.amount_owned})).filter(u=>G[u.rarity]!==null&&N.includes(u.expansion))},[n,g]),w=c.useMemo(()=>h.filter(k),[h,p]),M=()=>{let i="";r?.is_public&&(i+=`${t("publicTradePage")} https://tcgpocketcollectiontracker.com/#/collection/${r?.friend_id}/trade
`),r?.username&&(i+=`${t("friendID")} ${r.friend_id} (${r.username})

`),i+=`${t("lookingForCards")}
`;const u=a.sort((s,S)=>{const q=s.expansion.localeCompare(S.expansion);return q!==0?q:s.rarity.localeCompare(S.rarity)});for(let s=0;s<u.length;s++)(s>0?u[s-1].expansion:"")!==u[s].expansion&&(i+=`
${u[s].set_details}:
`),i+=`${u[s].rarity} ${u[s].card_id} - ${u[s].name}
`;const $=a.map(s=>s.rarity);i+=`

${t("forTradeCards")}
`;const T=w.filter(s=>$.includes(s.rarity)).sort((s,S)=>s.rarity.localeCompare(S.rarity));for(let s=0;s<T.length;s++)(s>0?T[s-1].expansion:"")!==T[s].expansion&&(i+=`
${T[s].set_details}:
`),i+=`${T[s].rarity} ${T[s].card_id} - ${T[s].name}
`;return i},F=async()=>{const i=M();W({title:t("copiedInClipboard"),variant:"default",duration:3e3}),await navigator.clipboard.writeText(i)};return f?e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsxs(te,{defaultValue:l,onValueChange:x,children:[e.jsxs("div",{className:"mx-auto max-w-[900px] flex flex-row flex-wrap align-center gap-x-4 gap-y-2",children:[e.jsxs(ae,{className:"flex-grow m-auto flex-wrap h-auto border-1 border-neutral-700 rounded-md",children:[e.jsx(I,{value:"looking_for",children:t("lookingFor")}),e.jsx(I,{value:"for_trade",children:t("forTrade")})]}),e.jsx(xe,{rarityFilter:p,setRarityFilter:m}),e.jsxs("div",{className:"sm:mt-1 flex flex-row flex-wrap align-center gap-x-4 gap-y-1",children:[l==="looking_for"&&e.jsx(Y,{numberFilter:d,setNumberFilter:y,options:[0,1,2,3,4,5],labelKey:"maxNum"}),l==="for_trade"&&e.jsx(Y,{numberFilter:g,setNumberFilter:C,options:[2,3,4,5],labelKey:"minNum"}),e.jsx(b,{variant:"outline",onClick:F,children:"Copy to clipboard"})]})]}),e.jsxs("div",{className:"mx-auto max-w-[900px] mt-6",children:[e.jsx(A,{value:"looking_for",children:j&&j.length>0?e.jsx(Q,{cards:a,extraOffset:105}):e.jsx(ve,{})}),e.jsx(A,{value:"for_trade",children:h&&h.length>0?e.jsx(Q,{cards:w,extraOffset:105}):e.jsx(Ce,{})})]})]}),_&&e.jsx(pe,{cardId:_,onClose:()=>o("")})]}):e.jsx(Ne,{})}function we(){const{t}=v("trade-matches"),{user:f,account:r,setAccount:n}=c.useContext(E),_=de({is_active_trading:ce(),min_number_of_cards_to_keep:ee().min(1).max(10),max_number_of_cards_wanted:ee().min(1).max(10)}),o=_e({resolver:he(_),values:{is_active_trading:r?.is_active_trading||!1,min_number_of_cards_to_keep:r?.min_number_of_cards_to_keep||1,max_number_of_cards_wanted:r?.max_number_of_cards_wanted||1}}),p=async m=>{try{const d=await H.from("accounts").upsert({email:f?.user.email,username:r?.username,is_active_trading:m.is_active_trading,min_number_of_cards_to_keep:m.min_number_of_cards_to_keep,max_number_of_cards_wanted:m.max_number_of_cards_wanted}).select().single();if(!d.data)throw console.error("Could not save account",r),new Error("Could not save account");n(d.data),W({title:t("accountSaved"),variant:"default"})}catch(d){console.error("error saving account",d),W({title:t("errorSavingAccount"),variant:"destructive"})}};return e.jsxs("div",{children:[e.jsx(ge,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(p),className:"border-1 border-neutral-700 space-y-2 p-4 mx-auto",children:[e.jsx(R,{control:o.control,name:"is_active_trading",render:({field:m})=>e.jsx(V,{className:"flex flex-col items-start",children:e.jsx(D,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(U,{className:"flex sm:w-72",children:t("isActiveTrading")}),e.jsx("div",{className:"grow-1",children:e.jsx(re,{checked:m.value,onCheckedChange:m.onChange})}),e.jsx(je,{className:"grow",children:m.value?"active":"disabled"}),e.jsx(L,{id:"activeInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(O,{className:"h-4 w-4","data-tooltip-id":"activeInput","data-tooltip-content":t("activeTradingInputTooltip")})]})})})}),e.jsx(R,{control:o.control,name:"min_number_of_cards_to_keep",render:({field:m})=>e.jsx(V,{className:"flex flex-col items-start",children:e.jsx(D,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(U,{className:"flex sm:w-72",children:t("minNumberOfCardsToKeep")}),e.jsx("div",{className:"grow-1",children:e.jsx(J,{className:"w-24",type:"number",...m})}),e.jsx(L,{id:"minInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(O,{className:"h-4 w-4","data-tooltip-id":"minInput","data-tooltip-content":t("minInputTooltip")})]})})})}),e.jsx(R,{control:o.control,name:"max_number_of_cards_wanted",render:({field:m})=>e.jsx(V,{className:"flex flex-col items-start",children:e.jsx(D,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(U,{className:"flex sm:w-72",children:t("maxNumberOfCardsWanted")}),e.jsx("div",{className:"grow-1",children:e.jsx(J,{className:"w-24",type:"number",...m})}),e.jsx(L,{id:"maxInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(O,{className:"h-4 w-4","data-tooltip-id":"maxInput","data-tooltip-content":t("maxInputTooltip")})]})})})}),e.jsx("div",{className:"w-full flex justify-end mt-8",children:e.jsx(b,{type:"submit",children:t("save")})})]})}),e.jsx(be,{className:"mt-4"})]})}const Te=({row:t,selectedTradeId:f,setSelectedTradeId:r})=>{const{t:n,i18n:_}=v("trade-matches"),{account:o}=c.useContext(E),{ownedCards:p}=c.useContext(B);if(!o)return null;const m=t.offering_friend_id===o.friend_id?t.offer_card_id:t.receiver_card_id,d=t.offering_friend_id===o.friend_id?t.receiver_card_id:t.offer_card_id;function y(l){const x=oe(l);return x?e.jsxs("span",{className:"flex rounded px-1 w-1/2 bg-zinc-800",children:[e.jsxs("span",{className:"mr-2 sm:min-w-10",children:[x.rarity," "]}),e.jsxs("span",{className:"mr-2 sm:min-w-14 me-4",children:[x.card_id," "]}),e.jsx("span",{children:le(x,_.language)}),e.jsxs("span",{className:"text-neutral-400 ml-auto",children:["×",p.find(N=>N.card_id===x.card_id)?.amount_owned||0]})]}):e.jsx("span",{className:"w-1/2 text-center",children:"?"})}function g(l){f===l.id?r(void 0):r(l.id)}const C=l=>{const x={offered:{icon:l.offering_friend_id===o.friend_id?"→":"←",color:"bg-amber-600"},accepted:{icon:"↔",color:"bg-lime-600"},declined:{icon:"X",color:"bg-stone-600"},finished:{icon:"✓",color:"bg-indigo-600"}};return e.jsxs(e.Fragment,{children:[e.jsx(L,{id:`tooltip-${l.id}`}),e.jsx("span",{className:`rounded-full text-center w-9 min-w-6 ${x[l.status].color}`,"data-tooltip-id":`tooltip-${l.id}`,"data-tooltip-content":n(`status.${l.status}`),children:x[l.status].icon})]})};return e.jsxs("li",{className:`flex cursor-pointer justify-between rounded gap-1 sm:gap-4 sm:px-1 py-1 my-1 ${f===t.id&&"bg-green-900"} hover:bg-neutral-500`,onClick:()=>g(t),children:[C(t),y(m),y(d)]})};function ke({trades:t,update:f,viewHistory:r}){const{t:n}=v("trade-matches"),{toast:_}=ue();function o(a){return a.offering_friend_id===d?.friend_id&&!a.offerer_ended||a.receiving_friend_id===d?.friend_id&&!a.receiver_ended}const{ownedCards:p,updateCards:m}=c.useContext(B),{account:d,user:y}=c.useContext(E),g=r?t.filter(a=>!o(a)):t.filter(o),[C,l]=c.useState(void 0);if(!d||!y)return null;const x=(a,h)=>({card_id:a,amount_owned:(p.find(w=>w.card_id===a)?.amount_owned??0)+h}),N=async a=>{a.offer_card_id!==a.receiver_card_id&&(a.offering_friend_id===d.friend_id?(await m([x(a.offer_card_id,-1),x(a.receiver_card_id,1)]),_({title:n("collectionUpdated"),variant:"default"})):a.receiving_friend_id===d.friend_id?(await m([x(a.offer_card_id,1),x(a.receiver_card_id,-1)]),_({title:n("collectionUpdated"),variant:"default"})):console.log(a,"can't match friend id"))},k=a=>{const h=async F=>{await f(a.id,{status:F}),l(a.id)},w=async()=>{const F=a.offering_friend_id===d.friend_id?{offerer_ended:!0}:a.receiving_friend_id===d.friend_id?{receiver_ended:!0}:null;if(F===null){console.log(a," doesn't match your friend_id");return}await f(a.id,F),l(void 0)},M=a.offering_friend_id===d.friend_id&&a.offerer_ended||a.receiving_friend_id===d.friend_id&&a.receiver_ended;switch(a.status){case"offered":return e.jsxs(e.Fragment,{children:[a.receiving_friend_id===d.friend_id&&e.jsx(b,{type:"button",onClick:async()=>h("accepted"),children:n("actionAccept")}),e.jsx(b,{type:"button",onClick:async()=>h("declined"),children:a.receiving_friend_id===d.friend_id?n("actionDecline"):n("actionCancel")})]});case"accepted":return e.jsxs(e.Fragment,{children:[e.jsx(b,{type:"button",onClick:async()=>h("finished"),children:n("actionComplete")}),e.jsx(b,{type:"button",onClick:async()=>h("declined"),children:n("actionCancel")})]});case"declined":return M?null:e.jsx(b,{type:"button",onClick:w,children:n("actionHide")});case"finished":return M?null:e.jsxs(e.Fragment,{children:[e.jsx(b,{type:"button",onClick:async()=>{await N(a),await w()},children:n("actionUpdate")}),e.jsx(b,{type:"button",onClick:w,children:n("actionHide")})]});default:return console.log(`Unknown trade status ${a.status}`),null}},j=g.find(a=>a.id===C);return g.length===0?e.jsx("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2 text-center",children:n("noActiveTrades")}):e.jsxs("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2",children:[e.jsxs("div",{className:"flex gap-4 px-1",children:[e.jsx("div",{className:"w-9"}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:n("youGive")}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:n("youReceive")})]}),e.jsx("ul",{children:g.toSorted((a,h)=>a.created_at>h.created_at?-1:1).map(a=>e.jsx(Te,{row:a,selectedTradeId:C,setSelectedTradeId:l},a.id))}),j&&e.jsx("div",{className:"flex gap-4 text-center items-center mt-2",children:k(j)})]})}function Fe(t,f){return Object.groupBy(t,r=>r.offering_friend_id===f?r.receiving_friend_id:r.receiving_friend_id===f?r.offering_friend_id:"undefined")}function Se({friendId:t,initialTrades:f}){const{t:r}=v("trade-matches"),[n,_]=c.useState(null),o=me(),[p,m]=c.useState(f),[d,y]=c.useState(!1);async function g(C,l){const x=new Date,{error:N}=await H.from("trades").update({updated_at:x,...l}).eq("id",C);if(N){console.log("Error updating trades: ",N);return}console.log("successfully updated trade"),m(k=>k.map(j=>j.id===C?{...j,updated_at:x,...l}:j))}return c.useEffect(()=>{n||fe(t).then(_)}),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 mx-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-sm",children:r("tradingWith")}),e.jsxs("span",{className:"text-xl font-medium",children:[" ",n?.username||"loading"," "]}),e.jsxs("span",{className:"text-xs",children:["(",t,")"]})]}),e.jsxs("span",{className:"flex gap-4",children:[e.jsxs("label",{htmlFor:`history-${t}`,className:"my-auto flex items-center",children:[r("viewHistory"),e.jsx(re,{id:`history-${t}`,className:"ml-2 my-auto",checked:d,onCheckedChange:y})]}),e.jsx(b,{className:"my-auto",onClick:()=>o(`/trade/${t}`),children:r("openTradeWith")})]})]}),n!==null&&e.jsx(ke,{trades:p,update:g,viewHistory:d})]})}function $e(){const{t}=v("trade-matches"),{account:f}=c.useContext(E),[r,n]=c.useState(null);if(c.useEffect(()=>{f&&r===null&&(console.log("Refrehing trades"),H.from("trades").select().then(({data:o,error:p})=>{p?console.log("Error fetching trades: ",p):n(o)}))}),r===null||!f)return null;if(r.length===0)return e.jsx("p",{children:t("noTradeOffers")});const _=Fe(r,f.friend_id);return e.jsx("div",{className:"flex flex-col items-center mx-auto gap-12 sm:px-4",children:Object.keys(_).map(o=>e.jsx(Se,{friendId:o,initialTrades:_[o],account:f},o))})}function Ue(){const{t}=v("trade-matches");return e.jsxs(te,{className:"flex flex-col mx-auto max-w-[900px]",defaultValue:"offers",children:[e.jsxs(ae,{className:"gap-4 mb-6 rounded-lg border-b-1 border-neutral-700 border-solid dark:bg-transparent pb-2",children:[e.jsx(I,{className:"text-md",value:"cards",children:t("tabCards")}),e.jsx(I,{className:"text-md",value:"offers",children:t("tabOffers")}),e.jsx(I,{className:"text-md",value:"settings",children:t("tabSettings")})]}),e.jsx(A,{value:"cards",children:e.jsx(ye,{})}),e.jsx(A,{value:"offers",children:e.jsx($e,{})}),e.jsx(A,{value:"settings",children:e.jsx(we,{})})]})}export{Ue as default};
