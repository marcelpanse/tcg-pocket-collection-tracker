import{$ as te,a0 as re,u as v,j as e,a1 as ne,a2 as I,n as B,r as j,H as z,t as se,B as b,a3 as W,N as ie,v as de,a4 as ce,x as oe,W as le,a5 as q,Y as ue,a6 as me,a7 as fe,a8 as xe,a9 as _e,_ as G}from"./index-BxFWimv5.js";import{T as J,a as ee,b as S,c as $,C as Q}from"./tabs-BMzNVKVr.js";import{N as X,M as A,C as L}from"./NumberFilter-CWqw5e0b.js";import{t as O,R as pe}from"./useWindowDimensionsHook-BT0PEHWi.js";import{A as M,a as H,b as D}from"./alert-C6bN0Wmh.js";import{S as K}from"./siren-Aha9Eca6.js";import{S as ae,u as he,a as ge,F as je,b as U,c as E,d as R,e as V,f as be,g as ve}from"./form-BOUJ42WH.js";import"./Card-CcSJLE8H.js";import"./FancyCard-C_pfmyas.js";import"./index-BNZWzldq.js";function Y(a){return te(re,a)}function Ne(){const{t:a}=v("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(M,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx(H,{children:a("noCardsNeeded.title")}),e.jsx(D,{children:a("noCardsNeeded.description")})]})})}function ye(){const{t:a}=v("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(M,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx(H,{children:a("noTradeableCards.title")}),e.jsx(D,{children:a("noTradeableCards.description")})]})})}function Ce(){const{t:a}=v("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(M,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx(H,{children:a("notLoggedIn.title")}),e.jsx(D,{children:a("notLoggedIn.description")})]})})}const Z=se.filter(a=>a.tradeable).map(a=>a.id);function Te(){const{t:a}=v("pages/trade"),{data:l}=ne(),{data:s}=I(),{data:r=[]}=B(),[u,o]=j.useState([]),[n,x]=j.useState((s?.max_number_of_cards_wanted??1)-1),[h,p]=j.useState((s?.min_number_of_cards_to_keep??1)+1),[g,N]=j.useState("looking_for"),m=d=>u.length===0?!0:d.rarity!==""&&u.includes(d.rarity),f=j.useMemo(()=>z.filter(d=>O.includes(d.rarity)&&Z.includes(d.expansion)).filter(d=>{const c=r.findIndex(k=>k.card_id===d.card_id);return c===-1||r[c].amount_owned<=n}),[r,n]),y=j.useMemo(()=>f.filter(m),[f,u]),C=j.useMemo(()=>{const d=r.filter(c=>c.amount_owned>=h);return z.filter(c=>O.includes(c.rarity)&&Z.includes(c.expansion)).filter(c=>d.findIndex(k=>k.card_id===c.card_id)>-1).map(c=>({...c,amount_owned:d.find(k=>k.card_id===c.card_id)?.amount_owned}))},[r,h]),t=j.useMemo(()=>C.filter(m),[C,u]),_=()=>{let d="";s?.is_public&&(d+=`${a("publicTradePage")} https://tcgpocketcollectiontracker.com/#/collection/${s?.friend_id}/trade
`),s?.username&&(d+=`${a("friendID")} ${s.friend_id} (${s.username})

`),d+=`${a("lookingForCards")}
`;const c=y.sort((i,F)=>{const P=i.expansion.localeCompare(F.expansion);return P!==0?P:i.rarity.localeCompare(F.rarity)});for(let i=0;i<c.length;i++)(i>0?c[i-1].expansion:"")!==c[i].expansion&&(d+=`
${c[i].set_details}:
`),d+=`${c[i].rarity} ${c[i].card_id} - ${c[i].name}
`;const k=y.map(i=>i.rarity);d+=`

${a("forTradeCards")}
`;const w=t.filter(i=>k.includes(i.rarity)).sort((i,F)=>i.rarity.localeCompare(F.rarity));for(let i=0;i<w.length;i++)(i>0?w[i-1].expansion:"")!==w[i].expansion&&(d+=`
${w[i].set_details}:
`),d+=`${w[i].rarity} ${w[i].card_id} - ${w[i].name}
`;return d},T=async()=>{const d=_();W({title:a("copiedInClipboard"),variant:"default",duration:3e3}),await navigator.clipboard.writeText(d)};return l?e.jsx("div",{className:"flex flex-col gap-y-4",children:e.jsxs(J,{defaultValue:g,onValueChange:N,children:[e.jsxs("div",{className:"mx-auto max-w-[900px] flex flex-row flex-wrap align-center gap-x-4 gap-y-2",children:[e.jsxs(ee,{className:"flex-grow m-auto flex-wrap h-auto border-1 border-neutral-700 rounded-md",children:[e.jsx(S,{value:"looking_for",children:a("lookingFor")}),e.jsx(S,{value:"for_trade",children:a("forTrade")})]}),e.jsx(pe,{rarityFilter:u,setRarityFilter:o,rarities:O}),e.jsxs("div",{className:"sm:mt-1 flex flex-row flex-wrap align-center gap-x-4 gap-y-1",children:[g==="looking_for"&&e.jsx(X,{numberFilter:n,setNumberFilter:x,options:[0,1,2,3,4,5],labelKey:"maxNum"}),g==="for_trade"&&e.jsx(X,{numberFilter:h,setNumberFilter:p,options:[2,3,4,5],labelKey:"minNum"}),e.jsx(b,{variant:"outline",onClick:T,children:"Copy to clipboard"})]})]}),e.jsxs("div",{className:"mx-auto max-w-[900px] mt-6",children:[e.jsx($,{value:"looking_for",children:f&&f.length>0?e.jsx(Q,{cards:y,extraOffset:105,editable:!1}):e.jsx(Ne,{})}),e.jsx($,{value:"for_trade",children:C&&C.length>0?e.jsx(Q,{cards:t,extraOffset:105,editable:!1}):e.jsx(ye,{})})]})]})}):e.jsx(Ce,{})}const ke=({row:a,selectedTradeId:l,setSelectedTradeId:s})=>{const{t:r,i18n:u}=v("trade-matches"),{data:o}=I(),{data:n=[]}=B();if(!o)return null;const x=a.offering_friend_id===o.friend_id?a.offer_card_id:a.receiver_card_id,h=a.offering_friend_id===o.friend_id?a.receiver_card_id:a.offer_card_id;function p(m){const f=ie(m);return f?e.jsxs("span",{className:"flex rounded px-1 w-1/2 bg-zinc-800",children:[e.jsxs("span",{className:"mr-2 sm:min-w-10",children:[f.rarity," "]}),e.jsxs("span",{className:"mr-2 sm:min-w-14 me-4",children:[f.card_id," "]}),e.jsx("span",{children:de(f,u.language)}),e.jsxs("span",{className:"text-neutral-400 ml-auto",children:["×",n.find(y=>y.card_id===f.card_id)?.amount_owned||0]})]}):e.jsx("span",{className:"w-1/2 text-center",children:"?"})}function g(m){l===m.id?s(void 0):s(m.id)}const N=m=>{const f={offered:{icon:m.offering_friend_id===o.friend_id?"→":"←",color:"bg-amber-600"},accepted:{icon:"↔",color:"bg-lime-600"},declined:{icon:"X",color:"bg-stone-600"},finished:{icon:"✓",color:"bg-indigo-600"}};return e.jsxs(e.Fragment,{children:[e.jsx(A,{id:`tooltip-${m.id}`}),e.jsx("span",{className:`rounded-full text-center w-9 min-w-6 ${f[m.status].color}`,"data-tooltip-id":`tooltip-${m.id}`,"data-tooltip-content":r(`status.${m.status}`),children:f[m.status].icon})]})};return e.jsxs("li",{className:`flex cursor-pointer justify-between rounded gap-1 sm:gap-4 sm:px-1 py-1 my-1 ${l===a.id&&"bg-green-900"} hover:bg-neutral-500`,onClick:()=>g(a),children:[N(a),p(x),p(h)]})};function we({trades:a,update:l,viewHistory:s}){const{t:r}=v("trade-matches"),{toast:u}=ce(),{data:o}=I(),{data:n=[]}=B(),x=oe();function h(t){return t.offering_friend_id===o?.friend_id&&!t.offerer_ended||t.receiving_friend_id===o?.friend_id&&!t.receiver_ended}const p=s?a.filter(t=>!h(t)):a.filter(h),[g,N]=j.useState(void 0);if(!o)return null;const m=(t,_)=>({card_id:t,amount_owned:(n.find(T=>T.card_id===t)?.amount_owned??0)+_}),f=async t=>{if(t.offer_card_id!==t.receiver_card_id)if(t.offering_friend_id===o.friend_id){const _=[m(t.offer_card_id,-1),m(t.receiver_card_id,1)];x.mutate({updates:_}),u({title:r("collectionUpdated"),variant:"default"})}else if(t.receiving_friend_id===o.friend_id){const _=[m(t.offer_card_id,1),m(t.receiver_card_id,-1)];x.mutate({updates:_}),u({title:r("collectionUpdated"),variant:"default"})}else console.log(t,"can't match friend id")},y=t=>{const _=async c=>{await l(t.id,{status:c}),N(t.id)},T=async()=>{const c=t.offering_friend_id===o.friend_id?{offerer_ended:!0}:t.receiving_friend_id===o.friend_id?{receiver_ended:!0}:null;if(c===null){console.log(t," doesn't match your friend_id");return}await l(t.id,c),N(void 0)},d=t.offering_friend_id===o.friend_id&&t.offerer_ended||t.receiving_friend_id===o.friend_id&&t.receiver_ended;switch(t.status){case"offered":return e.jsxs(e.Fragment,{children:[t.receiving_friend_id===o.friend_id&&e.jsx(b,{type:"button",onClick:async()=>_("accepted"),children:r("actionAccept")}),e.jsx(b,{type:"button",onClick:async()=>_("declined"),children:t.receiving_friend_id===o.friend_id?r("actionDecline"):r("actionCancel")})]});case"accepted":return e.jsxs(e.Fragment,{children:[e.jsx(b,{type:"button",onClick:async()=>_("finished"),children:r("actionComplete")}),e.jsx(b,{type:"button",onClick:async()=>_("declined"),children:r("actionCancel")})]});case"declined":return d?null:e.jsx(b,{type:"button",onClick:T,children:r("actionHide")});case"finished":return d?null:e.jsxs(e.Fragment,{children:[e.jsx(b,{type:"button",onClick:async()=>{await f(t),await T()},children:r("actionUpdate")}),e.jsx(b,{type:"button",onClick:T,children:r("actionHide")})]});default:return console.log(`Unknown trade status ${t.status}`),null}},C=p.find(t=>t.id===g);return p.length===0?e.jsx("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2 text-center",children:r("noActiveTrades")}):e.jsxs("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2",children:[e.jsxs("div",{className:"flex gap-4 px-1",children:[e.jsx("div",{className:"w-9"}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:r("youGive")}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:r("youReceive")})]}),e.jsx("ul",{children:p.toSorted((t,_)=>t.created_at>_.created_at?-1:1).map(t=>e.jsx(ke,{row:t,selectedTradeId:g,setSelectedTradeId:N},t.id))}),C&&e.jsx("div",{className:"flex gap-4 text-center items-center mt-2",children:y(C)})]})}function Fe({friendId:a}){const l=le(),{t:s}=v("trade-matches"),{data:r}=q(),{data:u}=ue(a),o=me(),[n,x]=j.useState(!1);async function h(p,g){o.mutate({id:p,trade:g})}return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 mx-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-md",children:s("tradingWith")}),e.jsxs("span",{className:"text-md font-bold",children:[" ",u?.username||"loading"," "]})]}),e.jsxs("span",{className:"flex gap-4",children:[e.jsxs("label",{htmlFor:`history-${a}`,className:"my-auto flex items-center",children:[s("viewHistory"),e.jsx(ae,{id:`history-${a}`,className:"ml-2 my-auto",checked:n,onCheckedChange:x})]}),e.jsx(b,{className:"my-auto",onClick:()=>l(`/trade/${a}`),children:s("openTradeWith")})]})]}),u!==null&&r&&e.jsx(we,{trades:r.filter(p=>p.offering_friend_id===a||p.receiving_friend_id===a),update:h,viewHistory:n})]})}function Se(){const{t:a}=v("trade-matches"),{data:l}=I(),{data:s}=q();if(!s||!l)return null;if(s.length===0)return e.jsx("p",{children:a("noTradeOffers")});const r=$e(s,l.friend_id),u=Object.fromEntries(Object.entries(r).map(([n,x])=>[n,Math.max(...x.map(h=>new Date(h.updated_at).getTime()))])),o=Object.keys(r).toSorted((n,x)=>u[x]-u[n]);return e.jsx("div",{className:"flex flex-col items-center mx-auto gap-12 sm:px-4 mb-12",children:o.map(n=>e.jsx(Fe,{friendId:n},n))})}function $e(a,l){return Object.groupBy(a,s=>s.offering_friend_id===l?s.receiving_friend_id:s.receiving_friend_id===l?s.offering_friend_id:(console.log("Fetched row does not match user friend_id",s),"undefined"))}function Ie(){const{t:a}=v("trade-matches"),{data:l}=I(),s=fe(),r=xe({is_active_trading:_e(),min_number_of_cards_to_keep:Y().min(1).max(10),max_number_of_cards_wanted:Y().min(1).max(10)}),u=he({resolver:ge(r),values:{is_active_trading:l?.is_active_trading||!1,min_number_of_cards_to_keep:l?.min_number_of_cards_to_keep||1,max_number_of_cards_wanted:l?.max_number_of_cards_wanted||1}}),o=async n=>{try{s.mutate({username:l?.username,is_active_trading:n.is_active_trading,min_number_of_cards_to_keep:n.min_number_of_cards_to_keep,max_number_of_cards_wanted:n.max_number_of_cards_wanted}),W({title:a("accountSaved"),variant:"default"})}catch(x){console.error("error saving account",x),W({title:a("errorSavingAccount"),variant:"destructive"})}};return!l||!l.username?e.jsx(M,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:a("noAccount")}):e.jsxs("div",{children:[e.jsx(je,{...u,children:e.jsxs("form",{onSubmit:u.handleSubmit(o),className:"border-1 border-neutral-700 space-y-2 p-4 mx-auto",children:[e.jsx(U,{control:u.control,name:"is_active_trading",render:({field:n})=>e.jsx(E,{className:"flex flex-col items-start",children:e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(V,{className:"flex sm:w-72",children:a("isActiveTrading")}),e.jsx("div",{className:"grow-1",children:e.jsx(ae,{checked:n.value,onCheckedChange:n.onChange})}),e.jsx(be,{className:"grow",children:n.value?"active":"disabled"}),e.jsx(A,{id:"activeInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(L,{className:"h-4 w-4","data-tooltip-id":"activeInput","data-tooltip-content":a("activeTradingInputTooltip")})]})})})}),e.jsx(U,{control:u.control,name:"min_number_of_cards_to_keep",render:({field:n})=>e.jsx(E,{className:"flex flex-col items-start",children:e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(V,{className:"flex sm:w-72",children:a("minNumberOfCardsToKeep")}),e.jsx("div",{className:"grow-1",children:e.jsx(G,{className:"w-24",type:"number",...n})}),e.jsx(A,{id:"minInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(L,{className:"h-4 w-4","data-tooltip-id":"minInput","data-tooltip-content":a("minInputTooltip")})]})})})}),e.jsx(U,{control:u.control,name:"max_number_of_cards_wanted",render:({field:n})=>e.jsx(E,{className:"flex flex-col items-start",children:e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(V,{className:"flex sm:w-72",children:a("maxNumberOfCardsWanted")}),e.jsx("div",{className:"grow-1",children:e.jsx(G,{className:"w-24",type:"number",...n})}),e.jsx(A,{id:"maxInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(L,{className:"h-4 w-4","data-tooltip-id":"maxInput","data-tooltip-content":a("maxInputTooltip")})]})})})}),e.jsx("div",{className:"w-full flex justify-end mt-8",children:e.jsx(b,{type:"submit",children:a("save")})})]})}),e.jsx(ve,{className:"mt-4"})]})}function He(){const{t:a}=v("trade-matches");return e.jsxs(J,{className:"flex flex-col mx-auto max-w-[900px]",defaultValue:"offers",children:[e.jsxs(ee,{className:"gap-4 mb-6 rounded-lg border-b-1 border-neutral-700 border-solid dark:bg-transparent pb-2",children:[e.jsx(S,{className:"text-md",value:"cards",children:a("tabCards")}),e.jsx(S,{className:"text-md",value:"offers",children:a("tabOffers")}),e.jsx(S,{className:"text-md",value:"settings",children:a("tabSettings")})]}),e.jsx($,{value:"cards",children:e.jsx(Te,{})}),e.jsx($,{value:"offers",children:e.jsx(Se,{})}),e.jsx($,{value:"settings",children:e.jsx(Ie,{})})]})}export{He as default};
