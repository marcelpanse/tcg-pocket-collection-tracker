import{_ as ae,Z as re,u as C,j as e,r as l,U as E,C as U,s as ne,E as Z,X as q,B as N,Y as D,$ as se,a0 as ie,W as z,a1 as W,J as de,t as oe,a2 as ce,V as le,a3 as ue}from"./index-CAO0Rjw3.js";import{T as Y,a as ee,b as $,c as I,C as G}from"./tabs-Bj1lJt3i.js";import{N as J,M as A,C as M}from"./NumberFilter-D0dZFf6A.js";import{R as me}from"./useWindowDimensionsHook-B_irvQdN.js";import{A as B,a as H,b as K}from"./alert-BuR0f7ae.js";import{S as P}from"./siren-CfCL0SBa.js";import{u as fe,a as xe,F as pe,b as O,c as L,d as R,e as V,S as te,f as _e,g as he}from"./switch-CmX09Yoa.js";import"./Card-VoFaoR9q.js";import"./FancyCard-P7H9w3ZY.js";import"./index-CzeD8bow.js";function Q(t){return ae(re,t)}function ge(){const{t}=C("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(B,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(P,{className:"h-4 w-4"}),e.jsx(H,{children:t("noCardsNeeded.title")}),e.jsx(K,{children:t("noCardsNeeded.description")})]})})}function je(){const{t}=C("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(B,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(P,{className:"h-4 w-4"}),e.jsx(H,{children:t("noTradeableCards.title")}),e.jsx(K,{children:t("noTradeableCards.description")})]})})}function be(){const{t}=C("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(B,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(P,{className:"h-4 w-4"}),e.jsx(H,{children:t("notLoggedIn.title")}),e.jsx(K,{children:t("notLoggedIn.description")})]})})}function ve(){const{t}=C("pages/trade"),{user:x,account:r}=l.use(E),{ownedCards:s}=l.use(U),[p,m]=l.useState([]),[_,i]=l.useState((r?.max_number_of_cards_wanted??1)-1),[n,b]=l.useState((r?.min_number_of_cards_to_keep??1)+1),[h,y]=l.useState("looking_for"),u=l.useMemo(()=>ne.filter(d=>d.tradeable).map(d=>d.id),[]),f=d=>p.length===0?!0:d.rarity!==""&&p.includes(d.rarity),g=l.useMemo(()=>Z.filter(d=>s.findIndex(c=>c.card_id===d.card_id)===-1||s[s.findIndex(c=>c.card_id===d.card_id)].amount_owned<=_).filter(d=>q[d.rarity]!==null&&u.includes(d.expansion)),[s,_]),w=l.useMemo(()=>g.filter(f),[g,p]),j=l.useMemo(()=>{const d=s.filter(c=>c.amount_owned>=n);return Z.filter(c=>d.findIndex(S=>S.card_id===c.card_id)>-1).map(c=>({...c,amount_owned:d.find(S=>S.card_id===c.card_id)?.amount_owned})).filter(c=>q[c.rarity]!==null&&u.includes(c.expansion))},[s,n]),a=l.useMemo(()=>j.filter(f),[j,p]),v=()=>{let d="";r?.is_public&&(d+=`${t("publicTradePage")} https://tcgpocketcollectiontracker.com/#/collection/${r?.friend_id}/trade
`),r?.username&&(d+=`${t("friendID")} ${r.friend_id} (${r.username})

`),d+=`${t("lookingForCards")}
`;const c=w.sort((o,F)=>{const X=o.expansion.localeCompare(F.expansion);return X!==0?X:o.rarity.localeCompare(F.rarity)});for(let o=0;o<c.length;o++)(o>0?c[o-1].expansion:"")!==c[o].expansion&&(d+=`
${c[o].set_details}:
`),d+=`${c[o].rarity} ${c[o].card_id} - ${c[o].name}
`;const S=w.map(o=>o.rarity);d+=`

${t("forTradeCards")}
`;const k=a.filter(o=>S.includes(o.rarity)).sort((o,F)=>o.rarity.localeCompare(F.rarity));for(let o=0;o<k.length;o++)(o>0?k[o-1].expansion:"")!==k[o].expansion&&(d+=`
${k[o].set_details}:
`),d+=`${k[o].rarity} ${k[o].card_id} - ${k[o].name}
`;return d},T=async()=>{const d=v();D({title:t("copiedInClipboard"),variant:"default",duration:3e3}),await navigator.clipboard.writeText(d)};return x?e.jsx("div",{className:"flex flex-col gap-y-4",children:e.jsxs(Y,{defaultValue:h,onValueChange:y,children:[e.jsxs("div",{className:"mx-auto max-w-[900px] flex flex-row flex-wrap align-center gap-x-4 gap-y-2",children:[e.jsxs(ee,{className:"flex-grow m-auto flex-wrap h-auto border-1 border-neutral-700 rounded-md",children:[e.jsx($,{value:"looking_for",children:t("lookingFor")}),e.jsx($,{value:"for_trade",children:t("forTrade")})]}),e.jsx(me,{rarityFilter:p,setRarityFilter:m}),e.jsxs("div",{className:"sm:mt-1 flex flex-row flex-wrap align-center gap-x-4 gap-y-1",children:[h==="looking_for"&&e.jsx(J,{numberFilter:_,setNumberFilter:i,options:[0,1,2,3,4,5],labelKey:"maxNum"}),h==="for_trade"&&e.jsx(J,{numberFilter:n,setNumberFilter:b,options:[2,3,4,5],labelKey:"minNum"}),e.jsx(N,{variant:"outline",onClick:T,children:"Copy to clipboard"})]})]}),e.jsxs("div",{className:"mx-auto max-w-[900px] mt-6",children:[e.jsx(I,{value:"looking_for",children:g&&g.length>0?e.jsx(G,{cards:w,extraOffset:105}):e.jsx(ge,{})}),e.jsx(I,{value:"for_trade",children:j&&j.length>0?e.jsx(G,{cards:a,extraOffset:105}):e.jsx(je,{})})]})]})}):e.jsx(be,{})}function Ne(){const{t}=C("trade-matches"),{user:x,account:r,setAccount:s}=l.useContext(E),p=se({is_active_trading:ie(),min_number_of_cards_to_keep:Q().min(1).max(10),max_number_of_cards_wanted:Q().min(1).max(10)}),m=fe({resolver:xe(p),values:{is_active_trading:r?.is_active_trading||!1,min_number_of_cards_to_keep:r?.min_number_of_cards_to_keep||1,max_number_of_cards_wanted:r?.max_number_of_cards_wanted||1}}),_=async i=>{try{const n=await W.from("accounts").upsert({email:x?.user.email,username:r?.username,is_active_trading:i.is_active_trading,min_number_of_cards_to_keep:i.min_number_of_cards_to_keep,max_number_of_cards_wanted:i.max_number_of_cards_wanted}).select().single();if(!n.data)throw console.error("Could not save account",r),new Error("Could not save account");s(n.data),D({title:t("accountSaved"),variant:"default"})}catch(n){console.error("error saving account",n),D({title:t("errorSavingAccount"),variant:"destructive"})}};return e.jsxs("div",{children:[e.jsx(pe,{...m,children:e.jsxs("form",{onSubmit:m.handleSubmit(_),className:"border-1 border-neutral-700 space-y-2 p-4 mx-auto",children:[e.jsx(O,{control:m.control,name:"is_active_trading",render:({field:i})=>e.jsx(L,{className:"flex flex-col items-start",children:e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(V,{className:"flex sm:w-72",children:t("isActiveTrading")}),e.jsx("div",{className:"grow-1",children:e.jsx(te,{checked:i.value,onCheckedChange:i.onChange})}),e.jsx(_e,{className:"grow",children:i.value?"active":"disabled"}),e.jsx(A,{id:"activeInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(M,{className:"h-4 w-4","data-tooltip-id":"activeInput","data-tooltip-content":t("activeTradingInputTooltip")})]})})})}),e.jsx(O,{control:m.control,name:"min_number_of_cards_to_keep",render:({field:i})=>e.jsx(L,{className:"flex flex-col items-start",children:e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(V,{className:"flex sm:w-72",children:t("minNumberOfCardsToKeep")}),e.jsx("div",{className:"grow-1",children:e.jsx(z,{className:"w-24",type:"number",...i})}),e.jsx(A,{id:"minInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(M,{className:"h-4 w-4","data-tooltip-id":"minInput","data-tooltip-content":t("minInputTooltip")})]})})})}),e.jsx(O,{control:m.control,name:"max_number_of_cards_wanted",render:({field:i})=>e.jsx(L,{className:"flex flex-col items-start",children:e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(V,{className:"flex sm:w-72",children:t("maxNumberOfCardsWanted")}),e.jsx("div",{className:"grow-1",children:e.jsx(z,{className:"w-24",type:"number",...i})}),e.jsx(A,{id:"maxInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(M,{className:"h-4 w-4","data-tooltip-id":"maxInput","data-tooltip-content":t("maxInputTooltip")})]})})})}),e.jsx("div",{className:"w-full flex justify-end mt-8",children:e.jsx(N,{type:"submit",children:t("save")})})]})}),e.jsx(he,{className:"mt-4"})]})}const Ce=({row:t,selectedTradeId:x,setSelectedTradeId:r})=>{const{t:s,i18n:p}=C("trade-matches"),{account:m}=l.useContext(E),{ownedCards:_}=l.useContext(U);if(!m)return null;const i=t.offering_friend_id===m.friend_id?t.offer_card_id:t.receiver_card_id,n=t.offering_friend_id===m.friend_id?t.receiver_card_id:t.offer_card_id;function b(u){const f=de(u);return f?e.jsxs("span",{className:"flex rounded px-1 w-1/2 bg-zinc-800",children:[e.jsxs("span",{className:"mr-2 sm:min-w-10",children:[f.rarity," "]}),e.jsxs("span",{className:"mr-2 sm:min-w-14 me-4",children:[f.card_id," "]}),e.jsx("span",{children:oe(f,p.language)}),e.jsxs("span",{className:"text-neutral-400 ml-auto",children:["×",_.find(g=>g.card_id===f.card_id)?.amount_owned||0]})]}):e.jsx("span",{className:"w-1/2 text-center",children:"?"})}function h(u){x===u.id?r(void 0):r(u.id)}const y=u=>{const f={offered:{icon:u.offering_friend_id===m.friend_id?"→":"←",color:"bg-amber-600"},accepted:{icon:"↔",color:"bg-lime-600"},declined:{icon:"X",color:"bg-stone-600"},finished:{icon:"✓",color:"bg-indigo-600"}};return e.jsxs(e.Fragment,{children:[e.jsx(A,{id:`tooltip-${u.id}`}),e.jsx("span",{className:`rounded-full text-center w-9 min-w-6 ${f[u.status].color}`,"data-tooltip-id":`tooltip-${u.id}`,"data-tooltip-content":s(`status.${u.status}`),children:f[u.status].icon})]})};return e.jsxs("li",{className:`flex cursor-pointer justify-between rounded gap-1 sm:gap-4 sm:px-1 py-1 my-1 ${x===t.id&&"bg-green-900"} hover:bg-neutral-500`,onClick:()=>h(t),children:[y(t),b(i),b(n)]})};function ye({trades:t,update:x,viewHistory:r}){const{t:s}=C("trade-matches"),{toast:p}=ce();function m(a){return a.offering_friend_id===n?.friend_id&&!a.offerer_ended||a.receiving_friend_id===n?.friend_id&&!a.receiver_ended}const{ownedCards:_,updateCards:i}=l.useContext(U),{account:n,user:b}=l.useContext(E),h=r?t.filter(a=>!m(a)):t.filter(m),[y,u]=l.useState(void 0);if(!n||!b)return null;const f=(a,v)=>({card_id:a,amount_owned:(_.find(T=>T.card_id===a)?.amount_owned??0)+v}),g=async a=>{a.offer_card_id!==a.receiver_card_id&&(a.offering_friend_id===n.friend_id?(await i([f(a.offer_card_id,-1),f(a.receiver_card_id,1)]),p({title:s("collectionUpdated"),variant:"default"})):a.receiving_friend_id===n.friend_id?(await i([f(a.offer_card_id,1),f(a.receiver_card_id,-1)]),p({title:s("collectionUpdated"),variant:"default"})):console.log(a,"can't match friend id"))},w=a=>{const v=async c=>{await x(a.id,{status:c}),u(a.id)},T=async()=>{const c=a.offering_friend_id===n.friend_id?{offerer_ended:!0}:a.receiving_friend_id===n.friend_id?{receiver_ended:!0}:null;if(c===null){console.log(a," doesn't match your friend_id");return}await x(a.id,c),u(void 0)},d=a.offering_friend_id===n.friend_id&&a.offerer_ended||a.receiving_friend_id===n.friend_id&&a.receiver_ended;switch(a.status){case"offered":return e.jsxs(e.Fragment,{children:[a.receiving_friend_id===n.friend_id&&e.jsx(N,{type:"button",onClick:async()=>v("accepted"),children:s("actionAccept")}),e.jsx(N,{type:"button",onClick:async()=>v("declined"),children:a.receiving_friend_id===n.friend_id?s("actionDecline"):s("actionCancel")})]});case"accepted":return e.jsxs(e.Fragment,{children:[e.jsx(N,{type:"button",onClick:async()=>v("finished"),children:s("actionComplete")}),e.jsx(N,{type:"button",onClick:async()=>v("declined"),children:s("actionCancel")})]});case"declined":return d?null:e.jsx(N,{type:"button",onClick:T,children:s("actionHide")});case"finished":return d?null:e.jsxs(e.Fragment,{children:[e.jsx(N,{type:"button",onClick:async()=>{await g(a),await T()},children:s("actionUpdate")}),e.jsx(N,{type:"button",onClick:T,children:s("actionHide")})]});default:return console.log(`Unknown trade status ${a.status}`),null}},j=h.find(a=>a.id===y);return h.length===0?e.jsx("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2 text-center",children:s("noActiveTrades")}):e.jsxs("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2",children:[e.jsxs("div",{className:"flex gap-4 px-1",children:[e.jsx("div",{className:"w-9"}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:s("youGive")}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:s("youReceive")})]}),e.jsx("ul",{children:h.toSorted((a,v)=>a.created_at>v.created_at?-1:1).map(a=>e.jsx(Ce,{row:a,selectedTradeId:y,setSelectedTradeId:u},a.id))}),j&&e.jsx("div",{className:"flex gap-4 text-center items-center mt-2",children:w(j)})]})}function we(t,x){return Object.groupBy(t,r=>r.offering_friend_id===x?r.receiving_friend_id:r.receiving_friend_id===x?r.offering_friend_id:(console.log("Fetched row does not match user friend_id",r),"undefined"))}function Te({friendId:t,initialTrades:x}){const{t:r}=C("trade-matches"),[s,p]=l.useState(null),m=le(),[_,i]=l.useState(x),[n,b]=l.useState(!1);async function h(y,u){const f=new Date,{error:g}=await W.from("trades").update({updated_at:f,...u}).eq("id",y);if(g)throw console.log("Error updating trades: ",g),new Error("TradeOffers.tsx:update: Error updating trade");i(w=>w.map(j=>j.id===y?{...j,updated_at:f,...u}:j))}return l.useEffect(()=>{s||ue(t).then(p)}),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 mx-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-md",children:r("tradingWith")}),e.jsxs("span",{className:"text-md font-bold",children:[" ",s?.username||"loading"," "]})]}),e.jsxs("span",{className:"flex gap-4",children:[e.jsxs("label",{htmlFor:`history-${t}`,className:"my-auto flex items-center",children:[r("viewHistory"),e.jsx(te,{id:`history-${t}`,className:"ml-2 my-auto",checked:n,onCheckedChange:b})]}),e.jsx(N,{className:"my-auto",onClick:()=>m(`/trade/${t}`),children:r("openTradeWith")})]})]}),s!==null&&e.jsx(ye,{trades:_,update:h,viewHistory:n})]})}function ke(){const{t}=C("trade-matches"),{account:x}=l.useContext(E),[r,s]=l.useState(null);if(l.useEffect(()=>{x&&r===null&&(console.log("Refrehing trades"),W.from("trades").select().then(({data:i,error:n})=>{n?console.log("Error fetching trades: ",n):s(i)}))}),r===null||!x)return null;if(r.length===0)return e.jsx("p",{children:t("noTradeOffers")});const p=we(r,x.friend_id),m=Object.fromEntries(Object.entries(p).map(([i,n])=>[i,Math.max(...n.map(b=>new Date(b.updated_at).getTime()))])),_=Object.keys(p).toSorted((i,n)=>m[n]-m[i]);return e.jsx("div",{className:"flex flex-col items-center mx-auto gap-12 sm:px-4 mb-12",children:_.map(i=>e.jsx(Te,{friendId:i,initialTrades:p[i]},i))})}function Ve(){const{t}=C("trade-matches");return e.jsxs(Y,{className:"flex flex-col mx-auto max-w-[900px]",defaultValue:"offers",children:[e.jsxs(ee,{className:"gap-4 mb-6 rounded-lg border-b-1 border-neutral-700 border-solid dark:bg-transparent pb-2",children:[e.jsx($,{className:"text-md",value:"cards",children:t("tabCards")}),e.jsx($,{className:"text-md",value:"offers",children:t("tabOffers")}),e.jsx($,{className:"text-md",value:"settings",children:t("tabSettings")})]}),e.jsx(I,{value:"cards",children:e.jsx(ve,{})}),e.jsx(I,{value:"offers",children:e.jsx(ke,{})}),e.jsx(I,{value:"settings",children:e.jsx(Ne,{})})]})}export{Ve as default};
