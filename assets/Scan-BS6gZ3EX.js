import{j as s}from"./query-vendor-DpGHCXpY.js";import{h as he,w as xe,c as pe,u as ye,h5 as we,d as ee,B as G,A as se,S as ae,hd as be,gU as ue,he as je,x as Ce,b as ve,h7 as Ie}from"./index-DgYBXqvi.js";import{u as Se,i as V}from"./i18n-vendor-DDmeScd6.js";import{r as D}from"./react-vendor-DjlsVz29.js";import{D as _e}from"./Filters-BXh8jqjH.js";import{l as Ne,e as ce,t as oe,s as ie,d as le,a as de,c as me,b as ke,i as fe,f as Ee}from"./tensorflow-vendor-BLGbDe0T.js";import{P as Ue}from"./plus-B-EiMjtg.js";import"./charts-vendor-D-Ae2kUX.js";import"./supabase-vendor-CP3OYKhD.js";import"./ui-vendor-9yhwxkpr.js";import"./xlsx-vendor-De4COjWB.js";import"./tabs-BdpXoZSp.js";const Me=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Ae=he("square-check",Me);const Re=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],De=he("square-x",Re),S=96,W=8;async function Le(e){const a=await ze(e),n=document.createElement("canvas"),t=n.getContext("2d");if(!t)throw new Error("Failed to process image");n.width=S,n.height=S,t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high",t.drawImage(a,0,0,S,S);const i=t.getImageData(0,0,S,S).data,d={r:new Array(S*S),g:new Array(S*S),b:new Array(S*S)};for(let o=0;o<i.length;o+=4){const l=o/4;d.r[l]=i[o],d.g[l]=i[o+1],d.b[l]=i[o+2]}return d}function Pe(e){const a=re(e.r),n=re(e.g),t=re(e.b),r=new ArrayBuffer(Math.ceil(3*(a.length-1)/32)*4),i=new Uint32Array(r);let d=0;const o=l=>{let f=0;for(let u=1;u<l.length;u++)f+=l[u];f/=l.length-1;for(let u=1;u<l.length;u++,d++)Math.abs(l[u]-f)<1e-6&&console.warn("Numerical instability in hash calculation detected"),l[u]>f+1e-15&&(i[Math.floor(d/32)]|=1<<d%32)};return o(a),o(n),o(t),r}function $e(e,a){let n=0;const t=new Uint32Array(e),r=new Uint32Array(a);t.length!==r.length&&console.warn("hash.ts:calculateSimilarity: Buffer length mismatch");const i=Math.min(t.length,r.length);for(let d=0;d<i;d++){let o=t[d]^r[d];for(;o;)o&=o-1,n++}return 1-n/(3*(W*W-1))}function re(e){const a=Math.round(Math.sqrt(e.length)),n=new Array(W*W);for(let t=0;t<W;t++)for(let r=0;r<W;r++){let i=0;for(let l=0;l<a;l++)for(let f=0;f<a;f++)i+=e[l*a+f]*Math.cos((2*f+1)*t*Math.PI/(2*a))*Math.cos((2*l+1)*r*Math.PI/(2*a));const d=t===0?1/Math.sqrt(2):1,o=r===0?1/Math.sqrt(2):1;n[t*W+r]=2*d*o/a*i}return n}function ze(e){return new Promise((a,n)=>{if(e instanceof HTMLImageElement)e.complete?a(e):(e.onload=()=>a(e),e.onerror=()=>n(new Error("Failed to load image")));else{const t=new Image;t.crossOrigin="Anonymous",t.onload=()=>a(t),t.onerror=()=>n(new Error("Failed to load image from URL")),t.src=e}})}const Be=1,qe="/model/model.json";async function He(){return Ne(qe)}async function Te(e){return new Promise((a,n)=>{if(!e.type.startsWith("image/"))return n(new Error("Invalid file type"));const t=new FileReader;t.onload=()=>{const r=new Image;r.src=t.result,r.onload=()=>{a(r)},r.onerror=i=>{n(i)}},t.onerror=r=>{n(r)},t.readAsDataURL(e)})}function Fe(e,a,n){const t=e.width,r=e.height,i=Math.max(t,r),d=i,o=i;return{input:oe(()=>{const u=Ee(e).pad([[0,i-r],[0,i-t],[0,0]]);return fe.resizeBilinear(u,[a,n]).div(255).expandDims(0)}),originalWidth:t,originalHeight:r,paddedWidth:d,paddedHeight:o}}async function We(e,a){const{input:d,originalWidth:o,originalHeight:l,paddedWidth:f,paddedHeight:u}=Fe(a,640,640);try{ce().startScope();const b=e.predict(d),[F,L,O]=oe(()=>{let x;b.shape.length===3&&b.shape[0]===1?x=b.squeeze([0]):x=b;const C=x.slice([0,0],[4,-1]).transpose(),v=C.slice([0,0],[-1,1]),A=C.slice([0,1],[-1,1]),h=C.slice([0,2],[-1,1]),N=C.slice([0,3],[-1,1]),B=ie(v,le(h,2)),I=ie(A,le(N,2)),q=de(B,h),k=de(I,N),E=me([I,B,k,q],1),R=x.slice([4,0],[1,-1]).squeeze(),H=x.slice([5,0],[Be,-1]),T=R,X=ke(H,0);return[E,T,X]}),_=await fe.nonMaxSuppressionAsync(F,L,100,.1,.1),Q=oe(()=>me([F.gather(_,0),L.gather(_,0).expandDims(1),O.gather(_,0).expandDims(1)],1)),p=Q.dataSync(),j=Q.shape[0],P=[],$=o/f,z=l/u;for(let x=0;x<j;x++){const y=x*6,C=p[y],v=p[y+1],A=p[y+2],h=p[y+3],N=p[y+4],B=p[y+5],I=v*o/640/$,q=C*l/640/z,k=h*o/640/$,E=A*l/640/z,R=[[I,q],[k,q],[k,E],[I,E]];P.push({points:R,confidence:N*100,class:"pokemon_card",label:B})}return P}finally{d.dispose(),ce().endScope()}}async function Oe(e,a){const n=[];for(let t=0;t<a.length;t++)try{const r=await Te(a[t]),i=await We(e,r);n.push({imageIndex:t,detections:i})}catch(r){console.error(`Error detecting objects in image ${t}:`,r),n.push({imageIndex:t,detections:[]})}return n}function Xe(e,a){const n=e.split("/").at(-1),t=`/images/${a}/${n}`,r=`/images/en-US/${n}`;return new Promise(i=>{const d=new Image;d.onload=()=>{console.log("[Image Load] Success:",t),i(t)},d.onerror=()=>{console.warn("[Image Load] Failed:",t,"returning",r,"instead"),i(r)},d.src=t})}async function Ye(e,a,n,t){if(!e.type.startsWith("image/"))throw new Error("PokemonCardDetectorComponent.tsx:extractCardImages: Invalid file type");if(!n)throw new Error("Cant extract card images: hashes not loaded yet");const r=new Image,i=URL.createObjectURL(e);return new Promise(d=>{if(r.onload=async()=>{const o=document.createElement("canvas"),l=o.getContext("2d");if(l===null)throw new Error("Failed creating context");const f=await Promise.all(a.detections.filter(u=>u.confidence>=50).map(async u=>{const[[b,F],L,[O,_],Q]=u.points,p=O-b,j=_-F;o.width=p,o.height=j,l.drawImage(r,b,F,p,j,0,0,p,j);const P=o.toDataURL("image/png"),$=await Le(P),z=Pe($),x=Object.keys(n).map(h=>[Number(h),$e(z,n[h])]).sort(([h,N],[B,I])=>I-N);console.log(`Confidence: ${x[0][1]-x[1][1]}
`,"Best matches:",x.slice(0,5));const[y,C]=x[0],v=xe(y);if(!v)throw new Error("Hashes key does not correspond to any card");const A=await Xe(v.image,t);return{matchedCard:{card:v,similarity:C},imageUrl:P,resolvedImageUrl:A,increment:1}}));URL.revokeObjectURL(i),d(f)},i.startsWith("blob:"))r.src=i;else throw console.error("Invalid image URL:",i),URL.revokeObjectURL(i),new Error("PokemonCardDetectorComponent.tsx:extractCardImages: Invalid image URL")})}function Ge(e){try{return Uint8Array.fromBase64(e).buffer}catch{const a=atob(e),n=new Uint8Array(a.length);for(let t=0;t<a.length;t++)n[t]=a.charCodeAt(t);return n.buffer}}const pt=()=>{const e=pe.c(50);let a;e[0]===Symbol.for("react.memo_cache_sentinel")?(a=["scan","common/sets"],e[0]=a):a=e[0];const{t:n}=Se(a),{data:t,isLoading:r}=ye(),i=we(),d=D.useRef(null),[o,l]=D.useState(1),[f,u]=D.useState(void 0),[b,F]=D.useState(),[L,O]=D.useState(),[_,Q]=D.useState();let p;e[1]===Symbol.for("react.memo_cache_sentinel")?(p=[],e[1]=p):p=e[1];const[j,P]=D.useState(p);let $;e[2]===Symbol.for("react.memo_cache_sentinel")?($=[],e[2]=$):$=e[2];const[z,x]=D.useState($);let y,C;e[3]===Symbol.for("react.memo_cache_sentinel")?(y=()=>{const c=async(g,U)=>{try{const w=await fetch(`/hashes/${g}/hashes.json`);if(!w.ok){u(`Could not fetch hashes: ${w.status}: ${w.statusText}`);return}const M=await w.json(),J=Object.fromEntries(Object.entries(M).map(Qe));U(J)}catch(w){const M=w;console.error(`Failed getting hashes for '${g}': ${M}`),g==="en-US"&&u(`Error getting card hashes: ${M}`)}},m=g=>{g==="en-US"?O({}):c(g,O)};return c("en-US",Q),m(V.language),V.on("languageChanged",m),()=>V.off("languageChanged",m)},C=[V],e[3]=y,e[4]=C):(y=e[3],C=e[4]),D.useEffect(y,C);let v,A;e[5]===Symbol.for("react.memo_cache_sentinel")?(v=()=>{He().then(F)},A=[],e[5]=v,e[6]=A):(v=e[5],A=e[6]),D.useEffect(v,A);let h;if(e[7]!==j){const c=j.filter(Je).map(Ke);h=new Map;for(const{card_id:m,increment:g}of c)h.set(m,(h.get(m)??0)+g);for(const m of h.keys())h.get(m)===0&&h.delete(m);e[7]=j,e[8]=h}else h=e[8];let N;e[9]!==_||e[10]!==L||e[11]!==b?(N=async c=>{if(!b||!L||!_){u("Model and hashes not loaded yet");return}l(2);const m=c.target.files;if(!m)return;const g=Array.from(m).filter(Ve);if(g.length!==0)try{const U=await Oe(b,g),w=g.map((M,J)=>Ye(M,U[J],Object.assign(_,L),V.language));P((await Promise.all(w)).flat()),l(3)}catch(U){u(`Error during detection: ${U}`)}},e[9]=_,e[10]=L,e[11]=b,e[12]=N):N=e[12];const B=N;let I;e[13]!==h||e[14]!==r||e[15]!==t||e[16]!==i?(I=async()=>{if(r){u("Confirm called before collection loaded");return}if(!t){u("Loading collection failed");return}if(l(4),h.size===0){l(5),x([]);return}const c=[];for(const[m,g]of h){const U=Ce(m),w=t.get(U?.internal_id||0)?.amount_owned??0;c.push({card_id:m,previous_amount:w,increment:g})}try{i.mutate({updates:c.map(Ze)})}catch(m){u(`Error incrementing card quantities: ${m}`);return}x(c),l(5)},e[13]=h,e[14]=r,e[15]=t,e[16]=i,e[17]=I):I=e[17];const q=I;if(f!==void 0){let c;e[18]===Symbol.for("react.memo_cache_sentinel")?(c=s.jsx(ve,{children:"An error occured!"}),e[18]=c):c=e[18];let m;return e[19]!==f?(m=s.jsxs(se,{variant:"destructive",className:"max-w-sm mx-auto",children:[c,s.jsx(ee,{children:f})]}),e[19]=f,e[20]=m):m=e[20],m}if(!b||!L||!_){let c;return e[21]===Symbol.for("react.memo_cache_sentinel")?(c=s.jsx(ae,{size:"lg",overlay:!0}),e[21]=c):c=e[21],c}let k;e[22]!==B||e[23]!==o||e[24]!==n?(k=o===1&&s.jsxs("div",{className:"file-input-container flex flex-col items-center justify-center p-6 border-2 border-dashed rounded-md hover:bg-gray-50 dark:hover:bg-gray-900/10",children:[s.jsx(ee,{children:s.jsx("p",{className:"text-neutral-400 mb-4 text-center",children:n("description")})}),s.jsx("input",{type:"file",ref:d,onChange:B,accept:"image/*",multiple:!0,className:"w-full hidden"}),s.jsx(G,{variant:"outline",className:"mt-2",onClick:()=>d.current?.click(),children:n("selectImages")})]}),e[22]=B,e[23]=o,e[24]=n,e[25]=k):k=e[25];let E;e[26]!==o||e[27]!==n?(E=o===2&&s.jsx(se,{variant:"default",children:s.jsxs(ee,{className:"flex items-center space-x-2",children:[s.jsx(ae,{size:"inline"}),s.jsx("p",{children:n("processing")})]})}),e[26]=o,e[27]=n,e[28]=E):E=e[28];let R;e[29]!==h||e[30]!==j||e[31]!==q||e[32]!==r||e[33]!==t||e[34]!==o||e[35]!==n?(R=o===3&&s.jsxs(s.Fragment,{children:[s.jsxs("h2",{className:"text-center text-xl",children:["Found ",j.length," cards"]}),s.jsx("p",{className:"text-center text-sm text-neutral-400 px-2",children:"Select the increment amount for the matched cards. Click the image to quickly exclude or include a card."}),s.jsx("div",{className:"grid md:grid-cols-3 sm:grid-cols-2 grid-cols-1 gap-2 my-2",children:j.map((c,m)=>{const g=c.increment!==0,U=be(c.matchedCard.card.internal_id);if(!U)throw new Error("InternalId doesnt match any card");const w=U.map(et),M=te=>{const Z=Number(te);P(K=>K.map((Y,ne)=>ne===m?{...Y,increment:Z}:Y))},J=te=>{const Z=U.find(K=>K.expansion===te);if(!Z)throw new Error("Card expansion mismatch");P(K=>K.map((Y,ne)=>ne===m?{...Y,matchedCard:{...Y.matchedCard,card:Z}}:Y))},ge=(t?.get(c.matchedCard.card.internal_id)?.amount_owned??0)+c.increment>0;return s.jsxs("div",{className:`border-3 rounded-lg p-2 ${c.increment>0&&"border-green-400"} ${c.increment<0&&"border-red-400"}`,children:[s.jsxs("h3",{className:"flex mb-2",children:[g?s.jsx(Ae,{}):s.jsx(De,{}),s.jsx(ue,{className:"bg-transparent",card_id:c.matchedCard.card.card_id,id:"hidden",rarity:"hidden",details:"hidden",increment:h.get(c.matchedCard.card.card_id)})]}),s.jsxs("div",{className:"flex gap-2 justify-between mb-2",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(G,{variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>M(String(c.increment-1)),disabled:!ge,children:s.jsx(je,{className:"h-4 w-4"})}),s.jsx("div",{className:"min-w-8 text-center font-semibold select-none",children:c.increment>0?`+${c.increment}`:c.increment}),s.jsx(G,{variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>M(String(c.increment+1)),children:s.jsx(Ue,{className:"h-4 w-4"})})]}),w.length>1&&s.jsx(_e,{className:"inline-block",options:w,value:c.matchedCard.card.expansion,onChange:J})]}),s.jsxs("button",{type:"button",className:`flex w-full cursor-pointer gap-2 ${!g&&"grayscale"} transition-all duration-200`,onClick:()=>M(g?"0":"+1"),children:[s.jsxs("div",{className:"w-1/2 flex flex-col gap-1 justify-between",children:[s.jsx("img",{src:c.imageUrl,alt:`Detected card ${m+1}`,className:"w-full h-auto object-contain"}),s.jsx("div",{className:"bg-gray-500 text-white text-xs px-1 py-0.5 text-center",children:n("extractedCard")})]}),s.jsxs("div",{className:"w-1/2 flex flex-col gap-1 justify-between",children:[s.jsx("img",{src:c.resolvedImageUrl,alt:"Best match",className:"w-full h-auto object-contain"}),s.jsx("div",{className:"bg-green-600 text-white text-xs px-1 py-0.5 text-center",children:n("percentMatch",{match:(c.matchedCard.similarity*100).toFixed(0)})})]})]})]},m)})}),s.jsx(G,{variant:"default",className:"mx-auto w-full sm:w-60",onClick:q,disabled:h.size===0||r,children:n("updateSelectedCards")}),s.jsx(G,{variant:"outline",className:"mx-auto w-full sm:w-60",onClick:()=>l(1),children:n("scanMore")})]}),e[29]=h,e[30]=j,e[31]=q,e[32]=r,e[33]=t,e[34]=o,e[35]=n,e[36]=R):R=e[36];let H;e[37]!==o||e[38]!==n?(H=o===4&&s.jsx(se,{variant:"default",children:s.jsxs(ee,{className:"flex items-center space-x-2",children:[s.jsx(ae,{size:"inline"}),s.jsx("p",{children:n("processing")})]})}),e[37]=o,e[38]=n,e[39]=H):H=e[39];let T;e[40]!==z||e[41]!==o||e[42]!==n?(T=o===5&&s.jsxs("div",{className:"flex flex-col w-full max-w-lg mx-auto",children:[s.jsx("p",{className:"text-xl text-center mb-4",children:n("success",{n:z.reduce(tt,0)})}),s.jsx("ul",{className:"flex flex-col gap-2 mb-8",children:z.map(nt)}),s.jsx(G,{onClick:()=>l(1),variant:"default",children:n("scanMore")})]}),e[40]=z,e[41]=o,e[42]=n,e[43]=T):T=e[43];let X;return e[44]!==E||e[45]!==R||e[46]!==H||e[47]!==T||e[48]!==k?(X=s.jsxs("div",{className:"flex flex-col mx-auto max-w-[900px] p-1 sm:p-2 gap-2 rounded-lg border-1 border-neutral-700 border-solid",children:[k,E,R,H,T]}),e[44]=E,e[45]=R,e[46]=H,e[47]=T,e[48]=k,e[49]=X):X=e[49],X};function Qe(e){const[a,n]=e;return[a,Ge(n)]}function Je(e){return e.increment!==0&&e.matchedCard}function Ke(e){return{card_id:e.matchedCard.card.card_id,increment:e.increment}}function Ve(e){return e.type.startsWith("image/")}function Ze(e){return{card_id:e.card_id,internal_id:Ie(e.card_id),amount_owned:Math.max(0,e.previous_amount+e.increment)}}function et(e){return e.expansion}function tt(e,a){return e+a.increment}function nt(e){return s.jsx("li",{children:s.jsx(ue,{card_id:e.card_id,amount_owned:e.previous_amount,increment:e.increment})},e.card_id)}export{pt as default};
