import{j as s,d as Fe}from"./query-vendor-DpGHCXpY.js";import{h as Z,c as P,gX as D,gQ as le,g$ as Le,h0 as ae,B as $,j as q,h1 as Ee,h2 as Pe,u as je,h3 as Me,h4 as ze,h5 as He,C as be,D as Re,h6 as ve,h7 as Oe,h8 as ye,h9 as Ne,I as V,S as G,ha as oe,hb as fe,hc as J,E as W,R as Ce,hd as Ue,z as Be,he as De,Q as Ve,hf as We,hg as qe,o as me,s as Ke,p as Qe,_ as Ye,x as Xe,A as Ge,gW as ue,t as xe}from"./index-Co2qPlkR.js";import{r as I,e as Je,j as we,L as de,f as Te,u as Ze,k as B,N as et,l as tt}from"./react-vendor-DjlsVz29.js";import{T as ee,a as st,b as rt}from"./tabs-BKTt-LaO.js";import{F as Se}from"./friend-id-display-Cgh-2Hqj.js";import{S as ce,a as it}from"./SocialShareButtons-BayEC1Qn.js";import{u as F,i as at}from"./i18n-vendor-DDmeScd6.js";import{p as nt}from"./ui-vendor-9yhwxkpr.js";import{M as X,C as te}from"./react-tooltip.min-DbX3Tyvz.js";import{A as lt,U as dt}from"./user-plus-BgQ4hNbF.js";import{C as ke}from"./chevron-first-CosL4f1z.js";import{S as ct}from"./SearchInput-DKnVLa7u.js";import{g as ot}from"./filters-AOKSn7qS.js";import{u as ft,a as mt,b as ut,F as se,c as re,e as ie,d as xt}from"./form-Bo8aA4Dj.js";import{n as he}from"./coerce-BkPryosD.js";import"./charts-vendor-D-Ae2kUX.js";import"./supabase-vendor-CP3OYKhD.js";import"./xlsx-vendor-De4COjWB.js";import"./index-5ziEWJdO.js";const ht=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],_t=Z("arrow-left",ht);const pt=[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]],gt=Z("arrow-right-left",pt);const jt=[["path",{d:"m7 6 5 5 5-5",key:"1lc07p"}],["path",{d:"m7 13 5 5 5-5",key:"1d48rs"}]],$e=Z("chevrons-down",jt);const bt=[["path",{d:"m17 11-5-5-5 5",key:"e8nh98"}],["path",{d:"m17 18-5-5-5 5",key:"2avn1x"}]],Ae=Z("chevrons-up",bt),_e=t=>{const e=P.c(15),{cards:r,selected:a,setSelected:i}=t;let d,n,g;if(e[0]!==r||e[1]!==a?.card_id||e[2]!==i){const x=[...r].sort(yt);let l;e[6]!==a?.card_id||e[7]!==i?(l=function(_){const b=function(){a?.card_id===_.card_id?i(null):i(_)};return s.jsx("li",{className:"rounded cursor-pointer",onClick:b,children:s.jsx(D,{className:`w-full ${a?.card_id===_.card_id&&"bg-green-900"} hover:bg-neutral-600`,card_id:_.card_id,rarity:"hidden"})},_.card_id)},e[6]=a?.card_id,e[7]=i,e[8]=l):l=e[8];const f=l;g="rounded-lg border-1 border-neutral-700 border-solid p-2 overflow-y-auto",d="space-y-1",n=x.map(f),e[0]=r,e[1]=a?.card_id,e[2]=i,e[3]=d,e[4]=n,e[5]=g}else d=e[3],n=e[4],g=e[5];let c;e[9]!==d||e[10]!==n?(c=s.jsx("ul",{className:d,children:n}),e[9]=d,e[10]=n,e[11]=c):c=e[11];let u;return e[12]!==g||e[13]!==c?(u=s.jsx("div",{className:g,children:c}),e[12]=g,e[13]=c,e[14]=u):u=e[14],u};function vt(t){const e=t.split("-"),r=e[0]||"",a=e.length>1?parseInt(e[1],10):0;return{setName:r,cardNumber:a}}function yt(t,e){const r=vt,a=r(t.card_id),i=r(e.card_id);return a.setName!==i.setName?a.setName.localeCompare(i.setName):a.cardNumber-i.cardNumber}function pe(t){return t===null?s.jsx("span",{className:"inline-block mx-auto",children:"—"}):s.jsx(D,{className:"flex-1",card_id:t.card_id,details:"hidden"})}const Nt=t=>{const e=P.c(37),{yourId:r,friendId:a,yourCard:i,friendCard:d,setYourCard:n,setFriendCard:g}=t,{t:c}=F("trade-matches"),{toast:u}=le(),x=Le(),l=i&&d&&i.rarity===d.rarity;let f;e[0]!==l||e[1]!==d||e[2]!==a||e[3]!==x||e[4]!==g||e[5]!==n||e[6]!==c||e[7]!==u||e[8]!==i||e[9]!==r?(f=async function(){if(!l)return;const k={offering_friend_id:r,receiving_friend_id:a,offer_card_id:i.card_id,receiver_card_id:d.card_id,status:"offered"};try{x.mutate(k)}catch(A){console.log("TradeOffer: Error inserting trade",A),u({title:c("tradeFailed"),variant:"default"})}n(null),g(null),u({title:c("tradeOffered"),variant:"default"}),ae("Offer trade")},e[0]=l,e[1]=d,e[2]=a,e[3]=x,e[4]=g,e[5]=n,e[6]=c,e[7]=u,e[8]=i,e[9]=r,e[10]=f):f=e[10];const o=f;if(!i&&!d){let C;e[11]!==c?(C=c("selectCardsToTrade"),e[11]=c,e[12]=C):C=e[12];let k;return e[13]!==C?(k=s.jsx("div",{className:"sticky top-0 z-10 flex rounded-lg border-1 bg-neutral-900 border-neutral-700 border-solid p-2 w-full items-center justify-around text-center h-[110px] sm:h-[82px]",children:s.jsx("h4",{className:"text-lg font-medium text-neutral-400",children:C})}),e[13]=C,e[14]=k):k=e[14],k}let _;e[15]===Symbol.for("react.memo_cache_sentinel")?(_=s.jsx(Ae,{}),e[15]=_):_=e[15];let b;e[16]!==i?(b=pe(i),e[16]=i,e[17]=b):b=e[17];let y;e[18]!==b?(y=s.jsxs("div",{className:"flex w-full sm:w-1/2",children:[_,b]}),e[18]=b,e[19]=y):y=e[19];let S;e[20]===Symbol.for("react.memo_cache_sentinel")?(S=s.jsx($e,{}),e[20]=S):S=e[20];let N;e[21]!==d?(N=pe(d),e[21]=d,e[22]=N):N=e[22];let v;e[23]!==N?(v=s.jsxs("div",{className:"flex w-full sm:w-1/2",children:[S,N]}),e[23]=N,e[24]=v):v=e[24];let T;e[25]!==y||e[26]!==v?(T=s.jsxs("div",{className:"flex flex-col-reverse sm:flex-row gap-x-4 gap-y-1 p-1",children:[y,v]}),e[25]=y,e[26]=v,e[27]=T):T=e[27];const m=!l;let p;e[28]!==c?(p=c("offerTrades"),e[28]=c,e[29]=p):p=e[29];let h;e[30]!==o||e[31]!==p||e[32]!==m?(h=s.jsx($,{className:"block w-full sm:w-96 mx-auto mt-1 text-center",variant:"outline",onClick:o,disabled:m,children:p}),e[30]=o,e[31]=p,e[32]=m,e[33]=h):h=e[33];let j;return e[34]!==h||e[35]!==T?(j=s.jsxs("div",{className:"sticky top-0 z-10 bg-neutral-900 rounded-lg border-1 border-neutral-700 border-solid p-1",children:[T,h]}),e[34]=h,e[35]=T,e[36]=j):j=e[36],j},Ct=t=>{const e=P.c(30),{row:r,selectedTradeId:a,setSelectedTradeId:i}=t,{t:d}=F("trade-matches"),{data:n,isLoading:g}=q();if(g)return null;if(!n){let h;e[0]!==d?(h=d("common:error"),e[0]=d,e[1]=h):h=e[1];let j;return e[2]!==h?(j=s.jsx("p",{className:"text-xl text-center py-8",children:h}),e[2]=h,e[3]=j):j=e[3],j}const c=r.offering_friend_id===n.friend_id?r.offer_card_id:r.receiver_card_id,u=r.offering_friend_id===n.friend_id?r.receiver_card_id:r.offer_card_id;let x;e[4]!==a||e[5]!==i?(x=function(j){a===j.id?i(void 0):i(j.id)},e[4]=a,e[5]=i,e[6]=x):x=e[6];const l=x;let f;e[7]!==n.friend_id||e[8]!==d?(f=h=>{const j={offered:h.offering_friend_id===n.friend_id?s.jsx(lt,{className:"bg-amber-600"}):s.jsx(_t,{className:"bg-amber-600"}),accepted:s.jsx(gt,{className:"bg-lime-600"}),declined:s.jsx(Pe,{className:"bg-stone-600"}),finished:s.jsx(Ee,{className:"bg-indigo-600"})};return s.jsxs(s.Fragment,{children:[s.jsx(X,{id:`status-${h.id}`}),s.jsx(nt,{className:"rounded-full p-[3px] my-auto","data-tooltip-id":`status-${h.id}`,"data-tooltip-content":d(`status.${h.status}`),children:j[h.status]})]})},e[7]=n.friend_id,e[8]=d,e[9]=f):f=e[9];const o=f,_=`flex cursor-pointer rounded gap-1 md:gap-2 p-1 ${a===r.id&&"bg-green-900"} hover:bg-neutral-500`;let b;e[10]!==l||e[11]!==r?(b=()=>l(r),e[10]=l,e[11]=r,e[12]=b):b=e[12];let y;e[13]!==r||e[14]!==o?(y=o(r),e[13]=r,e[14]=o,e[15]=y):y=e[15];let S;e[16]===Symbol.for("react.memo_cache_sentinel")?(S=s.jsx(Ae,{}),e[16]=S):S=e[16];let N;e[17]!==c?(N=s.jsxs("div",{className:"flex flex-1",children:[S,s.jsx(D,{className:"flex-1",card_id:c,increment:-1})]}),e[17]=c,e[18]=N):N=e[18];let v;e[19]===Symbol.for("react.memo_cache_sentinel")?(v=s.jsx($e,{}),e[19]=v):v=e[19];let T;e[20]!==u?(T=s.jsxs("div",{className:"flex flex-1",children:[v,s.jsx(D,{className:"flex-1",card_id:u,increment:1})]}),e[20]=u,e[21]=T):T=e[21];let m;e[22]!==N||e[23]!==T?(m=s.jsxs("div",{className:"flex flex-col-reverse md:flex-row grow-1 justify-between gap-1 md:gap-2",children:[N,T]}),e[22]=N,e[23]=T,e[24]=m):m=e[24];let p;return e[25]!==m||e[26]!==_||e[27]!==b||e[28]!==y?(p=s.jsxs("li",{className:_,onClick:b,children:[y,m]}),e[25]=m,e[26]=_,e[27]=b,e[28]=y,e[29]=p):p=e[29],p};function wt(t){const e=P.c(78),{trade:r,setSelected:a}=t,{t:i}=F("trade-matches"),{toast:d}=le(),{data:n,isLoading:g}=q(),{data:c,isLoading:u}=je(),x=Me(),l=ze();if(g||u)return null;if(!n||!c)throw new Error("Cannot deduce trade actions: not logged in");let f;e[0]!==c?(f=(m,p)=>{const h=He(m);return{card_id:m,internal_id:h,amount_owned:(c.get(h)?.amount_owned??0)+p}},e[0]=c,e[1]=f):f=e[1];const o=f;let _;e[2]!==n.friend_id||e[3]!==a||e[4]!==r.id||e[5]!==r.offering_friend_id||e[6]!==r.receiving_friend_id||e[7]!==l?(_=async()=>{const m=r.offering_friend_id===n.friend_id?{offerer_ended:!0}:r.receiving_friend_id===n.friend_id?{receiver_ended:!0}:null;if(m===null)throw new Error("Error hiding trade: cannot match your friend id");await l.mutateAsync({id:r.id,trade:m}),a(void 0),ae("Updated trade: ended")},e[2]=n.friend_id,e[3]=a,e[4]=r.id,e[5]=r.offering_friend_id,e[6]=r.receiving_friend_id,e[7]=l,e[8]=_):_=e[8];const b=_;let y;e[9]!==n.friend_id||e[10]!==b||e[11]!==o||e[12]!==i||e[13]!==d||e[14]!==r.offer_card_id||e[15]!==r.offering_friend_id||e[16]!==r.receiver_card_id||e[17]!==r.receiving_friend_id||e[18]!==x?(y=async()=>{if(r.offer_card_id===r.receiver_card_id)return;const m=r.offering_friend_id===n.friend_id?[o(r.offer_card_id,-1),o(r.receiver_card_id,1)]:r.receiving_friend_id===n.friend_id?[o(r.offer_card_id,1),o(r.receiver_card_id,-1)]:null;if(m===null)throw new Error("Error updating collection: cannot match your friend id");await x.mutateAsync(m),await b(),d({title:i("collectionUpdated"),variant:"default"})},e[9]=n.friend_id,e[10]=b,e[11]=o,e[12]=i,e[13]=d,e[14]=r.offer_card_id,e[15]=r.offering_friend_id,e[16]=r.receiver_card_id,e[17]=r.receiving_friend_id,e[18]=x,e[19]=y):y=e[19];const S=y;let N;e[20]!==a||e[21]!==r.id||e[22]!==l?(N=async m=>{l.mutate({id:r.id,trade:{status:m}}),a(r.id),ae(`Updated trade: ${m}`)},e[20]=a,e[21]=r.id,e[22]=l,e[23]=N):N=e[23];const v=N,T=r.offering_friend_id===n.friend_id&&r.offerer_ended||r.receiving_friend_id===n.friend_id&&r.receiver_ended;switch(r.status){case"offered":{let m;e[24]!==n.friend_id||e[25]!==i||e[26]!==r.receiving_friend_id||e[27]!==v?(m=r.receiving_friend_id===n.friend_id&&s.jsx($,{onClick:()=>v("accepted"),children:i("actionAccept")}),e[24]=n.friend_id,e[25]=i,e[26]=r.receiving_friend_id,e[27]=v,e[28]=m):m=e[28];let p;e[29]!==v?(p=()=>v("declined"),e[29]=v,e[30]=p):p=e[30];let h;e[31]!==n.friend_id||e[32]!==i||e[33]!==r.receiving_friend_id?(h=r.receiving_friend_id===n.friend_id?i("actionDecline"):i("actionCancel"),e[31]=n.friend_id,e[32]=i,e[33]=r.receiving_friend_id,e[34]=h):h=e[34];let j;e[35]!==p||e[36]!==h?(j=s.jsx($,{onClick:p,children:h}),e[35]=p,e[36]=h,e[37]=j):j=e[37];let C;return e[38]!==m||e[39]!==j?(C=s.jsxs(s.Fragment,{children:[m,j]}),e[38]=m,e[39]=j,e[40]=C):C=e[40],C}case"accepted":{let m;e[41]!==v?(m=()=>v("finished"),e[41]=v,e[42]=m):m=e[42];let p;e[43]!==i?(p=i("actionComplete"),e[43]=i,e[44]=p):p=e[44];let h;e[45]!==m||e[46]!==p?(h=s.jsx($,{onClick:m,children:p}),e[45]=m,e[46]=p,e[47]=h):h=e[47];let j;e[48]!==v?(j=()=>v("declined"),e[48]=v,e[49]=j):j=e[49];let C;e[50]!==i?(C=i("actionCancel"),e[50]=i,e[51]=C):C=e[51];let k;e[52]!==j||e[53]!==C?(k=s.jsx($,{onClick:j,children:C}),e[52]=j,e[53]=C,e[54]=k):k=e[54];let A;return e[55]!==k||e[56]!==h?(A=s.jsxs(s.Fragment,{children:[h,k]}),e[55]=k,e[56]=h,e[57]=A):A=e[57],A}case"declined":{if(T)return null;let m;e[58]!==i?(m=i("actionHide"),e[58]=i,e[59]=m):m=e[59];let p;return e[60]!==b||e[61]!==m?(p=s.jsx($,{onClick:b,children:m}),e[60]=b,e[61]=m,e[62]=p):p=e[62],p}case"finished":{if(T)return null;let m;e[63]!==S?(m=()=>S(),e[63]=S,e[64]=m):m=e[64];let p;e[65]!==i?(p=i("actionUpdate"),e[65]=i,e[66]=p):p=e[66];let h;e[67]!==m||e[68]!==p?(h=s.jsx($,{onClick:m,children:p}),e[67]=m,e[68]=p,e[69]=h):h=e[69];let j;e[70]!==i?(j=i("actionHide"),e[70]=i,e[71]=j):j=e[71];let C;e[72]!==b||e[73]!==j?(C=s.jsx($,{onClick:b,children:j}),e[72]=b,e[73]=j,e[74]=C):C=e[74];let k;return e[75]!==h||e[76]!==C?(k=s.jsxs(s.Fragment,{children:[h,C]}),e[75]=h,e[76]=C,e[77]=k):k=e[77],k}default:return console.log(`Unknown trade status ${r.status}`),null}}function ne(t){const e=P.c(18),{children:r,trades:a}=t,[i,d]=I.useState(void 0);let n;if(e[0]!==i||e[1]!==a){let f;e[3]!==i?(f=o=>o.id===i,e[3]=i,e[4]=f):f=e[4],n=a.find(f),e[0]=i,e[1]=a,e[2]=n}else n=e[2];const g=n;if(a.length===0)return null;let c;if(e[5]!==i||e[6]!==a){let f;e[8]!==i?(f=o=>s.jsx(Ct,{row:o,selectedTradeId:i,setSelectedTradeId:d},o.id),e[8]=i,e[9]=f):f=e[9],c=a.toSorted(Tt).map(f),e[5]=i,e[6]=a,e[7]=c}else c=e[7];let u;e[10]!==c?(u=s.jsx("ul",{className:"flex flex-col gap-2 md:gap-0",children:c}),e[10]=c,e[11]=u):u=e[11];let x;e[12]!==g?(x=g&&s.jsx("div",{className:"flex gap-2 text-center items-center mt-2",children:s.jsx(wt,{trade:g,setSelected:d})}),e[12]=g,e[13]=x):x=e[13];let l;return e[14]!==r||e[15]!==u||e[16]!==x?(l=s.jsxs("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-1 md:p-2",children:[u,r,x]}),e[14]=r,e[15]=u,e[16]=x,e[17]=l):l=e[17],l}function Tt(t,e){return t.created_at>e.created_at?-1:1}function ge(t,e){const r=new Set(e),a=t.filter(i=>r.has(i)).map(i=>V(i)).filter(i=>J.includes(i.rarity)&&Ue.includes(i.expansion));return Object.groupBy(a,i=>i.rarity)}function St(){const{t}=F(["trade-matches","common"]),{friendId:e}=Je(),[r]=we(),{data:a,isLoading:i,isError:d}=be(e),{data:n=new Map,isLoading:g,isError:c}=Re(e),{data:u}=q(),{data:x=new Map}=je(),{data:l=[]}=ve(),f=Oe(),{toast:o}=le(),{openChat:_}=ye(),[b,y]=I.useState(!1),[S,N]=I.useState(0),v=Ne(a?.friend_id,b,S,!0),[T,m]=I.useState(null),[p,h]=I.useState(()=>{const w=r.get("friend_card");return w?V(Number(w))??null:null});if(I.useEffect(()=>{const w=r.get("friend_card");if(!w||!n||!x)return;const M=V(Number(w));if(!M)return;const E=document.getElementById(M.rarity);E&&E.scrollIntoView({behavior:"smooth"})},[r,n,x]),!u)return null;if(a===null)return s.jsx("p",{className:"text-xl text-center py-8",children:t("notFound")});if(d||c)return s.jsx("p",{className:"text-xl text-center py-8",children:t("common:error")});if(i||g)return s.jsx(G,{size:"lg",overlay:!0});if(!a?.is_active_trading)return s.jsxs("div",{className:"text-center py-8",children:[s.jsx("p",{className:"text-xl ",children:t("inActiveTradePage",{username:a?.username})}),s.jsx("p",{className:"text-sm text-gray-300 mt-2",children:t("inActiveTradeDescription")})]});const j=ge(fe(x,u.trade_rarity_settings||[]),oe(n,a.trade_rarity_settings||[])),C=ge(fe(n,a.trade_rarity_settings||[]),oe(x,u.trade_rarity_settings||[])),k=J.some(w=>(j[w]??[]).length>0&&(C[w]??[]).length>0),A=l.some(w=>w.friend_id===a.friend_id),L=()=>{f.mutate({friend_id:a.friend_id,action:"send_request"},{onSuccess:()=>o({title:"Friend request sent!"}),onError:w=>o({variant:"destructive",title:"Error",description:w.message})})};return s.jsxs("div",{className:"flex flex-col gap-4 w-full px-1 sm:px-2",children:[s.jsx("title",{children:`Trade with ${a.username} – TCG Pocket Collection Tracker`}),s.jsxs("div",{className:"mx-1 flex justify-between",children:[s.jsxs("h1",{children:[s.jsx("span",{className:"text-2xl font-light",children:t("tradingWith")}),s.jsxs("span",{className:"text-2xl font-bold",children:[" ",a.username," "]}),s.jsx("span",{className:"block sm:inline text-sm",children:s.jsx(Se,{friendId:a.friend_id,onChat:A?()=>_(a.friend_id,a.username||a.friend_id):void 0})})]}),s.jsxs("div",{className:"flex flex-col-reverse sm:flex-row gap-2",children:[s.jsxs("label",{htmlFor:`history-${e}`,className:"my-auto flex items-center",children:[t("viewHistory"),s.jsx(ce,{id:`history-${e}`,className:"ml-2 my-auto",checked:b,onCheckedChange:w=>{y(w),N(0)}})]}),!A&&s.jsxs($,{onClick:L,disabled:f.isPending,children:[s.jsx(dt,{className:"h-4 w-4 mr-1"}),"Add Friend"]}),s.jsx(de,{to:`/collection/${e}`,children:s.jsxs($,{children:["Collection",s.jsx(W,{})]})})]})]}),v.isLoading?s.jsx(G,{size:"md"}):v.data&&s.jsx(ne,{trades:v.data.trades,children:s.jsxs("div",{className:"flex justify-between mt-2",children:[s.jsxs("span",{className:"text-neutral-400",children:[v.data.count," total offers"]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("span",{children:["Page ",S+1]}),s.jsx($,{variant:"outline",onClick:()=>N(()=>0),disabled:S<=0,children:s.jsx(ke,{})}),s.jsx($,{variant:"outline",onClick:()=>N(w=>w-1),disabled:S<=0,children:s.jsx(Ce,{})}),s.jsx($,{variant:"outline",onClick:()=>N(w=>w+1),disabled:!v.data.hasNext,children:s.jsx(W,{})})]})]})}),s.jsx(Nt,{yourId:u.friend_id,friendId:a.friend_id,yourCard:T,friendCard:p,setYourCard:m,setFriendCard:h}),!k&&s.jsxs("div",{className:"text-center py-8",children:[s.jsx("p",{className:"text-xl ",children:t("noPossibleTrades")}),s.jsx("p",{className:"text-sm text-gray-300 mt-2",children:t("noPossibleTradesDescription")})]}),J.map(w=>s.jsxs("div",{children:[s.jsxs("h3",{id:w,className:"text-xl font-semibold mb-2 text-center",children:["[ ",w," ]"]}),s.jsxs("div",{className:"flex flex-col-reverse sm:flex-row gap-2 sm:gap-4",children:[s.jsxs("div",{className:"w-full sm:w-1/2",children:[s.jsx("h4",{className:"text-md font-medium mb-1 ml-2 text-neutral-400",children:t("youHave")}),j[w]?s.jsx(_e,{cards:j[w],selected:T,setSelected:m}):s.jsx("div",{className:"text-center text-neutral-500 rounded-lg border-1 border-neutral-700 border-solid p-2",children:"No cards to trade"})]}),s.jsxs("div",{className:"w-full sm:w-1/2",children:[s.jsx("h4",{className:"text-md font-medium mb-1 ml-2 text-neutral-400",children:t("friendHas")}),C[w]?s.jsx(_e,{cards:C[w],selected:p,setSelected:h}):s.jsx("div",{className:"text-center text-neutral-500  rounded-lg border-1 border-neutral-700 border-solid p-2",children:"No cards to trade"})]})]})]},w))]})}function kt(){const{t}=F(["trade-matches","common"]),e=Te(),r=I.useRef(null),[a,i]=I.useState(""),[d,n]=I.useState(),g=ot({search:a,rarity:[...J]},new Map),c=d&&V(d),u=Fe({getScrollElement:()=>r.current,count:g.length,getItemKey:x=>g[x].card_id,estimateSize:()=>32});if(d&&!c)throw new Error("Selected card was not found in the database");return s.jsxs("div",{className:"sm:w-sm mx-auto",children:[s.jsx(ct,{setValue:i}),s.jsx("div",{ref:r,className:"my-2 h-96 rounded border border-neutral-700 px-1 overflow-y-auto",children:s.jsx("ul",{style:{height:`${u.getTotalSize()}px`},className:"relative",children:u.getVirtualItems().map(x=>{const l=g[x.index];return s.jsx("button",{type:"button",className:"absolute top-0 left-0 w-full cursor-pointer",style:{height:`${x.size}px`,transform:`translateY(${x.start}px)`},onClick:()=>n(f=>f===l.internal_id?void 0:l.internal_id),children:s.jsx(D,{className:`w-full ${d===l.internal_id&&"bg-green-900"} hover:bg-neutral-600`,card_id:l.card_id})},x.key)})})}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx($,{className:"w-1/2",disabled:!d,onClick:()=>e(`/trade/matches/results?card_id=${d}`),children:c?t("search.byCard",{cardName:Be(c,at.language)}):t("search.selectCard")}),s.jsx($,{className:"w-1/2",onClick:()=>e("/trade/matches/results"),children:t("search.allCards")})]})]})}function $t(){const t=P.c(25);let e;t[0]===Symbol.for("react.memo_cache_sentinel")?(e=["trade-matches","common"],t[0]=e):e=t[0];const{t:r}=F(e),[a]=we();let i;t[1]!==a?(i=a.has("card_id")?Number(a.get("card_id")):void 0,t[1]=a,t[2]=i):i=t[2];const d=i,{data:n,isLoading:g}=De(d);if(d!==void 0&&V(d)===void 0)throw new Error("Requested card was not found in the database");if(g){let l;t[3]!==r?(l=r("common:loading"),t[3]=r,t[4]=l):l=t[4];let f;t[5]===Symbol.for("react.memo_cache_sentinel")?(f=s.jsx("br",{}),t[5]=f):f=t[5];let o;t[6]!==r?(o=r("longOperation"),t[6]=r,t[7]=o):o=t[7];let _;return t[8]!==l||t[9]!==o?(_=s.jsxs("p",{className:"text-xl text-center py-8",children:[l,f,o]}),t[8]=l,t[9]=o,t[10]=_):_=t[10],_}if(!n){let l;return t[11]===Symbol.for("react.memo_cache_sentinel")?(l=s.jsx(Ve,{}),t[11]=l):l=t[11],l}if(n.length===0){let l;t[12]!==r?(l=r("noTradePartners"),t[12]=r,t[13]=l):l=t[13];let f;return t[14]!==l?(f=s.jsx("p",{className:"text-xl text-center py-8",children:l}),t[14]=l,t[15]=f):f=t[15],f}const c=d?`?friend_card=${d}`:"";let u;if(t[16]!==n||t[17]!==c||t[18]!==r){let l;t[20]!==c||t[21]!==r?(l=f=>s.jsxs("div",{className:"max-w-md w-full flex justify-between items-center mx-auto px-4",children:[s.jsx("p",{className:"mr-2",children:f.username}),s.jsx(de,{to:`/trade/${f.friend_id}${c}`,children:s.jsxs($,{variant:"outline",className:"my-auto",children:[r("viewTradePartner",{tradeMatches:f.trade_matches}),s.jsx(W,{})]})})]},f.friend_id),t[20]=c,t[21]=r,t[22]=l):l=t[22],u=n.map(l),t[16]=n,t[17]=c,t[18]=r,t[19]=u}else u=t[19];let x;return t[23]!==u?(x=s.jsx("div",{className:"flex flex-col gap-4",children:u}),t[23]=u,t[24]=x):x=t[24],x}function At(t){const e=P.c(53),{friendId:r,activeTrades:a}=t;let i;e[0]===Symbol.for("react.memo_cache_sentinel")?(i=["trade-matches","common"],e[0]=i):i=e[0];const{t:d}=F(i),{data:n,isLoading:g}=be(r),{data:c}=ve();let u;e[1]!==c?(u=c===void 0?[]:c,e[1]=c,e[2]=u):u=e[2];const x=u,{openChat:l}=ye();let f;if(e[3]!==r||e[4]!==x){let Y;e[6]!==r?(Y=Ie=>Ie.friend_id===r,e[6]=r,e[7]=Y):Y=e[7],f=x.some(Y),e[3]=r,e[4]=x,e[5]=f}else f=e[5];const o=f,[_,b]=I.useState(!1),[y,S]=I.useState(0),N=Ne(r,_,y,_);if(g)return null;let v;e[8]!==d?(v=d("tradingWith"),e[8]=d,e[9]=v):v=e[9];let T;e[10]!==v?(T=s.jsx("span",{className:"text-md",children:v}),e[10]=v,e[11]=T):T=e[11];const m=n?.username||"unknown";let p;e[12]!==m?(p=s.jsxs("span",{className:"text-md font-bold",children:[" ",m," "]}),e[12]=m,e[13]=p):p=e[13];let h;e[14]!==n||e[15]!==o||e[16]!==l?(h=n&&s.jsx(Se,{friendId:n.friend_id,showFriendId:!1,className:"ml-1",onChat:o?()=>l(n.friend_id,n.username||n.friend_id):void 0}),e[14]=n,e[15]=o,e[16]=l,e[17]=h):h=e[17];let j;e[18]!==T||e[19]!==p||e[20]!==h?(j=s.jsxs("p",{children:[T,p,h]}),e[18]=T,e[19]=p,e[20]=h,e[21]=j):j=e[21];const C=`history-${r}`;let k;e[22]!==d?(k=d("viewHistory"),e[22]=d,e[23]=k):k=e[23];const A=`history-${r}`;let L;e[24]!==A||e[25]!==_?(L=s.jsx(ce,{id:A,className:"ml-2 my-auto",checked:_,onCheckedChange:b}),e[24]=A,e[25]=_,e[26]=L):L=e[26];let w;e[27]!==C||e[28]!==k||e[29]!==L?(w=s.jsxs("label",{htmlFor:C,className:"my-auto flex items-center",children:[k,L]}),e[27]=C,e[28]=k,e[29]=L,e[30]=w):w=e[30];const M=`/trade/${r}`;let E;e[31]!==d?(E=d("openTradeWith"),e[31]=d,e[32]=E):E=e[32];let K;e[33]===Symbol.for("react.memo_cache_sentinel")?(K=s.jsx(W,{}),e[33]=K):K=e[33];let z;e[34]!==E?(z=s.jsxs($,{variant:"outline",className:"my-auto",children:[E,K]}),e[34]=E,e[35]=z):z=e[35];let H;e[36]!==M||e[37]!==z?(H=s.jsx(de,{to:M,children:z}),e[36]=M,e[37]=z,e[38]=H):H=e[38];let R;e[39]!==w||e[40]!==H?(R=s.jsxs("span",{className:"flex gap-4",children:[w,H]}),e[39]=w,e[40]=H,e[41]=R):R=e[41];let O;e[42]!==j||e[43]!==R?(O=s.jsxs("div",{className:"flex justify-between items-center mb-1 mx-1",children:[j,R]}),e[42]=j,e[43]=R,e[44]=O):O=e[44];let U;e[45]!==a||e[46]!==N||e[47]!==y||e[48]!==_?(U=_?N.isLoading?s.jsx(G,{size:"md"}):N.data&&s.jsx(ne,{trades:N.data.trades,children:s.jsxs("p",{className:"flex justify-between mt-2",children:[s.jsxs("span",{className:"text-neutral-400",children:[N.data.count," total offers"]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("span",{children:["Page ",y+1]}),s.jsx($,{variant:"outline",onClick:()=>S(Lt),disabled:y<=0,children:s.jsx(ke,{})}),s.jsx($,{variant:"outline",onClick:()=>S(Ft),disabled:y<=0,children:s.jsx(Ce,{})}),s.jsx($,{variant:"outline",onClick:()=>S(It),disabled:!N.data.hasNext,children:s.jsx(W,{})})]})]})}):s.jsx(ne,{trades:a}),e[45]=a,e[46]=N,e[47]=y,e[48]=_,e[49]=U):U=e[49];let Q;return e[50]!==O||e[51]!==U?(Q=s.jsxs("div",{className:"w-full",children:[O,U]}),e[50]=O,e[51]=U,e[52]=Q):Q=e[52],Q}function It(t){return t+1}function Ft(t){return t-1}function Lt(){return 0}function Et(){const t=P.c(25);let e;t[0]===Symbol.for("react.memo_cache_sentinel")?(e=["trade-matches","common"],t[0]=e):e=t[0];const{t:r}=F(e),{data:a,isLoading:i}=q(),{data:d,isLoading:n}=We();if(i||n){let o;return t[1]===Symbol.for("react.memo_cache_sentinel")?(o=s.jsx(G,{size:"lg",overlay:!0}),t[1]=o):o=t[1],o}if(!d||!a){let o;t[2]!==r?(o=r("common:error"),t[2]=r,t[3]=o):o=t[3];let _;return t[4]!==o?(_=s.jsx("p",{className:"text-xl text-center py-8",children:o}),t[4]=o,t[5]=_):_=t[5],_}if(d.length===0){let o;t[6]!==r?(o=r("noTradeOffers"),t[6]=r,t[7]=o):o=t[7];let _;return t[8]!==o?(_=s.jsx("p",{children:o}),t[8]=o,t[9]=_):_=t[9],_}let g,c;t[10]!==a.friend_id||t[11]!==d?(g=zt(d,a.friend_id),c=Object.fromEntries(Object.entries(g).map(Pt)),t[10]=a.friend_id,t[11]=d,t[12]=g,t[13]=c):(g=t[12],c=t[13]);const u=c;let x,l;if(t[14]!==g||t[15]!==u){let o;t[18]!==u?(o=(y,S)=>u[S]-u[y],t[18]=u,t[19]=o):o=t[19];const _=Object.keys(g).toSorted(o);x="flex flex-col items-center mx-auto gap-6 sm:px-4 mb-12 w-full";let b;t[20]!==g?(b=y=>s.jsx(At,{friendId:y,activeTrades:g[y]},y),t[20]=g,t[21]=b):b=t[21],l=_.map(b),t[14]=g,t[15]=u,t[16]=x,t[17]=l}else x=t[16],l=t[17];let f;return t[22]!==x||t[23]!==l?(f=s.jsx("div",{className:x,children:l}),t[22]=x,t[23]=l,t[24]=f):f=t[24],f}function Pt(t){const[e,r]=t;return[e,Math.max(...r.map(Mt))]}function Mt(t){return new Date(t.updated_at).getTime()}function zt(t,e){return Object.groupBy(t,r=>r.offering_friend_id===e?r.receiving_friend_id:r.receiving_friend_id===e?r.offering_friend_id:(console.log("Fetched row does not match user friend_id",r),"undefined"))}function Ht(){const{t}=F("trade-matches"),{data:e}=q(),r=qe(),a=me({is_active_trading:Qe(),trade_rarity_settings:Ke(me({rarity:Ye(Xe),to_collect:he().min(0).max(100),to_keep:he().min(0).max(100)}))}),i=ft({resolver:mt(a),values:{is_active_trading:e?.is_active_trading||!1,trade_rarity_settings:e?.trade_rarity_settings||[]}}),d=async n=>{r.mutate({username:e?.username,is_active_trading:n.is_active_trading,trade_rarity_settings:n.trade_rarity_settings},{onSuccess:()=>xe({title:t("accountSaved"),variant:"default"}),onError:g=>{console.error("error saving account",g),xe({title:t("errorSavingAccount"),variant:"destructive"})}})};return!e||!e.username?s.jsx(Ge,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:t("noAccount")}):s.jsxs("div",{children:[s.jsx(ut,{...i,children:s.jsxs("form",{onSubmit:i.handleSubmit(d),className:"rounded-md border-1 border-neutral-700 space-y-2 p-4 mx-auto max-w-xl",children:[s.jsx("h2",{className:"text-xl text-center mb-6",children:t("settingsTitle")}),s.jsx(se,{control:i.control,name:"is_active_trading",render:({field:n})=>s.jsx(re,{className:"flex flex-col items-start",children:s.jsx(ie,{children:s.jsxs(xt,{className:"flex",children:[t("isActiveTrading"),s.jsx(ce,{className:"ml-2",checked:n.value,onCheckedChange:n.onChange,disabled:!e?.is_public,"data-tooltip-id":"is-active-trading-disabled","data-tooltip-content":e?.is_public?void 0:t("isActiveTradingDisabledTooltip")}),!e?.is_public&&s.jsxs(s.Fragment,{children:[s.jsx(X,{id:"is-active-trading-disabled"}),s.jsx(te,{className:"size-4 ml-1","data-tooltip-id":"is-active-trading-disabled","data-tooltip-content":t("isActiveTradingDisabledTooltip")})]})]})})})}),s.jsxs("div",{className:"grid grid-cols-3 gap-y-2 gap-x-8 w-fit mt-6",children:[s.jsx("span",{children:t("rarity")}),s.jsxs("span",{className:"flex items-center",children:[t("toCollect"),s.jsx(X,{id:"to-collect"}),s.jsx(te,{className:"size-4 ml-1","data-tooltip-id":"to-collect","data-tooltip-content":t("toCollectTooltip")})]}),s.jsxs("span",{className:"flex items-center",children:[t("toKeep"),s.jsx(X,{id:"to-collect"}),s.jsx(te,{className:"size-4 ml-1","data-tooltip-id":"to-collect","data-tooltip-content":t("toKeepTooltip")})]}),i.watch("trade_rarity_settings").map((n,g)=>s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"flex-1",children:n.rarity},`label-${n.rarity}`),s.jsx(se,{control:i.control,name:`trade_rarity_settings.${g}.to_collect`,render:({field:c})=>s.jsx(re,{className:"flex-1",children:s.jsx(ie,{children:s.jsx(ue,{className:"w-24",type:"number",...c})})})},`to-collect-${n.rarity}`),s.jsx(se,{control:i.control,name:`trade_rarity_settings.${g}.to_keep`,render:({field:c})=>s.jsx(re,{className:"flex-1",children:s.jsx(ie,{children:s.jsx(ue,{className:"w-24",type:"number",...c})})})},`to-keep-${n.rarity}`)]}))]}),s.jsx($,{type:"submit",className:"block ml-auto flex gap-2",disabled:r.isPending,isPending:r.isPending,children:t("save")})]})}),s.jsx(it,{className:"mt-4 mx-auto w-fit"})]})}function is(){const t=P.c(34),{t:e}=F("trade-matches"),r=Ze(),a=Te();let i;t[0]!==r.pathname?(i=r.pathname.split("/").pop()||"offers",t[0]=r.pathname,t[1]=i):i=t[1];const d=i;let n,g;t[2]!==r.pathname||t[3]!==a?(n=()=>{r.pathname==="/trade"&&a("/trade/offers")},g=[r.pathname,a],t[2]=r.pathname,t[3]=a,t[4]=n,t[5]=g):(n=t[4],g=t[5]),I.useEffect(n,g);let c;t[6]!==a?(c=h=>a(`/trade/${h}`),t[6]=a,t[7]=c):c=t[7];let u;t[8]!==e?(u=e("tabOffers"),t[8]=e,t[9]=u):u=t[9];let x;t[10]!==u?(x=s.jsx(ee,{className:"text-md",value:"offers",children:u}),t[10]=u,t[11]=x):x=t[11];let l;t[12]!==e?(l=e("tabMatches"),t[12]=e,t[13]=l):l=t[13];let f;t[14]!==l?(f=s.jsx(ee,{className:"text-md",value:"matches",children:l}),t[14]=l,t[15]=f):f=t[15];let o;t[16]!==e?(o=e("tabSettings"),t[16]=e,t[17]=o):o=t[17];let _;t[18]!==o?(_=s.jsx(ee,{className:"text-md",value:"settings",children:o}),t[18]=o,t[19]=_):_=t[19];let b;t[20]!==x||t[21]!==f||t[22]!==_?(b=s.jsxs(st,{className:"gap-4 mb-6 rounded-lg border-b-1 border-neutral-700 border-solid dark:bg-transparent pb-2",children:[x,f,_]}),t[20]=x,t[21]=f,t[22]=_,t[23]=b):b=t[23];let y;t[24]===Symbol.for("react.memo_cache_sentinel")?(y=s.jsx(B,{path:"/",element:s.jsx(et,{to:"/trade/offers",replace:!0})}),t[24]=y):y=t[24];let S;t[25]===Symbol.for("react.memo_cache_sentinel")?(S=s.jsx(B,{path:"offers",element:s.jsx(Et,{})}),t[25]=S):S=t[25];let N;t[26]===Symbol.for("react.memo_cache_sentinel")?(N=s.jsx(B,{path:"matches",element:s.jsx(kt,{})}),t[26]=N):N=t[26];let v;t[27]===Symbol.for("react.memo_cache_sentinel")?(v=s.jsx(B,{path:"matches/results",element:s.jsx($t,{})}),t[27]=v):v=t[27];let T;t[28]===Symbol.for("react.memo_cache_sentinel")?(T=s.jsx(B,{path:"settings",element:s.jsx(Ht,{})}),t[28]=T):T=t[28];let m;t[29]===Symbol.for("react.memo_cache_sentinel")?(m=s.jsxs(tt,{children:[y,S,N,v,T,s.jsx(B,{path:":friendId",element:s.jsx(St,{})})]}),t[29]=m):m=t[29];let p;return t[30]!==d||t[31]!==b||t[32]!==c?(p=s.jsxs(rt,{className:"flex flex-col mx-auto max-w-[900px]",value:d,onValueChange:c,children:[b,m]}),t[30]=d,t[31]=b,t[32]=c,t[33]=p):p=t[33],p}export{is as default};
