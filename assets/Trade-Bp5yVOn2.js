import{$ as ae,a0 as te,u as b,j as e,a1 as re,a2 as $,n as B,r as g,a3 as se,a4 as ne,B as j,N as Y,a5 as W,v as ie,a6 as de,x as ce,W as oe,a7 as Z,Y as le,a8 as me,a9 as ue,aa as fe,ab as xe,_ as z}from"./index-DLuvsuCK.js";import{T as q,a as J,b as F,c as S,C as G}from"./tabs-MaDZcEud.js";import{t as pe,N as Q,M as I,C as O}from"./index-D5CxpF4T.js";import{R as _e}from"./useWindowDimensionsHook-CS2spzNf.js";import{A as M,a as D,b as H}from"./alert-BFtyrTkz.js";import{S as K}from"./siren-DX1tyswQ.js";import{S as ee,u as he,a as ge,F as je,b as U,c as E,d as R,e as V,f as be,g as ve}from"./form-DGzW7Ohf.js";import"./Card-zqABxbW6.js";import"./FancyCard-XNRek-MG.js";import"./index-CN5USeAW.js";function X(a){return ae(te,a)}function Ne(){const{t:a}=b("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(M,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx(D,{children:a("noCardsNeeded.title")}),e.jsx(H,{children:a("noCardsNeeded.description")})]})})}function ye(){const{t:a}=b("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(M,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx(D,{children:a("noTradeableCards.title")}),e.jsx(H,{children:a("noTradeableCards.description")})]})})}function Ce(){const{t:a}=b("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(M,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx(D,{children:a("notLoggedIn.title")}),e.jsx(H,{children:a("notLoggedIn.description")})]})})}function Te(){const{t:a}=b("pages/trade"),{data:c}=re(),{data:n}=$(),{data:r=[]}=B(),[o,d]=g.useState([]),[s,f]=g.useState((n?.max_number_of_cards_wanted??1)-1),[_,x]=g.useState((n?.min_number_of_cards_to_keep??1)+1),[h,y]=g.useState("looking_for"),m=l=>o.length===0?!0:l.rarity!==""&&o.includes(l.rarity),p=l=>{const v=Y(l),L=r.find(N=>N.card_id===l)?.amount_owned??0;return{...v,amount_owned:L}},C=g.useMemo(()=>se(r,s+1).map(p),[r,s]),k=g.useMemo(()=>C.filter(m),[C,o]),t=g.useMemo(()=>ne(r,_-1).map(p),[r,_]),u=g.useMemo(()=>t.filter(m),[t,o]),T=()=>{let l="";n?.is_public&&(l+=`${a("publicTradePage")} https://tcgpocketcollectiontracker.com/#/trade/${n?.friend_id}
`),n?.username&&(l+=`${a("friendID")} ${n.friend_id} (${n.username})

`),l+=`${a("lookingForCards")}
`;const v=k.sort((i,w)=>{const P=i.expansion.localeCompare(w.expansion);return P!==0?P:i.rarity.localeCompare(w.rarity)});for(let i=0;i<v.length;i++)(i>0?v[i-1].expansion:"")!==v[i].expansion&&(l+=`
${v[i].set_details}:
`),l+=`${v[i].rarity} ${v[i].card_id} - ${v[i].name}
`;const L=k.map(i=>i.rarity);l+=`

${a("forTradeCards")}
`;const N=u.filter(i=>L.includes(i.rarity)).sort((i,w)=>i.rarity.localeCompare(w.rarity));for(let i=0;i<N.length;i++)(i>0?N[i-1].expansion:"")!==N[i].expansion&&(l+=`
${N[i].set_details}:
`),l+=`${N[i].rarity} ${N[i].card_id} - ${N[i].name}
`;return l},A=async()=>{const l=T();W({title:a("copiedInClipboard"),variant:"default",duration:3e3}),await navigator.clipboard.writeText(l)};return c?e.jsx("div",{className:"flex flex-col gap-y-4",children:e.jsxs(q,{defaultValue:h,onValueChange:y,children:[e.jsxs("div",{className:"mx-auto max-w-[900px] flex flex-row flex-wrap align-center gap-x-4 gap-y-2",children:[e.jsxs(J,{className:"flex-grow m-auto flex-wrap h-auto border-1 border-neutral-700 rounded-md",children:[e.jsx(F,{value:"looking_for",children:a("lookingFor")}),e.jsx(F,{value:"for_trade",children:a("forTrade")})]}),e.jsx(_e,{rarityFilter:o,setRarityFilter:d,rarities:pe}),e.jsxs("div",{className:"sm:mt-1 flex flex-row flex-wrap align-center gap-x-4 gap-y-1",children:[h==="looking_for"&&e.jsx(Q,{numberFilter:s,setNumberFilter:f,options:[0,1,2,3,4,5],labelKey:"maxNum"}),h==="for_trade"&&e.jsx(Q,{numberFilter:_,setNumberFilter:x,options:[2,3,4,5],labelKey:"minNum"}),e.jsx(j,{variant:"outline",onClick:A,children:"Copy to clipboard"})]})]}),e.jsxs("div",{className:"mx-auto max-w-[900px] mt-6",children:[e.jsx(S,{value:"looking_for",children:C?e.jsx(G,{cards:k,extraOffset:105,editable:!1}):e.jsx(Ne,{})}),e.jsx(S,{value:"for_trade",children:t?e.jsx(G,{cards:u,extraOffset:105,editable:!1}):e.jsx(ye,{})})]})]})}):e.jsx(Ce,{})}const ke=({row:a,selectedTradeId:c,setSelectedTradeId:n})=>{const{t:r,i18n:o}=b("trade-matches"),{data:d}=$(),{data:s=[]}=B();if(!d)return null;const f=a.offering_friend_id===d.friend_id?a.offer_card_id:a.receiver_card_id,_=a.offering_friend_id===d.friend_id?a.receiver_card_id:a.offer_card_id;function x(m){const p=Y(m);return p?e.jsxs("span",{className:"flex rounded px-1 w-1/2 bg-zinc-800",children:[e.jsxs("span",{className:"mr-2 sm:min-w-10",children:[p.rarity," "]}),e.jsxs("span",{className:"mr-2 sm:min-w-14 me-4",children:[p.card_id," "]}),e.jsx("span",{children:ie(p,o.language)}),e.jsxs("span",{className:"text-neutral-400 ml-auto",children:["×",s.find(C=>C.card_id===p.card_id)?.amount_owned||0]})]}):e.jsx("span",{className:"w-1/2 text-center",children:"?"})}function h(m){c===m.id?n(void 0):n(m.id)}const y=m=>{const p={offered:{icon:m.offering_friend_id===d.friend_id?"→":"←",color:"bg-amber-600"},accepted:{icon:"↔",color:"bg-lime-600"},declined:{icon:"X",color:"bg-stone-600"},finished:{icon:"✓",color:"bg-indigo-600"}};return e.jsxs(e.Fragment,{children:[e.jsx(I,{id:`tooltip-${m.id}`}),e.jsx("span",{className:`rounded-full text-center w-9 min-w-6 ${p[m.status].color}`,"data-tooltip-id":`tooltip-${m.id}`,"data-tooltip-content":r(`status.${m.status}`),children:p[m.status].icon})]})};return e.jsxs("li",{className:`flex cursor-pointer justify-between rounded gap-1 sm:gap-4 sm:px-1 py-1 my-1 ${c===a.id&&"bg-green-900"} hover:bg-neutral-500`,onClick:()=>h(a),children:[y(a),x(f),x(_)]})};function we({trades:a,update:c,viewHistory:n}){const{t:r}=b("trade-matches"),{toast:o}=de(),{data:d}=$(),{data:s=[]}=B(),f=ce();function _(t){return t.offering_friend_id===d?.friend_id&&!t.offerer_ended||t.receiving_friend_id===d?.friend_id&&!t.receiver_ended}const x=n?a.filter(t=>!_(t)):a.filter(_),[h,y]=g.useState(void 0);if(!d)return null;const m=(t,u)=>({card_id:t,amount_owned:(s.find(T=>T.card_id===t)?.amount_owned??0)+u}),p=async t=>{if(t.offer_card_id!==t.receiver_card_id)if(t.offering_friend_id===d.friend_id){const u=[m(t.offer_card_id,-1),m(t.receiver_card_id,1)];f.mutate({updates:u}),o({title:r("collectionUpdated"),variant:"default"})}else if(t.receiving_friend_id===d.friend_id){const u=[m(t.offer_card_id,1),m(t.receiver_card_id,-1)];f.mutate({updates:u}),o({title:r("collectionUpdated"),variant:"default"})}else console.log(t,"can't match friend id")},C=t=>{const u=async l=>{await c(t.id,{status:l}),y(t.id)},T=async()=>{const l=t.offering_friend_id===d.friend_id?{offerer_ended:!0}:t.receiving_friend_id===d.friend_id?{receiver_ended:!0}:null;if(l===null){console.log(t," doesn't match your friend_id");return}await c(t.id,l),y(void 0)},A=t.offering_friend_id===d.friend_id&&t.offerer_ended||t.receiving_friend_id===d.friend_id&&t.receiver_ended;switch(t.status){case"offered":return e.jsxs(e.Fragment,{children:[t.receiving_friend_id===d.friend_id&&e.jsx(j,{type:"button",onClick:async()=>u("accepted"),children:r("actionAccept")}),e.jsx(j,{type:"button",onClick:async()=>u("declined"),children:t.receiving_friend_id===d.friend_id?r("actionDecline"):r("actionCancel")})]});case"accepted":return e.jsxs(e.Fragment,{children:[e.jsx(j,{type:"button",onClick:async()=>u("finished"),children:r("actionComplete")}),e.jsx(j,{type:"button",onClick:async()=>u("declined"),children:r("actionCancel")})]});case"declined":return A?null:e.jsx(j,{type:"button",onClick:T,children:r("actionHide")});case"finished":return A?null:e.jsxs(e.Fragment,{children:[e.jsx(j,{type:"button",onClick:async()=>{await p(t),await T()},children:r("actionUpdate")}),e.jsx(j,{type:"button",onClick:T,children:r("actionHide")})]});default:return console.log(`Unknown trade status ${t.status}`),null}},k=x.find(t=>t.id===h);return x.length===0?e.jsx("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2 text-center",children:r("noActiveTrades")}):e.jsxs("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2",children:[e.jsxs("div",{className:"flex gap-4 px-1",children:[e.jsx("div",{className:"w-9"}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:r("youGive")}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:r("youReceive")})]}),e.jsx("ul",{children:x.toSorted((t,u)=>t.created_at>u.created_at?-1:1).map(t=>e.jsx(ke,{row:t,selectedTradeId:h,setSelectedTradeId:y},t.id))}),k&&e.jsx("div",{className:"flex gap-4 text-center items-center mt-2",children:C(k)})]})}function Fe({friendId:a}){const c=oe(),{t:n}=b("trade-matches"),{data:r}=Z(),{data:o}=le(a),d=me(),[s,f]=g.useState(!1);async function _(x,h){d.mutate({id:x,trade:h})}return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 mx-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-md",children:n("tradingWith")}),e.jsxs("span",{className:"text-md font-bold",children:[" ",o?.username||"loading"," "]})]}),e.jsxs("span",{className:"flex gap-4",children:[e.jsxs("label",{htmlFor:`history-${a}`,className:"my-auto flex items-center",children:[n("viewHistory"),e.jsx(ee,{id:`history-${a}`,className:"ml-2 my-auto",checked:s,onCheckedChange:f})]}),e.jsx(j,{className:"my-auto",onClick:()=>c(`/trade/${a}`),children:n("openTradeWith")})]})]}),o!==null&&r&&e.jsx(we,{trades:r.filter(x=>x.offering_friend_id===a||x.receiving_friend_id===a),update:_,viewHistory:s})]})}function Se(){const{t:a}=b("trade-matches"),{data:c}=$(),{data:n}=Z();if(!n||!c)return null;if(n.length===0)return e.jsx("p",{children:a("noTradeOffers")});const r=$e(n,c.friend_id),o=Object.fromEntries(Object.entries(r).map(([s,f])=>[s,Math.max(...f.map(_=>new Date(_.updated_at).getTime()))])),d=Object.keys(r).toSorted((s,f)=>o[f]-o[s]);return e.jsx("div",{className:"flex flex-col items-center mx-auto gap-12 sm:px-4 mb-12",children:d.map(s=>e.jsx(Fe,{friendId:s},s))})}function $e(a,c){return Object.groupBy(a,n=>n.offering_friend_id===c?n.receiving_friend_id:n.receiving_friend_id===c?n.offering_friend_id:(console.log("Fetched row does not match user friend_id",n),"undefined"))}function Ae(){const{t:a}=b("trade-matches"),{data:c}=$(),n=ue(),r=fe({is_active_trading:xe(),min_number_of_cards_to_keep:X().min(1).max(10),max_number_of_cards_wanted:X().min(1).max(10)}),o=he({resolver:ge(r),values:{is_active_trading:c?.is_active_trading||!1,min_number_of_cards_to_keep:c?.min_number_of_cards_to_keep||1,max_number_of_cards_wanted:c?.max_number_of_cards_wanted||1}}),d=async s=>{try{n.mutate({username:c?.username,is_active_trading:s.is_active_trading,min_number_of_cards_to_keep:s.min_number_of_cards_to_keep,max_number_of_cards_wanted:s.max_number_of_cards_wanted}),W({title:a("accountSaved"),variant:"default"})}catch(f){console.error("error saving account",f),W({title:a("errorSavingAccount"),variant:"destructive"})}};return!c||!c.username?e.jsx(M,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:a("noAccount")}):e.jsxs("div",{children:[e.jsx(je,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(d),className:"border-1 border-neutral-700 space-y-2 p-4 mx-auto",children:[e.jsx(U,{control:o.control,name:"is_active_trading",render:({field:s})=>e.jsx(E,{className:"flex flex-col items-start",children:e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(V,{className:"flex sm:w-72",children:a("isActiveTrading")}),e.jsx("div",{className:"grow-1",children:e.jsx(ee,{checked:s.value,onCheckedChange:s.onChange})}),e.jsx(be,{className:"grow",children:s.value?"active":"disabled"}),e.jsx(I,{id:"activeInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(O,{className:"h-4 w-4","data-tooltip-id":"activeInput","data-tooltip-content":a("activeTradingInputTooltip")})]})})})}),e.jsx(U,{control:o.control,name:"min_number_of_cards_to_keep",render:({field:s})=>e.jsx(E,{className:"flex flex-col items-start",children:e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(V,{className:"flex sm:w-72",children:a("minNumberOfCardsToKeep")}),e.jsx("div",{className:"grow-1",children:e.jsx(z,{className:"w-24",type:"number",...s})}),e.jsx(I,{id:"minInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(O,{className:"h-4 w-4","data-tooltip-id":"minInput","data-tooltip-content":a("minInputTooltip")})]})})})}),e.jsx(U,{control:o.control,name:"max_number_of_cards_wanted",render:({field:s})=>e.jsx(E,{className:"flex flex-col items-start",children:e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(V,{className:"flex sm:w-72",children:a("maxNumberOfCardsWanted")}),e.jsx("div",{className:"grow-1",children:e.jsx(z,{className:"w-24",type:"number",...s})}),e.jsx(I,{id:"maxInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(O,{className:"h-4 w-4","data-tooltip-id":"maxInput","data-tooltip-content":a("maxInputTooltip")})]})})})}),e.jsx("div",{className:"w-full flex justify-end mt-8",children:e.jsx(j,{type:"submit",children:a("save")})})]})}),e.jsx(ve,{className:"mt-4"})]})}function De(){const{t:a}=b("trade-matches");return e.jsxs(q,{className:"flex flex-col mx-auto max-w-[900px]",defaultValue:"offers",children:[e.jsxs(J,{className:"gap-4 mb-6 rounded-lg border-b-1 border-neutral-700 border-solid dark:bg-transparent pb-2",children:[e.jsx(F,{className:"text-md",value:"cards",children:a("tabCards")}),e.jsx(F,{className:"text-md",value:"offers",children:a("tabOffers")}),e.jsx(F,{className:"text-md",value:"settings",children:a("tabSettings")})]}),e.jsx(S,{value:"cards",children:e.jsx(Te,{})}),e.jsx(S,{value:"offers",children:e.jsx(Se,{})}),e.jsx(S,{value:"settings",children:e.jsx(Ae,{})})]})}export{De as default};
