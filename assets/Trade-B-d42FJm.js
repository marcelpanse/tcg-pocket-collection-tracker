import{_ as ne,Z as ie,u as v,j as e,r as o,U as E,C as B,l as de,v as Z,O as q,B as b,Q as W,V as oe,W as ce,N as G,X as H,z as le,m as ue,Y as me,J as xe,K as fe}from"./index-DYADB5K6.js";import{T as te,a as ae,b as I,c as A,C as J}from"./tabs-DteqRLyz.js";import{N as Y,M as O,C as L}from"./NumberFilter-Cua9W1Be.js";import{R as pe}from"./useWindowDimensionsHook-BYVtWmzT.js";import{C as _e}from"./CardDetail-B1JeUr2i.js";import{A as K,a as P,b as z}from"./alert-gIH5BsLs.js";import{S as Q}from"./siren-Cw60BQcw.js";import{u as he,a as ge,F as je,b as R,c as V,d as D,e as U,S as re,f as be,g as ve}from"./switch-UIoIRQcz.js";import{i as M}from"./Card-DhV9eOgo.js";import"./index-CSQCj1AE.js";function ee(t){return ne(ie,t)}function Ce(){const{t}=v("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(K,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx(P,{children:t("noCardsNeeded.title")}),e.jsx(z,{children:t("noCardsNeeded.description")})]})})}function Ne(){const{t}=v("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(K,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx(P,{children:t("noTradeableCards.title")}),e.jsx(z,{children:t("noTradeableCards.description")})]})})}function ye(){const{t}=v("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(K,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx(P,{children:t("notLoggedIn.title")}),e.jsx(z,{children:t("notLoggedIn.description")})]})})}function we(){const{t}=v("pages/trade"),{user:x,account:r}=o.use(E),{ownedCards:s,selectedCardId:_,setSelectedCardId:c}=o.use(B),[f,l]=o.useState([]),[d,h]=o.useState(0),[g,C]=o.useState(2),[u,p]=o.useState("looking_for"),N=o.useMemo(()=>de.filter(i=>i.tradeable).map(i=>i.id),[]),w=i=>f.length===0?!0:i.rarity!==""&&f.includes(i.rarity),a=o.useMemo(()=>Z.filter(i=>s.findIndex(m=>m.card_id===i.card_id)===-1||s[s.findIndex(m=>m.card_id===i.card_id)].amount_owned<=d).filter(i=>q[i.rarity]!==null&&N.includes(i.expansion)),[s,d]),j=o.useMemo(()=>a.filter(w),[a,f]),y=o.useMemo(()=>{const i=s.filter(m=>m.amount_owned>=g);return Z.filter(m=>i.findIndex($=>$.card_id===m.card_id)>-1).map(m=>({...m,amount_owned:i.find($=>$.card_id===m.card_id)?.amount_owned})).filter(m=>q[m.rarity]!==null&&N.includes(m.expansion))},[s,g]),S=o.useMemo(()=>y.filter(w),[y,f]),k=()=>{let i="";r?.is_public&&(i+=`${t("publicTradePage")} https://tcgpocketcollectiontracker.com/#/collection/${r?.friend_id}/trade
`),r?.username&&(i+=`${t("friendID")} ${r.friend_id} (${r.username})

`),i+=`${t("lookingForCards")}
`;const m=j.sort((n,F)=>{const X=n.expansion.localeCompare(F.expansion);return X!==0?X:n.rarity.localeCompare(F.rarity)});for(let n=0;n<m.length;n++)(n>0?m[n-1].expansion:"")!==m[n].expansion&&(i+=`
${m[n].set_details}:
`),i+=`${m[n].rarity} ${m[n].card_id} - ${m[n].name}
`;const $=j.map(n=>n.rarity);i+=`

${t("forTradeCards")}
`;const T=S.filter(n=>$.includes(n.rarity)).sort((n,F)=>n.rarity.localeCompare(F.rarity));for(let n=0;n<T.length;n++)(n>0?T[n-1].expansion:"")!==T[n].expansion&&(i+=`
${T[n].set_details}:
`),i+=`${T[n].rarity} ${T[n].card_id} - ${T[n].name}
`;return i},se=async()=>{const i=k();W({title:t("copiedInClipboard"),variant:"default",duration:3e3}),await navigator.clipboard.writeText(i)};return x?e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsxs(te,{defaultValue:u,onValueChange:p,children:[e.jsxs("div",{className:"mx-auto max-w-[900px] flex flex-row flex-wrap align-center gap-x-4 gap-y-2",children:[e.jsxs(ae,{className:"flex-grow m-auto flex-wrap h-auto border-1 border-neutral-700 rounded-md",children:[e.jsx(I,{value:"looking_for",children:t("lookingFor")}),e.jsx(I,{value:"for_trade",children:t("forTrade")})]}),e.jsx(pe,{rarityFilter:f,setRarityFilter:l}),e.jsxs("div",{className:"sm:mt-1 flex flex-row flex-wrap align-center gap-x-4 gap-y-1",children:[u==="looking_for"&&e.jsx(Y,{numberFilter:d,setNumberFilter:h,options:[0,1,2,3,4,5],labelKey:"maxNum"}),u==="for_trade"&&e.jsx(Y,{numberFilter:g,setNumberFilter:C,options:[2,3,4,5],labelKey:"minNum"}),e.jsx(b,{variant:"outline",onClick:se,children:"Copy to clipboard"})]})]}),e.jsxs("div",{className:"mx-auto max-w-[900px] mt-6",children:[e.jsx(A,{value:"looking_for",children:a&&a.length>0?e.jsx(J,{cards:j,extraOffset:105}):e.jsx(Ce,{})}),e.jsx(A,{value:"for_trade",children:y&&y.length>0?e.jsx(J,{cards:S,extraOffset:105}):e.jsx(Ne,{})})]})]}),_&&e.jsx(_e,{cardId:_,onClose:()=>c("")})]}):e.jsx(ye,{})}function Te(){const{t}=v("trade-matches"),{user:x,account:r,setAccount:s}=o.useContext(E),_=oe({is_active_trading:ce(),min_number_of_cards_to_keep:ee().min(1).max(10),max_number_of_cards_wanted:ee().min(1).max(10)}),c=he({resolver:ge(_),values:{is_active_trading:r?.is_active_trading||!1,min_number_of_cards_to_keep:r?.min_number_of_cards_to_keep||1,max_number_of_cards_wanted:r?.max_number_of_cards_wanted||1}}),f=async l=>{try{const d=await H.from("accounts").upsert({email:x?.user.email,username:r?.username,is_active_trading:l.is_active_trading,min_number_of_cards_to_keep:l.min_number_of_cards_to_keep,max_number_of_cards_wanted:l.max_number_of_cards_wanted}).select().single();if(!d.data)throw console.error("Could not save account",r),new Error("Could not save account");s(d.data),W({title:t("accountSaved"),variant:"default"})}catch(d){console.error("error saving account",d),W({title:t("errorSavingAccount"),variant:"destructive"})}};return e.jsxs("div",{children:[e.jsx(je,{...c,children:e.jsxs("form",{onSubmit:c.handleSubmit(f),className:"border-1 border-neutral-700 space-y-2 p-4 mx-auto",children:[e.jsx(R,{control:c.control,name:"is_active_trading",render:({field:l})=>e.jsx(V,{className:"flex flex-col items-start",children:e.jsx(D,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(U,{className:"flex sm:w-72",children:t("isActiveTrading")}),e.jsx("div",{className:"grow-1",children:e.jsx(re,{checked:l.value,onCheckedChange:l.onChange})}),e.jsx(be,{className:"grow",children:l.value?"active":"disabled"}),e.jsx(O,{id:"activeInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(L,{className:"h-4 w-4","data-tooltip-id":"activeInput","data-tooltip-content":t("activeTradingInputTooltip")})]})})})}),e.jsx(R,{control:c.control,name:"min_number_of_cards_to_keep",render:({field:l})=>e.jsx(V,{className:"flex flex-col items-start",children:e.jsx(D,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(U,{className:"flex sm:w-72",children:t("minNumberOfCardsToKeep")}),e.jsx("div",{className:"grow-1",children:e.jsx(G,{className:"w-24",type:"number",...l})}),e.jsx(O,{id:"minInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(L,{className:"h-4 w-4","data-tooltip-id":"minInput","data-tooltip-content":t("minInputTooltip")})]})})})}),e.jsx(R,{control:c.control,name:"max_number_of_cards_wanted",render:({field:l})=>e.jsx(V,{className:"flex flex-col items-start",children:e.jsx(D,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(U,{className:"flex sm:w-72",children:t("maxNumberOfCardsWanted")}),e.jsx("div",{className:"grow-1",children:e.jsx(G,{className:"w-24",type:"number",...l})}),e.jsx(O,{id:"maxInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(L,{className:"h-4 w-4","data-tooltip-id":"maxInput","data-tooltip-content":t("maxInputTooltip")})]})})})}),e.jsx("div",{className:"w-full flex justify-end mt-8",children:e.jsx(b,{type:"submit",children:t("save")})})]})}),e.jsx(ve,{className:"mt-4"})]})}const ke=({row:t,selectedTradeId:x,setSelectedTradeId:r})=>{const{t:s,i18n:_}=v("trade-matches"),{account:c}=o.useContext(E),{ownedCards:f}=o.useContext(B);if(!c)return null;const l=t.offering_friend_id===c.friend_id?t.offer_card_id:t.receiver_card_id,d=t.offering_friend_id===c.friend_id?t.receiver_card_id:t.offer_card_id;function h(u){const p=le(u);return p?e.jsxs("span",{className:"flex rounded px-1 w-1/2 bg-zinc-800",children:[e.jsxs("span",{className:"mr-2 sm:min-w-10",children:[p.rarity," "]}),e.jsxs("span",{className:"mr-2 sm:min-w-14 me-4",children:[p.card_id," "]}),e.jsx("span",{children:ue(p,_.language)}),e.jsxs("span",{className:"text-neutral-400 ml-auto",children:["×",f.find(N=>N.card_id===p.card_id)?.amount_owned||0]})]}):e.jsx("span",{className:"w-1/2 text-center",children:"?"})}function g(u){x===u.id?r(void 0):r(u.id)}const C=u=>{const p={offered:{icon:u.offering_friend_id===c.friend_id?"→":"←",color:"bg-amber-600"},accepted:{icon:"↔",color:"bg-lime-600"},declined:{icon:"X",color:"bg-stone-600"},finished:{icon:"✓",color:"bg-indigo-600"}};return e.jsxs(e.Fragment,{children:[e.jsx(O,{id:`tooltip-${u.id}`}),e.jsx("span",{className:`rounded-full text-center w-9 min-w-6 ${p[u.status].color}`,"data-tooltip-id":`tooltip-${u.id}`,"data-tooltip-content":s(`status.${u.status}`),children:p[u.status].icon})]})};return e.jsxs("li",{className:`flex cursor-pointer justify-between rounded gap-1 sm:gap-4 sm:px-1 py-1 my-1 ${x===t.id&&"bg-green-900"} hover:bg-neutral-500`,onClick:()=>g(t),children:[C(t),h(l),h(d)]})};function Fe({trades:t,update:x,viewHistory:r}){const{t:s}=v("trade-matches"),{toast:_}=me();function c(a){return a.offering_friend_id===d?.friend_id&&!a.offerer_ended||a.receiving_friend_id===d?.friend_id&&!a.receiver_ended}const{ownedCards:f,setOwnedCards:l}=o.useContext(B),{account:d,user:h}=o.useContext(E),g=r?t.filter(a=>!c(a)):t.filter(c),[C,u]=o.useState(void 0);if(!d||!h)return null;const p=async a=>{a.offering_friend_id===d.friend_id?(await M([a.offer_card_id],-1,f,l,h),await M([a.receiver_card_id],1,f,l,h),_({title:s("collectionUpdated"),variant:"default"})):a.receiving_friend_id===d.friend_id?(await M([a.offer_card_id],1,f,l,h),await M([a.receiver_card_id],-1,f,l,h),_({title:s("collectionUpdated"),variant:"default"})):console.log(a,"can't match friend id")},N=a=>{const j=async k=>{await x(a.id,{status:k}),u(a.id)},y=async()=>{const k=a.offering_friend_id===d.friend_id?{offerer_ended:!0}:a.receiving_friend_id===d.friend_id?{receiver_ended:!0}:null;if(k===null){console.log(a," doesn't match your friend_id");return}await x(a.id,k),u(void 0)},S=a.offering_friend_id===d.friend_id&&a.offerer_ended||a.receiving_friend_id===d.friend_id&&a.receiver_ended;switch(a.status){case"offered":return e.jsxs(e.Fragment,{children:[a.receiving_friend_id===d.friend_id&&e.jsx(b,{type:"button",onClick:async()=>j("accepted"),children:s("actionAccept")}),e.jsx(b,{type:"button",onClick:async()=>j("declined"),children:a.receiving_friend_id===d.friend_id?s("actionDecline"):s("actionCancel")})]});case"accepted":return e.jsxs(e.Fragment,{children:[e.jsx(b,{type:"button",onClick:async()=>j("finished"),children:s("actionComplete")}),e.jsx(b,{type:"button",onClick:async()=>j("declined"),children:s("actionCancel")})]});case"declined":return S?null:e.jsx(b,{type:"button",onClick:y,children:s("actionHide")});case"finished":return S?null:e.jsxs(e.Fragment,{children:[e.jsx(b,{type:"button",onClick:async()=>{await p(a),await y()},children:s("actionUpdate")}),e.jsx(b,{type:"button",onClick:y,children:s("actionHide")})]});default:return console.log(`Unknown trade status ${a.status}`),null}},w=g.find(a=>a.id===C);return g.length===0?e.jsx("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2 text-center",children:s("noActiveTrades")}):e.jsxs("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2",children:[e.jsxs("div",{className:"flex gap-4 px-1",children:[e.jsx("div",{className:"w-9"}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:s("youGive")}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:s("youReceive")})]}),e.jsx("ul",{children:g.toSorted((a,j)=>a.created_at>j.created_at?-1:1).map(a=>e.jsx(ke,{row:a,selectedTradeId:C,setSelectedTradeId:u},a.id))}),w&&e.jsx("div",{className:"flex gap-4 text-center items-center mt-2",children:N(w)})]})}function Se(t,x){return Object.groupBy(t,r=>r.offering_friend_id===x?r.receiving_friend_id:r.receiving_friend_id===x?r.offering_friend_id:"undefined")}function $e({friendId:t,initialTrades:x}){const{t:r}=v("trade-matches"),[s,_]=o.useState(null),c=xe(),[f,l]=o.useState(x),[d,h]=o.useState(!1);async function g(C,u){const p=new Date,{error:N}=await H.from("trades").update({updated_at:p,...u}).eq("id",C);if(N){console.log("Error updating trades: ",N);return}console.log("successfully updated trade"),l(w=>w.map(a=>a.id===C?{...a,updated_at:p,...u}:a))}return o.useEffect(()=>{s||fe(t).then(_)}),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 mx-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-sm",children:r("tradingWith")}),e.jsxs("span",{className:"text-xl font-medium",children:[" ",s?.username||"loading"," "]}),e.jsxs("span",{className:"text-xs",children:["(",t,")"]})]}),e.jsxs("span",{className:"flex gap-4",children:[e.jsxs("label",{htmlFor:`history-${t}`,className:"my-auto flex items-center",children:[r("viewHistory"),e.jsx(re,{id:`history-${t}`,className:"ml-2 my-auto",checked:d,onCheckedChange:h})]}),e.jsx(b,{className:"my-auto",onClick:()=>c(`/trade/${t}`),children:r("openTradeWith")})]})]}),s!==null&&e.jsx(Fe,{trades:f,update:g,viewHistory:d})]})}function Ie(){const{t}=v("trade-matches"),{account:x}=o.useContext(E),[r,s]=o.useState(null);if(o.useEffect(()=>{x&&r===null&&(console.log("Refrehing trades"),H.from("trades").select().then(({data:c,error:f})=>{f?console.log("Error fetching trades: ",f):s(c)}))}),r===null||!x)return null;if(r.length===0)return e.jsx("p",{children:t("noTradeOffers")});const _=Se(r,x.friend_id);return e.jsx("div",{className:"flex flex-col items-center mx-auto gap-12 sm:px-4",children:Object.keys(_).map(c=>e.jsx($e,{friendId:c,initialTrades:_[c],account:x},c))})}function Be(){const{t}=v("trade-matches");return e.jsxs(te,{className:"flex flex-col mx-auto max-w-[900px]",defaultValue:"offers",children:[e.jsxs(ae,{className:"gap-4 mb-6 rounded-lg border-b-1 border-neutral-700 border-solid dark:bg-transparent pb-2",children:[e.jsx(I,{className:"text-md",value:"cards",children:t("tabCards")}),e.jsx(I,{className:"text-md",value:"offers",children:t("tabOffers")}),e.jsx(I,{className:"text-md",value:"settings",children:t("tabSettings")})]}),e.jsx(A,{value:"cards",children:e.jsx(we,{})}),e.jsx(A,{value:"offers",children:e.jsx(Ie,{})}),e.jsx(A,{value:"settings",children:e.jsx(Te,{})})]})}export{Be as default};
