import{c as L,r as u,k as E,j as a,m as O,Y as k,aF as M,I as P,U as $,C as U,B as D,M as Y}from"./index-LlXw60fV.js";/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],F=L("plus",B);function R({selected:t,setIsSelected:m,card:d,size:w="default",clickable:n=!0}){const e=u.useRef(null),[l,p]=u.useState({x:0,y:0}),[o,i]=u.useState(!1),s=u.useRef(T(c=>p(c),50)),f=c=>{s.current({x:c.clientX,y:c.clientY})},g=u.useCallback(()=>{i(!0),window.addEventListener("mousemove",f)},[]),S=u.useCallback(()=>{i(!1),window.removeEventListener("mousemove",f)},[]);let x=0,y=0;if(e.current&&o){const c=e.current.getBoundingClientRect(),_=c.left+c.width/2,I=c.top+c.height/2;x=l.x-_,y=l.y-I}const v=(c,_,I)=>Math.min(Math.max(c,_),I),j=o?v(x/4,-10,10):0,r=o?v(-y/4,-10,10):0,h={transform:`perspective(1000px)
                   rotateY(${j}deg)
                   rotateX(${r}deg)
                   scale(${o?1.04:1})`,transition:"transform 0.3s cubic-bezier(0.17, 0.67, 0.5, 1.03)",transformStyle:"preserve-3d",cursor:n?"pointer":"default",opacity:t?1:.5,width:w==="small"?"80px":"100%",height:w==="small"?"112px":"auto"},C=d.image?.split("/").at(-1),b=`/images/${E.language}/${C}`;return a.jsx("div",{style:{flex:"1 0 20%",perspective:"1000px",transformStyle:typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("firefox")?"flat":"preserve-3d",display:"flex",justifyContent:"center",alignItems:"center",zIndex:o?10:0},children:C&&a.jsx("img",{draggable:!1,loading:"lazy",onMouseDown:()=>m?.(!t),ref:e,className:"card-test",style:h,src:b,alt:O(d,E.language),onMouseEnter:g,onMouseLeave:S,onError:c=>{c.target.src=d.image}})})}const T=(t,m)=>{let d=0,w=null;return(...n)=>{const e=performance.now(),l=e-d;if(l<m){w||(w=setTimeout(()=>{d=performance.now(),w=null,t(...n)},m-l));return}d=e,t(...n)}},N={};function z({card:t,onImageClick:m,useMaxWidth:d=!1,editable:w=!0}){const n=P(),{user:e,setIsLoginDialogOpen:l}=u.use($),{ownedCards:p,setOwnedCards:o,setSelectedCardId:i}=u.use(U),[s,f]=u.useState(t.amount_owned||0),[g,S]=u.useState(0);u.useEffect(()=>{S(s)},[s]);const x=u.useCallback(async(r,h)=>{const C=Math.max(0,h);f(C),N[r]&&window.clearTimeout(N[r]),N[r]=window.setTimeout(async()=>{if(!e||!e.user.email)throw new Error("User not logged in");const b=p.find(_=>_.card_id===r);b?b.amount_owned=C:p.push({email:e.user.email,card_id:r,amount_owned:C,updated_at:new Date().toISOString()});const{error:c}=await k.from("collection").upsert({card_id:r,amount_owned:C,email:e.user.email,updated_at:new Date().toISOString()});if(c)throw new Error("Error updating collection");M(p,e.user.email)},1e3)},[p,e,o,s]),y=u.useCallback(async r=>{if(!e){l(!0);return}await x(r,s+1)},[x]),v=u.useCallback(async r=>{if(!e){l(!0);return}await x(r,s-1)},[x]),j=async r=>{const h=r.target.value===""?0:Number.parseInt(r.target.value,10);!Number.isNaN(h)&&h>=0&&await x(t.card_id,h)};return t.linkedCardID?null:a.jsxs("div",{className:`group flex w-fit ${d?"":"max-w-32 md:max-w-40"} flex-col items-center rounded-lg`,children:[a.jsx("button",{type:"button",className:"cursor-pointer",onClick:()=>{i(t.card_id),m?.()},children:a.jsx(R,{card:t,selected:s>0,clickable:!d})}),a.jsxs("p",{className:"max-w-[120px] md:max-w-[130px] text-[12px] pt-2 text-center font-semibold leading-tight md:whitespace-nowrap md:overflow-hidden md:text-ellipsis",children:[a.jsx("span",{className:"block md:inline",children:t.card_id}),a.jsx("span",{className:"hidden md:inline",children:" - "}),a.jsx("span",{className:"block md:inline overflow-hidden text-ellipsis whitespace-nowrap",children:O(t,E.language)})]}),a.jsx("div",{className:"flex items-center gap-x-1",children:w&&!n.friendId?a.jsxs(a.Fragment,{children:[a.jsx(D,{variant:"ghost",size:"icon",onClick:()=>v(t.card_id),className:"rounded-full",tabIndex:-1,children:a.jsx(Y,{})}),a.jsx("input",{min:"0",max:"99",type:"text",disabled:!!n.friendId,value:g,onChange:j,className:"w-7 text-center border-none rounded",onFocus:r=>r.target.select()}),a.jsx(D,{variant:"ghost",size:"icon",className:"rounded-full",onClick:()=>y(t.card_id),tabIndex:-1,children:a.jsx(F,{})})]}):a.jsx("span",{className:"mt-1",children:s})})]})}const A=async(t,m,d,w,n)=>{if(!n||!n.user.email)throw new Error("User not logged in");if(m<0)throw new Error("New amount cannot be negative");const e=[...d],l=t.map(o=>({card_id:o,amount_owned:m,email:n.user.email,updated_at:new Date().toISOString()})),{error:p}=await k.from("collection").upsert(l);if(p)throw new Error("Error bulk updating collection");M(e,n.user.email);for(const o of t){const i=e.find(s=>s.card_id===o);i?(console.log("Updating existing card:",o),i.amount_owned=m):i||(console.log("Adding new card:",o),e.push({email:n.user.email,card_id:o,amount_owned:m,updated_at:new Date().toISOString()}))}w([...e])},H=async(t,m,d,w,n)=>{if(!n||!n.user.email)throw new Error("User not logged in");const e=new Map;for(const i of t)e.set(i,(e.get(i)||0)+m);const l=[...d],p=[];for(const[i,s]of e){const f=l.find(g=>g.card_id===i);if(f)console.log("Incrementing existing card:",i,"from",f.amount_owned,"to",f.amount_owned+s),f.amount_owned+=s,f.updated_at=new Date().toISOString(),p.push(f);else if(!f&&s>0){console.log("Adding new card:",i,"with amount",s);const g={email:n.user.email,card_id:i,amount_owned:s,updated_at:new Date().toISOString()};l.push(g),p.push(g)}}const{error:o}=await k.from("collection").upsert(p);if(o)throw new Error(`Error bulk updating collection: ${o.message}`);return M(l,n.user.email),w([...l]),p};export{z as C,R as F,F as P,H as i,A as u};
