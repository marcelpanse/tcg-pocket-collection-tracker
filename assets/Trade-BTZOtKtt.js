import{_ as ce,Z as le,u as N,j as e,r as c,U as L,C as se,l as ue,v as H,O as re,Q as me,B as g,V as J,W as xe,X as fe,N as ae,Y,$ as pe,z as _e,J as he,K as ge}from"./index-CCWLHuiI.js";import{T as ne,a as ie,b as A,c as E,C as P}from"./tabs-CKlhHyFa.js";import{N as z,M as D,C as Q}from"./NumberFilter-Bnztz1x3.js";import{R as je}from"./useWindowDimensionsHook-DR8dbkvv.js";import{C as be}from"./CardDetail-CWNHLd-p.js";import{A as U,a as W,b as B}from"./alert-ZceZIVoM.js";import{S as K}from"./siren-CT7_Qa9E.js";import{u as ve,a as Ce,F as Ne,b as X,c as Z,d as q,e as G,S as de,f as ye,g as we}from"./switch-DLSuLlNu.js";import{i as V}from"./Card-TR4owCaq.js";import"./index-CXTlmf7J.js";function te(a){return ce(le,a)}function ke(){const{t:a}=N("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(U,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx(W,{children:a("noCardsNeeded.title")}),e.jsx(B,{children:a("noCardsNeeded.description")})]})})}function Te(){const{t:a}=N("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(U,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx(W,{children:a("noSellableCards.title")}),e.jsx(B,{children:a("noSellableCards.description")})]})})}function Fe(){const{t:a}=N("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(U,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx(W,{children:a("noTradeableCards.title")}),e.jsx(B,{children:a("noTradeableCards.description")})]})})}function Se(){const{t:a}=N("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(U,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsx(W,{children:a("notLoggedIn.title")}),e.jsx(B,{children:a("notLoggedIn.description")})]})})}function $e(){const{t:a}=N("pages/trade"),{user:f,account:d}=c.use(L),{ownedCards:t,selectedCardId:p,setSelectedCardId:x}=c.use(se),[m,l]=c.useState([]),[o,j]=c.useState(0),[b,y]=c.useState(2),[h,T]=c.useState(3),[v,F]=c.useState("looking_for"),w=c.useMemo(()=>ue.filter(s=>s.tradeable).map(s=>s.id),[]),O=s=>m.length===0?!0:s.rarity!==""&&m.includes(s.rarity),S=c.useMemo(()=>H.filter(s=>t.findIndex(n=>n.card_id===s.card_id)===-1||t[t.findIndex(n=>n.card_id===s.card_id)].amount_owned<=o).filter(s=>re[s.rarity]!==null&&w.includes(s.expansion)),[t,o]),$=c.useMemo(()=>S.filter(O),[S,m]),r=c.useMemo(()=>{const s=t.filter(n=>n.amount_owned>=b);return H.filter(n=>s.findIndex(C=>C.card_id===n.card_id)>-1).map(n=>({...n,amount_owned:s.find(C=>C.card_id===n.card_id)?.amount_owned})).filter(n=>re[n.rarity]!==null&&w.includes(n.expansion))},[t,b]),u=c.useMemo(()=>r.filter(O),[r,m]),_=c.useMemo(()=>{const s=t.filter(n=>n.amount_owned>=h);return H.filter(n=>s.findIndex(C=>C.card_id===n.card_id)>-1).map(n=>({...n,amount_owned:s.find(C=>C.card_id===n.card_id)?.amount_owned})).filter(n=>me[n.rarity]!==null)},[t,h]),R=c.useMemo(()=>_.filter(O),[_,m]),I=()=>{let s="";d?.is_public&&(s+=`${a("publicTradePage")} https://tcgpocketcollectiontracker.com/#/collection/${d?.friend_id}/trade
`),d?.username&&(s+=`${a("friendID")} ${d.friend_id} (${d.username})

`),s+=`${a("lookingForCards")}
`;const n=$.sort((i,M)=>{const ee=i.expansion.localeCompare(M.expansion);return ee!==0?ee:i.rarity.localeCompare(M.rarity)});for(let i=0;i<n.length;i++)(i>0?n[i-1].expansion:"")!==n[i].expansion&&(s+=`
${n[i].set_details}:
`),s+=`${n[i].rarity} ${n[i].card_id} - ${n[i].name}
`;const C=$.map(i=>i.rarity);s+=`

${a("forTradeCards")}
`;const k=u.filter(i=>C.includes(i.rarity)).sort((i,M)=>i.rarity.localeCompare(M.rarity));for(let i=0;i<k.length;i++)(i>0?k[i-1].expansion:"")!==k[i].expansion&&(s+=`
${k[i].set_details}:
`),s+=`${k[i].rarity} ${k[i].card_id} - ${k[i].name}
`;return s},oe=async()=>{const s=I();J({title:a("copiedInClipboard"),variant:"default",duration:3e3}),await navigator.clipboard.writeText(s)};return f?e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsxs(ne,{defaultValue:v,onValueChange:F,children:[e.jsxs("div",{className:"mx-auto max-w-[900px] flex flex-row flex-wrap align-center gap-x-4 gap-y-2",children:[e.jsxs(ie,{className:"flex-grow m-auto flex-wrap h-auto border-1 border-neutral-700 rounded-md",children:[e.jsx(A,{value:"looking_for",children:a("lookingFor")}),e.jsx(A,{value:"for_trade",children:a("forTrade")}),e.jsx(A,{value:"buying_tokens",children:a("buyingTokens")})]}),e.jsx(je,{rarityFilter:m,setRarityFilter:l}),e.jsxs("div",{className:"sm:mt-1 flex flex-row flex-wrap align-center gap-x-4 gap-y-1",children:[v==="looking_for"&&e.jsx(z,{numberFilter:o,setNumberFilter:j,options:[0,1,2,3,4,5],labelKey:"maxNum"}),v==="for_trade"&&e.jsx(z,{numberFilter:b,setNumberFilter:y,options:[2,3,4,5],labelKey:"minNum"}),v==="buying_tokens"&&e.jsx(z,{numberFilter:h,setNumberFilter:T,options:[2,3,4,5],labelKey:"minNum"}),e.jsx(g,{variant:"outline",onClick:oe,children:"Copy to clipboard"})]})]}),e.jsxs("div",{className:"mx-auto max-w-[900px] mt-6",children:[e.jsx(E,{value:"looking_for",children:S&&S.length>0?e.jsx(P,{cards:$,extraOffset:105}):e.jsx(ke,{})}),e.jsx(E,{value:"for_trade",children:r&&r.length>0?e.jsx(P,{cards:u,extraOffset:105}):e.jsx(Fe,{})}),e.jsx(E,{value:"buying_tokens",children:_&&_.length>0?e.jsx(P,{cards:R,extraOffset:105}):e.jsx(Te,{})})]})]}),p&&e.jsx(be,{cardId:p,onClose:()=>x("")})]}):e.jsx(Se,{})}function Ie(){const{t:a}=N("trade-matches"),{user:f,account:d,setAccount:t}=c.useContext(L),p=xe({is_active_trading:fe(),min_number_of_cards_to_keep:te().min(1).max(10),max_number_of_cards_wanted:te().min(1).max(10)}),x=ve({resolver:Ce(p),values:{is_active_trading:d?.is_active_trading||!1,min_number_of_cards_to_keep:d?.min_number_of_cards_to_keep||1,max_number_of_cards_wanted:d?.max_number_of_cards_wanted||1}}),m=async l=>{try{const o=await Y.from("accounts").upsert({email:f?.user.email,username:d?.username,is_active_trading:l.is_active_trading,min_number_of_cards_to_keep:l.min_number_of_cards_to_keep,max_number_of_cards_wanted:l.max_number_of_cards_wanted}).select().single();if(!o.data)throw console.error("Could not save account",d),new Error("Could not save account");t(o.data),J({title:a("accountSaved"),variant:"default"})}catch(o){console.error("error saving account",o),J({title:a("errorSavingAccount"),variant:"destructive"})}};return e.jsxs("div",{children:[e.jsx(Ne,{...x,children:e.jsxs("form",{onSubmit:x.handleSubmit(m),className:"border-1 border-neutral-700 space-y-2 p-4 mx-auto",children:[e.jsx(X,{control:x.control,name:"is_active_trading",render:({field:l})=>e.jsx(Z,{className:"flex flex-col items-start",children:e.jsx(q,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(G,{className:"flex sm:w-72",children:a("isActiveTrading")}),e.jsx("div",{className:"grow-1",children:e.jsx(de,{checked:l.value,onCheckedChange:l.onChange})}),e.jsx(ye,{className:"grow",children:l.value?"active":"disabled"}),e.jsx(D,{id:"activeInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(Q,{className:"h-4 w-4","data-tooltip-id":"activeInput","data-tooltip-content":a("activeTradingInputTooltip")})]})})})}),e.jsx(X,{control:x.control,name:"min_number_of_cards_to_keep",render:({field:l})=>e.jsx(Z,{className:"flex flex-col items-start",children:e.jsx(q,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(G,{className:"flex sm:w-72",children:a("minNumberOfCardsToKeep")}),e.jsx("div",{className:"grow-1",children:e.jsx(ae,{className:"w-24",type:"number",...l})}),e.jsx(D,{id:"minInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(Q,{className:"h-4 w-4","data-tooltip-id":"minInput","data-tooltip-content":a("minInputTooltip")})]})})})}),e.jsx(X,{control:x.control,name:"max_number_of_cards_wanted",render:({field:l})=>e.jsx(Z,{className:"flex flex-col items-start",children:e.jsx(q,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(G,{className:"flex sm:w-72",children:a("maxNumberOfCardsWanted")}),e.jsx("div",{className:"grow-1",children:e.jsx(ae,{className:"w-24",type:"number",...l})}),e.jsx(D,{id:"maxInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(Q,{className:"h-4 w-4","data-tooltip-id":"maxInput","data-tooltip-content":a("maxInputTooltip")})]})})})}),e.jsx("div",{className:"w-full flex justify-end mt-8",children:e.jsx(g,{type:"submit",children:a("save")})})]})}),e.jsx(we,{className:"mt-4"})]})}function Me({trades:a,update:f,viewHistory:d}){const{t}=N("trade-matches"),{toast:p}=pe();function x(r){return r.offering_friend_id===o?.friend_id&&!r.offerer_ended||r.receiving_friend_id===o?.friend_id&&!r.receiver_ended}const{ownedCards:m,setOwnedCards:l}=c.useContext(se),{account:o,user:j}=c.useContext(L),b=d?a.filter(r=>!x(r)):a.filter(x),[y,h]=c.useState(void 0);if(!o||!j)return null;function T(r){y===r.id?h(void 0):h(r.id)}const v=r=>{const u={offered:{icon:r.offering_friend_id===o.friend_id?"→":"←",color:"bg-amber-600"},accepted:{icon:"↔",color:"bg-lime-600"},declined:{icon:"X",color:"bg-stone-600"},finished:{icon:"✓",color:"bg-indigo-600"}};return e.jsxs(e.Fragment,{children:[e.jsx(D,{id:`tooltip-${r.id}`}),e.jsx("span",{className:`rounded-full text-center w-9 ${u[r.status].color}`,"data-tooltip-id":`tooltip-${r.id}`,"data-tooltip-content":r.status,children:u[r.status].icon})]})};function F(r){const u=_e(r);return u?e.jsxs("span",{className:"flex rounded px-1 w-1/2 bg-zinc-800",children:[e.jsxs("span",{className:"min-w-10",children:[u.rarity," "]}),e.jsxs("span",{className:"min-w-14 me-4",children:[u.card_id," "]}),e.jsx("span",{children:u.name}),e.jsxs("span",{className:"text-neutral-400 ml-auto",children:["×",m.find(_=>_.card_id===u.card_id)?.amount_owned||0]})]}):e.jsx("span",{className:"w-1/2 text-center",children:"?"})}const w=({row:r})=>{const u=r.offering_friend_id===o.friend_id?r.offer_card_id:r.receiver_card_id,_=r.offering_friend_id===o.friend_id?r.receiver_card_id:r.offer_card_id;return e.jsxs("li",{className:`flex cursor-pointer justify-between rounded gap-4 p-1 my-1 ${y===r.id&&"bg-green-900"} hover:bg-neutral-500`,onClick:()=>T(r),children:[v(r),F(u),F(_)]})},O=async r=>{r.offering_friend_id===o.friend_id?(await V([r.offer_card_id],-1,m,l,j),await V([r.receiver_card_id],1,m,l,j),p({title:t("collectionUpdated"),variant:"default"})):r.receiving_friend_id===o.friend_id?(await V([r.offer_card_id],1,m,l,j),await V([r.receiver_card_id],-1,m,l,j),p({title:t("collectionUpdated"),variant:"default"})):console.log(r,"can't match friend id")},S=r=>{const u=async I=>{await f(r.id,{status:I}),h(r.id)},_=async()=>{const I=r.offering_friend_id===o.friend_id?{offerer_ended:!0}:r.receiving_friend_id===o.friend_id?{receiver_ended:!0}:null;if(I===null){console.log(r," doesn't match your friend_id");return}await f(r.id,I),h(void 0)},R=r.offering_friend_id===o.friend_id&&r.offerer_ended||r.receiving_friend_id===o.friend_id&&r.receiver_ended;switch(r.status){case"offered":return e.jsxs(e.Fragment,{children:[r.receiving_friend_id===o.friend_id&&e.jsx(g,{type:"button",onClick:async()=>u("accepted"),children:t("actionAccept")}),e.jsx(g,{type:"button",onClick:async()=>u("declined"),children:r.receiving_friend_id===o.friend_id?t("actionDecline"):t("actionCancel")})]});case"accepted":return e.jsxs(e.Fragment,{children:[e.jsx(g,{type:"button",onClick:async()=>u("finished"),children:t("actionComplete")}),e.jsx(g,{type:"button",onClick:async()=>u("declined"),children:t("actionCancel")})]});case"declined":return R?null:e.jsx(g,{type:"button",onClick:_,children:t("actionHide")});case"finished":return R?null:e.jsxs(e.Fragment,{children:[e.jsx(g,{type:"button",onClick:async()=>{await O(r),await _()},children:t("actionUpdate")}),e.jsx(g,{type:"button",onClick:_,children:t("actionHide")})]});default:return console.log(`Unknown trade status ${r.status}`),null}},$=b.find(r=>r.id===y);return b.length===0?e.jsx("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2 text-center",children:t("noActiveTrades")}):e.jsxs("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2",children:[e.jsxs("div",{className:"flex gap-4 px-1",children:[e.jsx("div",{className:"w-9"}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:t("youGive")}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:t("youReceive")})]}),e.jsx("ul",{children:b.toSorted((r,u)=>r.created_at>u.created_at?-1:1).map(r=>e.jsx(w,{row:r},r.id))}),$&&e.jsx("div",{className:"flex gap-4 text-center items-center mt-2",children:S($)})]})}function Ae(a,f){return Object.groupBy(a,d=>d.offering_friend_id===f?d.receiving_friend_id:d.receiving_friend_id===f?d.offering_friend_id:"undefined")}function Ee({friendId:a,initialTrades:f}){const{t:d}=N("trade-matches"),[t,p]=c.useState(null),x=he(),[m,l]=c.useState(f),[o,j]=c.useState(!1);async function b(y,h){const T=new Date,{error:v}=await Y.from("trades").update({updated_at:T,...h}).eq("id",y);if(v){console.log("Error updating trades: ",v);return}console.log("successfully updated trade"),l(F=>F.map(w=>w.id===y?{...w,updated_at:T,...h}:w))}return c.useEffect(()=>{t||ge(a).then(p)}),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 mx-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-sm",children:d("tradingWith")}),e.jsxs("span",{className:"text-xl font-medium",children:[" ",t?.username||"loading"," "]}),e.jsxs("span",{className:"text-xs",children:["(",a,")"]})]}),e.jsxs("span",{className:"flex gap-4",children:[e.jsxs("label",{htmlFor:`history-${a}`,className:"my-auto flex items-center",children:["View history",e.jsx(de,{id:`history-${a}`,className:"ml-2 my-auto",checked:o,onCheckedChange:j})]}),e.jsx(g,{className:"my-auto",onClick:()=>x(`/trade/${a}`),children:d("openTradeWith")})]})]}),t!==null&&e.jsx(Me,{trades:m,update:b,viewHistory:o})]})}function Oe(){const{t:a}=N("trade-matches"),{account:f}=c.useContext(L),[d,t]=c.useState(null);if(c.useEffect(()=>{f&&d===null&&(console.log("Refrehing trades"),Y.from("trades").select().then(({data:x,error:m})=>{m?console.log("Error fetching trades: ",m):t(x)}))}),d===null||!f)return null;if(d.length===0)return e.jsx("p",{children:a("noTradeOffers")});const p=Ae(d,f.friend_id);return e.jsx("div",{className:"flex flex-col items-center mx-auto gap-12",children:Object.keys(p).map(x=>e.jsx(Ee,{friendId:x,initialTrades:p[x],account:f},x))})}function ze(){return e.jsxs(ne,{className:"flex flex-col mx-auto max-w-[900px]",defaultValue:"offers",children:[e.jsxs(ie,{className:"gap-4 mb-6 rounded-lg border-b-1 border-neutral-700 border-solid dark:bg-transparent pb-2",children:[e.jsx(A,{className:"text-md",value:"cards",children:"Cards"}),e.jsx(A,{className:"text-md",value:"offers",children:"Offers"}),e.jsx(A,{className:"text-md",value:"settings",children:"Settings"})]}),e.jsx(E,{value:"cards",children:e.jsx($e,{})}),e.jsx(E,{value:"offers",children:e.jsx(Oe,{})}),e.jsx(E,{value:"settings",children:e.jsx(Ie,{})})]})}export{ze as default};
