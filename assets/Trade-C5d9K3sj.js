import{e as P,a0 as te,a1 as se,j as e,f as N,a2 as Z,a3 as re,D as j,a4 as M,M as ae,B as ne,N as q,O as ie,C as S,p as J,r as b,T as $,a5 as R,a6 as H,a7 as L,L as O,a8 as de,a9 as ce,aa as le,ab as oe,ac as me,ad as ue,ae as fe,af as xe,ag as Q,ah as he,ai as U,aj as pe,ak as ge,al as je,Z as B,E as D,J as _e,am as be,K as Ne,an as ve,ao as C,ap as ye}from"./index-BX2PrebS.js";import{T as Ce,a as Te,b as w}from"./tabs-DDUkDnUO.js";import{F as X}from"./friend-id-display-BDKJ8Ty2.js";import{C as k}from"./CardLine-B74XVJE9.js";import{C as z}from"./chevron-right-DFV9779V.js";import{g as ke,u as Se}from"./filters-Az6trC_0.js";import{S as we}from"./SearchInput-CpKqZ1pV.js";import{S as ee,u as $e,a as Le,F as Fe,b as F,c as I,d as A,e as Ie,f as Ae}from"./form-ChmbfQEC.js";import{M as E,C as V}from"./react-tooltip.min-CwTc4skk.js";import{A as Me}from"./alert-WhRd5HfC.js";import"./index-C_fjzIyK.js";import"./index-BII4znhG.js";const Ee=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],Pe=P("arrow-left",Ee);const Oe=[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]],ze=P("arrow-right-left",Oe);const Re=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]],He=P("arrow-right",Re);function K(t){return te(se,t)}const W=({cards:t,selected:n,setSelected:s})=>{const d=[...t].sort((o,i)=>{const m=l=>{const x=l.split("-"),p=x[0]||"",v=x.length>1?parseInt(x[1],10):0;return{setName:p,cardNumber:v}},u=m(o.card_id),c=m(i.card_id);return u.setName!==c.setName?u.setName.localeCompare(c.setName):u.cardNumber-c.cardNumber});function r(o){function i(){n?.card_id===o.card_id?s(null):s(o)}return e.jsx("li",{className:"rounded cursor-pointer",onClick:i,children:e.jsx(k,{className:`w-full ${n?.card_id===o.card_id&&"bg-green-900"} hover:bg-neutral-600`,card_id:o.card_id,rarity:"hidden"})},o.card_id)}return e.jsx("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2 overflow-y-auto",children:e.jsx("ul",{className:"space-y-1",children:d.map(r)})})};function G(t){return t?e.jsx(k,{card_id:t.card_id,details:"hidden"}):"—"}const Ue=({yourId:t,friendId:n,yourCard:s,friendCard:d,setYourCard:r,setFriendCard:o})=>{const{t:i}=N("trade-matches"),{toast:m}=Z(),u=re(),c=s&&d&&s.rarity===d.rarity;async function l(){if(!c)return;const x={offering_friend_id:t,receiving_friend_id:n,offer_card_id:s.card_id,receiver_card_id:d.card_id,status:"offered"};try{u.mutate(x)}catch(p){console.log("TradeOffer: Error inserting trade",p),m({title:i("tradeFailed"),variant:"default"})}r(null),o(null),m({title:i("tradeOffered"),variant:"default"}),M("Offer trade")}return!s&&!d?e.jsx("div",{className:"sticky top-0 z-10 flex rounded-lg border-1 bg-neutral-900 border-neutral-700 border-solid p-2 w-full items-center justify-around text-center h-[166px] sm:h-[110px]",children:e.jsx("h4",{className:"text-lg font-medium",children:i("selectCardsToTrade")})}):e.jsxs("div",{className:"sticky top-0 z-10 bg-neutral-900 rounded-lg border-1 border-neutral-700 border-solid p-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-x-4 gap-y-1 p-1",children:[e.jsxs("div",{className:"w-full sm:w-1/2",children:[e.jsx("h4",{className:"text-lg font-medium",children:i("youGive")}),G(s)]}),e.jsxs("div",{className:"w-full sm:w-1/2",children:[e.jsx("h4",{className:"text-lg font-medium",children:i("youReceive")}),G(d)]})]}),e.jsx(j,{className:"block w-full sm:w-96 mx-auto mt-1 text-center",type:"button",variant:"outline",onClick:l,disabled:!c,children:i("offerTrades")})]})};function Y(t,n){const s=new Set(n),d=t.filter(r=>s.has(r)).map(r=>$(r)).filter(r=>L.includes(r.rarity)&&de.includes(r.expansion));return Object.groupBy(d,r=>r.rarity)}function Be(){const{t}=N(["trade-matches","common"]),{friendId:n}=ae(),[s]=ne(),{data:d,isLoading:r,isError:o}=q(n),{data:i=new Map,isLoading:m,isError:u}=ie(n),{data:c}=S(),{data:l=new Map}=J(),[x,p]=b.useState(null),[v,h]=b.useState(()=>{const f=s.get("friend_card");return f?$(Number(f))??null:null});if(b.useEffect(()=>{const f=s.get("friend_card");if(!f||!i||!l)return;const T=$(Number(f));if(!T)return;const y=document.getElementById(T.rarity);y&&y.scrollIntoView({behavior:"smooth"})},[s,i,l]),!c)return null;if(d===null)return e.jsx("p",{className:"text-xl text-center py-8",children:t("notFound")});if(o||u)return e.jsx("p",{className:"text-xl text-center py-8",children:t("common:error")});if(r||m)return e.jsx("div",{className:"mx-auto mt-12 animate-spin rounded-full size-12 border-4 border-white border-t-transparent"});if(!d?.is_active_trading)return e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-xl ",children:t("inActiveTradePage",{username:d?.username})}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:t("inActiveTradeDescription")})]});const _=Y(H(l,c.trade_rarity_settings),R(i,d.trade_rarity_settings)),a=Y(H(i,d.trade_rarity_settings),R(l,c.trade_rarity_settings)),g=L.some(f=>(_[f]??[]).length>0&&(a[f]??[]).length>0);return e.jsxs("div",{className:"kap-4 justify-center w-full m-auto px-1 sm:px-2",children:[e.jsx("title",{children:`Trade with ${d.username} – TCG Pocket Collection Tracker`}),e.jsxs("div",{className:"mb-4 mx-1 flex justify-between",children:[e.jsxs("h1",{children:[e.jsx("span",{className:"text-2xl font-light",children:t("tradingWith")}),e.jsxs("span",{className:"text-2xl font-bold",children:[" ",d.username," "]}),e.jsx("span",{className:"block sm:inline text-sm",children:e.jsx(X,{friendId:d.friend_id})})]}),e.jsx(O,{to:`/collection/${n}`,children:e.jsxs(j,{children:["Collection",e.jsx(z,{})]})})]}),e.jsx(Ue,{yourId:c.friend_id,friendId:d.friend_id,yourCard:x,friendCard:v,setYourCard:p,setFriendCard:h}),!g&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-xl ",children:t("noPossibleTrades")}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:t("noPossibleTradesDescription")})]}),L.map(f=>e.jsxs("div",{className:"mt-4",children:[e.jsxs("h3",{id:f,className:"text-xl font-semibold mb-2 text-center",children:["[ ",f," ]"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-4",children:[e.jsxs("div",{className:"w-full sm:w-1/2",children:[e.jsx("h4",{className:"text-md font-medium mb-1 ml-2",children:t("youHave")}),_[f]?e.jsx(W,{cards:_[f],selected:x,setSelected:p}):e.jsx("div",{className:"text-center text-neutral-500 rounded-lg border-1 border-neutral-700 border-solid p-2",children:"No cards to trade"})]}),e.jsxs("div",{className:"w-full sm:w-1/2",children:[e.jsx("h4",{className:"text-md font-medium mb-1 ml-2",children:t("friendHas")}),a[f]?e.jsx(W,{cards:a[f],selected:v,setSelected:h}):e.jsx("div",{className:"text-center text-neutral-500  rounded-lg border-1 border-neutral-700 border-solid p-2",children:"No cards to trade"})]})]})]},f))]})}function De(){const{t}=N(["trade-matches","common"]),n=b.useRef(null),[s,d]=b.useState(""),[r,o]=b.useState(),[i,m]=b.useState(!1),u=b.useMemo(()=>ke({search:s,rarity:[...L]},new Map),[s]),{data:c,isLoading:l,isError:x}=ce(i,r),p=Se({getScrollElement:()=>n.current,count:u.length,getItemKey:h=>u[h].card_id,estimateSize:()=>32});if(!i)return e.jsxs("div",{className:"sm:w-sm mx-auto",children:[e.jsx(we,{setValue:d}),e.jsx("div",{ref:n,className:"my-2 h-96 rounded border border-neutral-700 px-1 overflow-y-auto",children:e.jsx("ul",{style:{height:`${p.getTotalSize()}px`},className:"relative",children:p.getVirtualItems().map(h=>{const _=u[h.index];return e.jsx("button",{type:"button",className:"absolute top-0 left-0 w-full cursor-pointer",style:{height:`${h.size}px`,transform:`translateY(${h.start}px)`},onClick:()=>o(a=>a===_.internal_id?void 0:_.internal_id),children:e.jsx(k,{className:`w-full ${r===_.internal_id&&"bg-green-900"} hover:bg-neutral-600`,card_id:_.card_id})},h.key)})})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{className:"w-1/2",disabled:!r,onClick:()=>{m(!0)},children:r?`Search ${$(r)?.name}`:"Select card to search"}),e.jsx(j,{className:"w-1/2",onClick:()=>{o(void 0),m(!0)},children:"Search all cards"})]})]});if(l)return e.jsxs("p",{className:"text-xl text-center py-8",children:[t("common:loading"),e.jsx("br",{}),t("longOperation")]});if(x||!c)return e.jsx("p",{className:"text-xl text-center py-8",children:t("common:error")});if(c.length===0)return e.jsx("p",{className:"text-xl text-center py-8",children:t("noTradePartners")});const v=r?`?friend_card=${r}`:"";return e.jsx("div",{className:"flex flex-col gap-4",children:c.map(h=>e.jsxs("div",{className:"max-w-md w-full flex justify-between items-center mx-auto px-4",children:[e.jsx("p",{className:"mr-2",children:h.username}),e.jsx(O,{to:`/trade/${h.friend_id}${v}`,children:e.jsxs(j,{variant:"outline",className:"my-auto",children:[t("viewTradePartner",{tradeMatches:h.trade_matches}),e.jsx(z,{})]})})]},h.friend_id))})}const Ve=({row:t,selectedTradeId:n,setSelectedTradeId:s})=>{const{t:d}=N("trade-matches"),{data:r,isLoading:o}=S();if(o)return null;if(!r)return e.jsx("p",{className:"text-xl text-center py-8",children:d("common:error")});const i=t.offering_friend_id===r.friend_id?t.offer_card_id:t.receiver_card_id,m=t.offering_friend_id===r.friend_id?t.receiver_card_id:t.offer_card_id;function u(l){n===l.id?s(void 0):s(l.id)}const c=l=>{const x={offered:l.offering_friend_id===r.friend_id?e.jsx(He,{className:"bg-amber-600"}):e.jsx(Pe,{className:"bg-amber-600"}),accepted:e.jsx(ze,{className:"bg-lime-600"}),declined:e.jsx(me,{className:"bg-stone-600"}),finished:e.jsx(oe,{className:"bg-indigo-600"})};return e.jsxs(e.Fragment,{children:[e.jsx(E,{id:`status-${l.id}`}),e.jsx(le,{className:"rounded-full p-[3px] my-auto","data-tooltip-id":`status-${l.id}`,"data-tooltip-content":d(`status.${l.status}`),children:x[l.status]})]})};return e.jsxs("li",{className:`flex cursor-pointer rounded gap-1 md:gap-2 p-1 ${n===t.id&&"bg-green-900"} hover:bg-neutral-500`,onClick:()=>u(t),children:[c(t),e.jsxs("div",{className:"flex flex-col md:flex-row grow-1 justify-between gap-1 md:gap-2",children:[e.jsx(k,{className:"md:w-1/2",card_id:i,increment:-1}),e.jsx(k,{className:"md:w-1/2",card_id:m,increment:1})]})]})};function Ke({trades:t,viewHistory:n}){const{t:s}=N("trade-matches"),{toast:d}=Z(),{data:r}=S(),{data:o=new Map}=J(),i=ue();function m(a){return a.offering_friend_id===r?.friend_id&&!a.offerer_ended||a.receiving_friend_id===r?.friend_id&&!a.receiver_ended}const u=n?t.filter(a=>!m(a)):t.filter(m),[c,l]=b.useState(void 0),x=fe();if(!r)return null;const p=(a,g)=>{const f=xe(a);return{card_id:a,internal_id:f,amount_owned:(o.get(f)?.amount_owned??0)+g}},v=async a=>{if(a.offer_card_id!==a.receiver_card_id)if(a.offering_friend_id===r.friend_id){const g=[p(a.offer_card_id,-1),p(a.receiver_card_id,1)];i.mutate({updates:g}),d({title:s("collectionUpdated"),variant:"default"})}else if(a.receiving_friend_id===r.friend_id){const g=[p(a.offer_card_id,1),p(a.receiver_card_id,-1)];i.mutate({updates:g}),d({title:s("collectionUpdated"),variant:"default"})}else console.log(a,"can't match friend id")},h=a=>{const g=async y=>{x.mutate({id:a.id,trade:{status:y}}),l(a.id),M(`Updated trade: ${y}`)},f=async()=>{const y=a.offering_friend_id===r.friend_id?{offerer_ended:!0}:a.receiving_friend_id===r.friend_id?{receiver_ended:!0}:null;if(y===null){console.log(a," doesn't match your friend_id");return}x.mutate({id:a.id,trade:y}),l(void 0),M("Updated trade: ended")},T=a.offering_friend_id===r.friend_id&&a.offerer_ended||a.receiving_friend_id===r.friend_id&&a.receiver_ended;switch(a.status){case"offered":return e.jsxs(e.Fragment,{children:[a.receiving_friend_id===r.friend_id&&e.jsx(j,{type:"button",onClick:async()=>g("accepted"),children:s("actionAccept")}),e.jsx(j,{type:"button",onClick:async()=>g("declined"),children:a.receiving_friend_id===r.friend_id?s("actionDecline"):s("actionCancel")})]});case"accepted":return e.jsxs(e.Fragment,{children:[e.jsx(j,{type:"button",onClick:async()=>g("finished"),children:s("actionComplete")}),e.jsx(j,{type:"button",onClick:async()=>g("declined"),children:s("actionCancel")})]});case"declined":return T?null:e.jsx(j,{type:"button",onClick:f,children:s("actionHide")});case"finished":return T?null:e.jsxs(e.Fragment,{children:[e.jsx(j,{type:"button",onClick:async()=>{await v(a),await f()},children:s("actionUpdate")}),e.jsx(j,{type:"button",onClick:f,children:s("actionHide")})]});default:return console.log(`Unknown trade status ${a.status}`),null}},_=u.find(a=>a.id===c);return u.length===0?null:e.jsxs("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-1 md:p-2",children:[e.jsxs("div",{className:"hidden md:flex pr-1",children:[e.jsx("h4",{className:"text-lg font-medium w-1/2 ml-8",children:s("youGive")}),e.jsx("h4",{className:"text-lg font-medium w-1/2 ml-8",children:s("youReceive")})]}),e.jsx("ul",{className:"flex flex-col gap-2 md:gap-0",children:u.toSorted((a,g)=>a.created_at>g.created_at?-1:1).map(a=>e.jsx(Ve,{row:a,selectedTradeId:c,setSelectedTradeId:l},a.id))}),_&&e.jsx("div",{className:"flex gap-4 text-center items-center mt-2",children:h(_)})]})}function We({friendId:t}){const{t:n}=N(["trade-matches","common"]),{data:s,isLoading:d}=Q(),{data:r,isLoading:o}=q(t),[i,m]=b.useState(!1);if(d||o)return null;if(!s)return e.jsx("p",{className:"text-xl text-center py-8",children:n("common:error")});const u=s.filter(c=>c.offering_friend_id===t||c.receiving_friend_id===t);return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1 mx-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-md",children:n("tradingWith")}),e.jsxs("span",{className:"text-md font-bold",children:[" ",r?.username||"unknown"," "]}),r&&e.jsx(X,{friendId:r.friend_id,showFriendId:!1,className:"ml-1"})]}),e.jsxs("span",{className:"flex gap-4",children:[e.jsxs("label",{htmlFor:`history-${t}`,className:"my-auto flex items-center",children:[n("viewHistory"),e.jsx(ee,{id:`history-${t}`,className:"ml-2 my-auto",checked:i,onCheckedChange:m})]}),e.jsx(O,{to:`/trade/${t}`,children:e.jsxs(j,{variant:"outline",className:"my-auto",children:[n("openTradeWith"),e.jsx(z,{})]})})]})]}),r!==null&&e.jsx(Ke,{trades:u,viewHistory:i})]})}function Ge(){const{t}=N(["trade-matches","common"]),{data:n,isLoading:s}=S(),{data:d,isLoading:r}=Q();if(s||r)return e.jsx("div",{className:"mx-auto mt-12 animate-spin rounded-full size-12 border-4 border-white border-t-transparent"});if(!d||!n)return e.jsx("p",{className:"text-xl text-center py-8",children:t("common:error")});if(d.length===0)return e.jsx("p",{children:t("noTradeOffers")});const o=Ze(d,n.friend_id),i=Object.fromEntries(Object.entries(o).map(([c,l])=>[c,+(Ye(l,n.friend_id).length===0)])),m=Object.fromEntries(Object.entries(o).map(([c,l])=>[c,Math.max(...l.map(x=>new Date(x.updated_at).getTime()))])),u=Object.keys(o).toSorted((c,l)=>i[c]!==i[l]?i[c]-i[l]:m[l]-m[c]);return e.jsx("div",{className:"flex flex-col items-center mx-auto gap-6 sm:px-4 mb-12 w-full",children:u.map(c=>e.jsx(We,{friendId:c},c))})}function Ye(t,n){return t.filter(s=>s.offering_friend_id===n?!s.offerer_ended:!s.receiver_ended)}function Ze(t,n){return Object.groupBy(t,s=>s.offering_friend_id===n?s.receiving_friend_id:s.receiving_friend_id===n?s.offering_friend_id:(console.log("Fetched row does not match user friend_id",s),"undefined"))}function qe(){const{t}=N("trade-matches"),{data:n}=S(),s=he(),d=U({is_active_trading:je(),trade_rarity_settings:pe(U({rarity:ge(_e),to_collect:K().min(0).max(100),to_keep:K().min(0).max(100)}))}),r=$e({resolver:Le(d),values:{is_active_trading:n?.is_active_trading||!1,trade_rarity_settings:n?.trade_rarity_settings||[]}}),o=async i=>{s.mutate({username:n?.username,is_active_trading:i.is_active_trading,trade_rarity_settings:i.trade_rarity_settings},{onSuccess:()=>D({title:t("accountSaved"),variant:"default"}),onError:m=>{console.error("error saving account",m),D({title:t("errorSavingAccount"),variant:"destructive"})}})};return!n||!n.username?e.jsx(Me,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:t("noAccount")}):e.jsxs("div",{children:[e.jsx(Fe,{...r,children:e.jsxs("form",{onSubmit:r.handleSubmit(o),className:"rounded-md border-1 border-neutral-700 space-y-2 p-4 mx-auto max-w-xl",children:[e.jsx("h2",{className:"text-xl text-center mb-6",children:"Trading settings"}),e.jsx(F,{control:r.control,name:"is_active_trading",render:({field:i})=>e.jsx(I,{className:"flex flex-col items-start",children:e.jsx(A,{children:e.jsxs(Ie,{className:"flex",children:[t("isActiveTrading"),e.jsx(ee,{className:"ml-2",checked:i.value,onCheckedChange:i.onChange})]})})})}),e.jsxs("div",{className:"grid grid-cols-3 gap-y-2 gap-x-8 w-fit mt-6",children:[e.jsx("span",{children:t("rarity")}),e.jsxs("span",{className:"flex items-center",children:[t("toCollect"),e.jsx(E,{id:"to-collect"}),e.jsx(V,{className:"size-4 ml-1","data-tooltip-id":"to-collect","data-tooltip-content":t("toCollectTooltip")})]}),e.jsxs("span",{className:"flex items-center",children:[t("toKeep"),e.jsx(E,{id:"to-collect"}),e.jsx(V,{className:"size-4 ml-1","data-tooltip-id":"to-collect","data-tooltip-content":t("toKeepTooltip")})]}),r.watch("trade_rarity_settings").map((i,m)=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1",children:i.rarity},`label-${i.rarity}`),e.jsx(F,{control:r.control,name:`trade_rarity_settings.${m}.to_collect`,render:({field:u})=>e.jsx(I,{className:"flex-1",children:e.jsx(A,{children:e.jsx(B,{className:"w-24",type:"number",...u})})})},`to-collect-${i.rarity}`),e.jsx(F,{control:r.control,name:`trade_rarity_settings.${m}.to_keep`,render:({field:u})=>e.jsx(I,{className:"flex-1",children:e.jsx(A,{children:e.jsx(B,{className:"w-24",type:"number",...u})})})},`to-keep-${i.rarity}`)]}))]}),e.jsxs(j,{type:"submit",className:"block ml-auto mt-4",disabled:s.isPending,children:[t("save"),s.isPending&&e.jsx("div",{className:"ml-2 inline-block animate-spin rounded-full size-4 border-2 border-black border-t-transparent"})]})]})}),e.jsx(Ae,{className:"mt-4 mx-auto w-fit"})]})}function lt(){const{t}=N("trade-matches"),n=be(),s=Ne(),d=n.pathname.split("/").pop()||"offers";return b.useEffect(()=>{n.pathname==="/trade"&&s("/trade/offers")},[n.pathname,s]),e.jsxs(Ce,{className:"flex flex-col mx-auto max-w-[900px]",value:d,onValueChange:r=>s(`/trade/${r}`),children:[e.jsxs(Te,{className:"gap-4 mb-6 rounded-lg border-b-1 border-neutral-700 border-solid dark:bg-transparent pb-2",children:[e.jsx(w,{className:"text-md",value:"cards",children:t("tabCards")}),e.jsx(w,{className:"text-md",value:"offers",children:t("tabOffers")}),e.jsx(w,{className:"text-md",value:"matches",children:t("tabMatches")}),e.jsx(w,{className:"text-md",value:"settings",children:t("tabSettings")})]}),e.jsxs(ve,{children:[e.jsx(C,{path:"/",element:e.jsx(ye,{to:"/trade/offers",replace:!0})}),e.jsx(C,{path:"cards",element:e.jsx("p",{children:"You can now manage your trading cards on your collection page."})}),e.jsx(C,{path:"offers",element:e.jsx(Ge,{})}),e.jsx(C,{path:"matches",element:e.jsx(De,{})}),e.jsx(C,{path:"settings",element:e.jsx(qe,{})}),e.jsx(C,{path:":friendId",element:e.jsx(Be,{})})]})]})}export{lt as default};
