import{c as O,r as u,k as N,j as o,m as D,X as E,aX as k,I as L,U as P,C as X,B as M,M as $}from"./index-C9JvFCST.js";/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],B=O("plus",U);function R({selected:t,setIsSelected:m,card:p,size:g="default"}){const n=u.useRef(null),[e,c]=u.useState({x:0,y:0}),[s,d]=u.useState(!1),l=u.useRef(T(i=>c(i),50)),a=i=>{l.current({x:i.clientX,y:i.clientY})},f=u.useCallback(()=>{d(!0),window.addEventListener("mousemove",a)},[]),w=u.useCallback(()=>{d(!1),window.removeEventListener("mousemove",a)},[]);let v=0,h=0;if(n.current&&s){const i=n.current.getBoundingClientRect(),_=i.left+i.width/2,y=i.top+i.height/2;v=e.x-_,h=e.y-y}const b=(i,_,y)=>Math.min(Math.max(i,_),y),S=s?b(v/4,-10,10):0,j=s?b(-h/4,-10,10):0,r={transform:`perspective(1000px)
                   rotateY(${S}deg)
                   rotateX(${j}deg)
                   scale(${s?1.04:1})`,transition:"transform 0.3s cubic-bezier(0.17, 0.67, 0.5, 1.03)",transformStyle:"preserve-3d",opacity:t?1:.5,width:g==="small"?"80px":"100%",height:g==="small"?"112px":"auto"},x=p.image?.split("/").at(-1),C=`/images/${N.language}/${x}`;return o.jsx("div",{style:{flex:"1 0 20%",perspective:"1000px",transformStyle:typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes("firefox")?"flat":"preserve-3d",display:"flex",justifyContent:"center",alignItems:"center",zIndex:s?10:0},children:x&&o.jsx("img",{draggable:!1,loading:"lazy",onMouseDown:()=>m?.(!t),ref:n,className:"card-test",style:r,src:C,alt:D(p,N.language),onMouseEnter:f,onMouseLeave:w,onError:i=>{i.target.src=p.image}})})}const T=(t,m)=>{let p=0,g=null;return(...n)=>{const e=performance.now(),c=e-p;if(c<m){g||(g=setTimeout(()=>{p=performance.now(),g=null,t(...n)},m-c));return}p=e,t(...n)}},I={};function z({card:t,onImageClick:m,className:p,editable:g=!0}){const n=L(),{user:e,setIsLoginDialogOpen:c}=u.use(P),{ownedCards:s,setOwnedCards:d,setSelectedCardId:l}=u.use(X),[a,f]=u.useState(t.amount_owned||0),[w,v]=u.useState(0);u.useEffect(()=>{v(a)},[a]);const h=u.useCallback(async(r,x)=>{const C=Math.max(0,x);f(C),I[r]&&window.clearTimeout(I[r]),I[r]=window.setTimeout(async()=>{if(!e||!e.user.email)throw new Error("User not logged in");const i=s.find(y=>y.card_id===r);i?i.amount_owned=C:s.push({email:e.user.email,card_id:r,amount_owned:C,updated_at:new Date().toISOString()});const{error:_}=await E.from("collection").upsert({card_id:r,amount_owned:C,email:e.user.email,updated_at:new Date().toISOString()});if(_)throw new Error("Error updating collection");k(s,e.user.email)},1e3)},[s,e,d,a]),b=u.useCallback(async r=>{if(!e){c(!0);return}await h(r,a+1)},[h]),S=u.useCallback(async r=>{if(!e){c(!0);return}await h(r,a-1)},[h]),j=async r=>{const x=r.target.value===""?0:Number.parseInt(r.target.value,10);!Number.isNaN(x)&&x>=0&&await h(t.card_id,x)};return t.linkedCardID?null:o.jsxs("div",{className:`group flex flex-col items-center rounded-lg ${p}`,children:[o.jsx("button",{type:"button",className:"cursor-pointer",onClick:()=>{l(t.card_id),m?.()},children:o.jsx(R,{card:t,selected:a>0})}),o.jsxs("p",{className:"w-full min-w-0 text-[12px] pt-2 text-center font-semibold leading-tight",children:[o.jsx("span",{className:"block md:inline",children:t.card_id}),o.jsx("span",{className:"hidden md:inline",children:" â€“ "}),o.jsx("span",{className:"block md:inline truncate",children:D(t,N.language)})]}),o.jsx("div",{className:"flex items-center gap-x-1",children:g&&!n.friendId?o.jsxs(o.Fragment,{children:[o.jsx(M,{variant:"ghost",size:"icon",onClick:()=>S(t.card_id),className:"rounded-full",tabIndex:-1,children:o.jsx($,{})}),o.jsx("input",{min:"0",max:"99",type:"text",disabled:!!n.friendId,value:w,onChange:j,className:"w-7 text-center border-none rounded",onFocus:r=>r.target.select()}),o.jsx(M,{variant:"ghost",size:"icon",className:"rounded-full",onClick:()=>b(t.card_id),tabIndex:-1,children:o.jsx(B,{})})]}):o.jsx("span",{className:"mt-1",children:a})})]})}const A=async(t,m,p,g,n)=>{if(!n||!n.user.email)throw new Error("User not logged in");if(m<0)throw new Error("New amount cannot be negative");const e=[...p],c=t.map(d=>({card_id:d,amount_owned:m,email:n.user.email,updated_at:new Date().toISOString()})),{error:s}=await E.from("collection").upsert(c);if(s)throw new Error("Error bulk updating collection");k(e,n.user.email);for(const d of t){const l=e.find(a=>a.card_id===d);l?(console.log("Updating existing card:",d),l.amount_owned=m):l||(console.log("Adding new card:",d),e.push({email:n.user.email,card_id:d,amount_owned:m,updated_at:new Date().toISOString()}))}g([...e])},F=async(t,m,p,g,n)=>{if(!n||!n.user.email)throw new Error("User not logged in");const e=new Map;for(const l of t)e.set(l,(e.get(l)||0)+m);const c=[...p],s=[];for(const[l,a]of e){const f=c.find(w=>w.card_id===l);if(f)console.log("Incrementing existing card:",l,"from",f.amount_owned,"to",f.amount_owned+a),f.amount_owned+=a,f.updated_at=new Date().toISOString(),s.push(f);else if(!f&&a>0){console.log("Adding new card:",l,"with amount",a);const w={email:n.user.email,card_id:l,amount_owned:a,updated_at:new Date().toISOString()};c.push(w),s.push(w)}}const{error:d}=await E.from("collection").upsert(s);if(d)throw new Error(`Error bulk updating collection: ${d.message}`);return k(c,n.user.email),g([...c]),s};export{z as C,R as F,B as P,F as i,A as u};
