import{e as P,a0 as te,a1 as se,j as e,f as N,a2 as Z,a3 as ae,D as g,a4 as M,N as re,B as ne,O as q,P as ie,C as S,p as J,r as _,U as L,a5 as R,a6 as H,a7 as $,L as O,a8 as de,a9 as ce,J as le,v as oe,aa as me,ab as ue,ac as fe,ad as xe,ae as he,af as pe,ag as Q,ah as ge,ai as U,aj as je,ak as _e,al as be,Z as B,E as D,K as Ne,am as ve,M as ye,an as Ce,ao as C,ap as Te}from"./index-ClbyXLjL.js";import{T as ke,a as Se,b as w}from"./tabs-D2dMPEzQ.js";import{F as X}from"./friend-id-display-2n13HkDf.js";import{C as k}from"./CardLine-CHgZU9L_.js";import{C as z}from"./chevron-right-BqPbAOle.js";import{g as we,u as Le}from"./filters-CsbEw4ku.js";import{S as $e}from"./SearchInput-8UAaaJ83.js";import{S as ee,u as Fe,a as Ie,F as Ae,b as F,c as I,d as A,e as Me,f as Ee}from"./form-BdPUyTBm.js";import{M as E,C as V}from"./react-tooltip.min-CBgzpNjU.js";import{A as Pe}from"./alert-B6eNStZn.js";import"./index-cIQ_qWQ3.js";import"./index-B6TGjb7_.js";const Oe=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],ze=P("arrow-left",Oe);const Re=[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]],He=P("arrow-right-left",Re);const Ue=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]],Be=P("arrow-right",Ue);function K(t){return te(se,t)}const W=({cards:t,selected:n,setSelected:a})=>{const d=[...t].sort((o,i)=>{const m=l=>{const h=l.split("-"),j=h[0]||"",b=h.length>1?parseInt(h[1],10):0;return{setName:j,cardNumber:b}},u=m(o.card_id),c=m(i.card_id);return u.setName!==c.setName?u.setName.localeCompare(c.setName):u.cardNumber-c.cardNumber});function s(o){function i(){n?.card_id===o.card_id?a(null):a(o)}return e.jsx("li",{className:"rounded cursor-pointer",onClick:i,children:e.jsx(k,{className:`w-full ${n?.card_id===o.card_id&&"bg-green-900"} hover:bg-neutral-600`,card_id:o.card_id,rarity:"hidden"})},o.card_id)}return e.jsx("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2 overflow-y-auto",children:e.jsx("ul",{className:"space-y-1",children:d.map(s)})})};function G(t){return t?e.jsx(k,{card_id:t.card_id,details:"hidden"}):"—"}const De=({yourId:t,friendId:n,yourCard:a,friendCard:d,setYourCard:s,setFriendCard:o})=>{const{t:i}=N("trade-matches"),{toast:m}=Z(),u=ae(),c=a&&d&&a.rarity===d.rarity;async function l(){if(!c)return;const h={offering_friend_id:t,receiving_friend_id:n,offer_card_id:a.card_id,receiver_card_id:d.card_id,status:"offered"};try{u.mutate(h)}catch(j){console.log("TradeOffer: Error inserting trade",j),m({title:i("tradeFailed"),variant:"default"})}s(null),o(null),m({title:i("tradeOffered"),variant:"default"}),M("Offer trade")}return!a&&!d?e.jsx("div",{className:"sticky top-0 z-10 flex rounded-lg border-1 bg-neutral-900 border-neutral-700 border-solid p-2 w-full items-center justify-around text-center h-[166px] sm:h-[110px]",children:e.jsx("h4",{className:"text-lg font-medium",children:i("selectCardsToTrade")})}):e.jsxs("div",{className:"sticky top-0 z-10 bg-neutral-900 rounded-lg border-1 border-neutral-700 border-solid p-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-x-4 gap-y-1 p-1",children:[e.jsxs("div",{className:"w-full sm:w-1/2",children:[e.jsx("h4",{className:"text-lg font-medium",children:i("youGive")}),G(a)]}),e.jsxs("div",{className:"w-full sm:w-1/2",children:[e.jsx("h4",{className:"text-lg font-medium",children:i("youReceive")}),G(d)]})]}),e.jsx(g,{className:"block w-full sm:w-96 mx-auto mt-1 text-center",type:"button",variant:"outline",onClick:l,disabled:!c,children:i("offerTrades")})]})};function Y(t,n){const a=new Set(n),d=t.filter(s=>a.has(s)).map(s=>L(s)).filter(s=>$.includes(s.rarity)&&de.includes(s.expansion));return Object.groupBy(d,s=>s.rarity)}function Ve(){const{t}=N(["trade-matches","common"]),{friendId:n}=re(),[a]=ne(),{data:d,isLoading:s,isError:o}=q(n),{data:i=new Map,isLoading:m,isError:u}=ie(n),{data:c}=S(),{data:l=new Map}=J(),[h,j]=_.useState(null),[b,y]=_.useState(()=>{const f=a.get("friend_card");return f?L(Number(f))??null:null});if(_.useEffect(()=>{const f=a.get("friend_card");if(!f||!i||!l)return;const T=L(Number(f));if(!T)return;const v=document.getElementById(T.rarity);v&&v.scrollIntoView({behavior:"smooth"})},[a,i,l]),!c)return null;if(d===null)return e.jsx("p",{className:"text-xl text-center py-8",children:t("notFound")});if(o||u)return e.jsx("p",{className:"text-xl text-center py-8",children:t("common:error")});if(s||m)return e.jsx("div",{className:"mx-auto mt-12 animate-spin rounded-full size-12 border-4 border-white border-t-transparent"});if(!d?.is_active_trading)return e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-xl ",children:t("inActiveTradePage",{username:d?.username})}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:t("inActiveTradeDescription")})]});const x=Y(H(l,c.trade_rarity_settings),R(i,d.trade_rarity_settings)),r=Y(H(i,d.trade_rarity_settings),R(l,c.trade_rarity_settings)),p=$.some(f=>(x[f]??[]).length>0&&(r[f]??[]).length>0);return e.jsxs("div",{className:"kap-4 justify-center w-full m-auto px-1 sm:px-2",children:[e.jsx("title",{children:`Trade with ${d.username} – TCG Pocket Collection Tracker`}),e.jsxs("div",{className:"mb-4 mx-1 flex justify-between",children:[e.jsxs("h1",{children:[e.jsx("span",{className:"text-2xl font-light",children:t("tradingWith")}),e.jsxs("span",{className:"text-2xl font-bold",children:[" ",d.username," "]}),e.jsx("span",{className:"block sm:inline text-sm",children:e.jsx(X,{friendId:d.friend_id})})]}),e.jsx(O,{to:`/collection/${n}`,children:e.jsxs(g,{children:["Collection",e.jsx(z,{})]})})]}),e.jsx(De,{yourId:c.friend_id,friendId:d.friend_id,yourCard:h,friendCard:b,setYourCard:j,setFriendCard:y}),!p&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-xl ",children:t("noPossibleTrades")}),e.jsx("p",{className:"text-sm text-gray-300 mt-2",children:t("noPossibleTradesDescription")})]}),$.map(f=>e.jsxs("div",{className:"mt-4",children:[e.jsxs("h3",{id:f,className:"text-xl font-semibold mb-2 text-center",children:["[ ",f," ]"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-4",children:[e.jsxs("div",{className:"w-full sm:w-1/2",children:[e.jsx("h4",{className:"text-md font-medium mb-1 ml-2",children:t("youHave")}),x[f]?e.jsx(W,{cards:x[f],selected:h,setSelected:j}):e.jsx("div",{className:"text-center text-neutral-500 rounded-lg border-1 border-neutral-700 border-solid p-2",children:"No cards to trade"})]}),e.jsxs("div",{className:"w-full sm:w-1/2",children:[e.jsx("h4",{className:"text-md font-medium mb-1 ml-2",children:t("friendHas")}),r[f]?e.jsx(W,{cards:r[f],selected:b,setSelected:y}):e.jsx("div",{className:"text-center text-neutral-500  rounded-lg border-1 border-neutral-700 border-solid p-2",children:"No cards to trade"})]})]})]},f))]})}function Ke(){const{t}=N(["trade-matches","common"]),n=_.useRef(null),[a,d]=_.useState(""),[s,o]=_.useState(),[i,m]=_.useState(!1),u=_.useMemo(()=>we({search:a,rarity:[...$]},new Map),[a]),c=_.useMemo(()=>s&&L(s),[s]),{data:l,isLoading:h,isError:j}=ce(i,s),b=Le({getScrollElement:()=>n.current,count:u.length,getItemKey:x=>u[x].card_id,estimateSize:()=>32});if(s&&!c)throw new Error("Card selected was not found in the database!");if(!i)return e.jsxs("div",{className:"sm:w-sm mx-auto",children:[e.jsx($e,{setValue:d}),e.jsx("div",{ref:n,className:"my-2 h-96 rounded border border-neutral-700 px-1 overflow-y-auto",children:e.jsx("ul",{style:{height:`${b.getTotalSize()}px`},className:"relative",children:b.getVirtualItems().map(x=>{const r=u[x.index];return e.jsx("button",{type:"button",className:"absolute top-0 left-0 w-full cursor-pointer",style:{height:`${x.size}px`,transform:`translateY(${x.start}px)`},onClick:()=>o(p=>p===r.internal_id?void 0:r.internal_id),children:e.jsx(k,{className:`w-full ${s===r.internal_id&&"bg-green-900"} hover:bg-neutral-600`,card_id:r.card_id})},x.key)})})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{className:"w-1/2",disabled:!s,onClick:()=>{m(!0)},children:c?t("search.byCard",{cardName:le(c,oe.language)}):t("search.selectCard")}),e.jsx(g,{className:"w-1/2",onClick:()=>{o(void 0),m(!0)},children:t("search.allCards")})]})]});if(h)return e.jsxs("p",{className:"text-xl text-center py-8",children:[t("common:loading"),e.jsx("br",{}),t("longOperation")]});if(j||!l)return e.jsx("p",{className:"text-xl text-center py-8",children:t("common:error")});if(l.length===0)return e.jsx("p",{className:"text-xl text-center py-8",children:t("noTradePartners")});const y=s?`?friend_card=${s}`:"";return e.jsx("div",{className:"flex flex-col gap-4",children:l.map(x=>e.jsxs("div",{className:"max-w-md w-full flex justify-between items-center mx-auto px-4",children:[e.jsx("p",{className:"mr-2",children:x.username}),e.jsx(O,{to:`/trade/${x.friend_id}${y}`,children:e.jsxs(g,{variant:"outline",className:"my-auto",children:[t("viewTradePartner",{tradeMatches:x.trade_matches}),e.jsx(z,{})]})})]},x.friend_id))})}const We=({row:t,selectedTradeId:n,setSelectedTradeId:a})=>{const{t:d}=N("trade-matches"),{data:s,isLoading:o}=S();if(o)return null;if(!s)return e.jsx("p",{className:"text-xl text-center py-8",children:d("common:error")});const i=t.offering_friend_id===s.friend_id?t.offer_card_id:t.receiver_card_id,m=t.offering_friend_id===s.friend_id?t.receiver_card_id:t.offer_card_id;function u(l){n===l.id?a(void 0):a(l.id)}const c=l=>{const h={offered:l.offering_friend_id===s.friend_id?e.jsx(Be,{className:"bg-amber-600"}):e.jsx(ze,{className:"bg-amber-600"}),accepted:e.jsx(He,{className:"bg-lime-600"}),declined:e.jsx(fe,{className:"bg-stone-600"}),finished:e.jsx(ue,{className:"bg-indigo-600"})};return e.jsxs(e.Fragment,{children:[e.jsx(E,{id:`status-${l.id}`}),e.jsx(me,{className:"rounded-full p-[3px] my-auto","data-tooltip-id":`status-${l.id}`,"data-tooltip-content":d(`status.${l.status}`),children:h[l.status]})]})};return e.jsxs("li",{className:`flex cursor-pointer rounded gap-1 md:gap-2 p-1 ${n===t.id&&"bg-green-900"} hover:bg-neutral-500`,onClick:()=>u(t),children:[c(t),e.jsxs("div",{className:"flex flex-col md:flex-row grow-1 justify-between gap-1 md:gap-2",children:[e.jsx(k,{className:"md:w-1/2",card_id:i,increment:-1}),e.jsx(k,{className:"md:w-1/2",card_id:m,increment:1})]})]})};function Ge({trades:t,viewHistory:n}){const{t:a}=N("trade-matches"),{toast:d}=Z(),{data:s}=S(),{data:o=new Map}=J(),i=xe();function m(r){return r.offering_friend_id===s?.friend_id&&!r.offerer_ended||r.receiving_friend_id===s?.friend_id&&!r.receiver_ended}const u=n?t.filter(r=>!m(r)):t.filter(m),[c,l]=_.useState(void 0),h=he();if(!s)return null;const j=(r,p)=>{const f=pe(r);return{card_id:r,internal_id:f,amount_owned:(o.get(f)?.amount_owned??0)+p}},b=async r=>{if(r.offer_card_id!==r.receiver_card_id)if(r.offering_friend_id===s.friend_id){const p=[j(r.offer_card_id,-1),j(r.receiver_card_id,1)];i.mutate({updates:p}),d({title:a("collectionUpdated"),variant:"default"})}else if(r.receiving_friend_id===s.friend_id){const p=[j(r.offer_card_id,1),j(r.receiver_card_id,-1)];i.mutate({updates:p}),d({title:a("collectionUpdated"),variant:"default"})}else console.log(r,"can't match friend id")},y=r=>{const p=async v=>{h.mutate({id:r.id,trade:{status:v}}),l(r.id),M(`Updated trade: ${v}`)},f=async()=>{const v=r.offering_friend_id===s.friend_id?{offerer_ended:!0}:r.receiving_friend_id===s.friend_id?{receiver_ended:!0}:null;if(v===null){console.log(r," doesn't match your friend_id");return}h.mutate({id:r.id,trade:v}),l(void 0),M("Updated trade: ended")},T=r.offering_friend_id===s.friend_id&&r.offerer_ended||r.receiving_friend_id===s.friend_id&&r.receiver_ended;switch(r.status){case"offered":return e.jsxs(e.Fragment,{children:[r.receiving_friend_id===s.friend_id&&e.jsx(g,{type:"button",onClick:async()=>p("accepted"),children:a("actionAccept")}),e.jsx(g,{type:"button",onClick:async()=>p("declined"),children:r.receiving_friend_id===s.friend_id?a("actionDecline"):a("actionCancel")})]});case"accepted":return e.jsxs(e.Fragment,{children:[e.jsx(g,{type:"button",onClick:async()=>p("finished"),children:a("actionComplete")}),e.jsx(g,{type:"button",onClick:async()=>p("declined"),children:a("actionCancel")})]});case"declined":return T?null:e.jsx(g,{type:"button",onClick:f,children:a("actionHide")});case"finished":return T?null:e.jsxs(e.Fragment,{children:[e.jsx(g,{type:"button",onClick:async()=>{await b(r),await f()},children:a("actionUpdate")}),e.jsx(g,{type:"button",onClick:f,children:a("actionHide")})]});default:return console.log(`Unknown trade status ${r.status}`),null}},x=u.find(r=>r.id===c);return u.length===0?null:e.jsxs("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-1 md:p-2",children:[e.jsxs("div",{className:"hidden md:flex pr-1",children:[e.jsx("h4",{className:"text-lg font-medium w-1/2 ml-8",children:a("youGive")}),e.jsx("h4",{className:"text-lg font-medium w-1/2 ml-8",children:a("youReceive")})]}),e.jsx("ul",{className:"flex flex-col gap-2 md:gap-0",children:u.toSorted((r,p)=>r.created_at>p.created_at?-1:1).map(r=>e.jsx(We,{row:r,selectedTradeId:c,setSelectedTradeId:l},r.id))}),x&&e.jsx("div",{className:"flex gap-4 text-center items-center mt-2",children:y(x)})]})}function Ye({friendId:t}){const{t:n}=N(["trade-matches","common"]),{data:a,isLoading:d}=Q(),{data:s,isLoading:o}=q(t),[i,m]=_.useState(!1);if(d||o)return null;if(!a)return e.jsx("p",{className:"text-xl text-center py-8",children:n("common:error")});const u=a.filter(c=>c.offering_friend_id===t||c.receiving_friend_id===t);return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1 mx-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-md",children:n("tradingWith")}),e.jsxs("span",{className:"text-md font-bold",children:[" ",s?.username||"unknown"," "]}),s&&e.jsx(X,{friendId:s.friend_id,showFriendId:!1,className:"ml-1"})]}),e.jsxs("span",{className:"flex gap-4",children:[e.jsxs("label",{htmlFor:`history-${t}`,className:"my-auto flex items-center",children:[n("viewHistory"),e.jsx(ee,{id:`history-${t}`,className:"ml-2 my-auto",checked:i,onCheckedChange:m})]}),e.jsx(O,{to:`/trade/${t}`,children:e.jsxs(g,{variant:"outline",className:"my-auto",children:[n("openTradeWith"),e.jsx(z,{})]})})]})]}),s!==null&&e.jsx(Ge,{trades:u,viewHistory:i})]})}function Ze(){const{t}=N(["trade-matches","common"]),{data:n,isLoading:a}=S(),{data:d,isLoading:s}=Q();if(a||s)return e.jsx("div",{className:"mx-auto mt-12 animate-spin rounded-full size-12 border-4 border-white border-t-transparent"});if(!d||!n)return e.jsx("p",{className:"text-xl text-center py-8",children:t("common:error")});if(d.length===0)return e.jsx("p",{children:t("noTradeOffers")});const o=Je(d,n.friend_id),i=Object.fromEntries(Object.entries(o).map(([c,l])=>[c,+(qe(l,n.friend_id).length===0)])),m=Object.fromEntries(Object.entries(o).map(([c,l])=>[c,Math.max(...l.map(h=>new Date(h.updated_at).getTime()))])),u=Object.keys(o).toSorted((c,l)=>i[c]!==i[l]?i[c]-i[l]:m[l]-m[c]);return e.jsx("div",{className:"flex flex-col items-center mx-auto gap-6 sm:px-4 mb-12 w-full",children:u.map(c=>e.jsx(Ye,{friendId:c},c))})}function qe(t,n){return t.filter(a=>a.offering_friend_id===n?!a.offerer_ended:!a.receiver_ended)}function Je(t,n){return Object.groupBy(t,a=>a.offering_friend_id===n?a.receiving_friend_id:a.receiving_friend_id===n?a.offering_friend_id:(console.log("Fetched row does not match user friend_id",a),"undefined"))}function Qe(){const{t}=N("trade-matches"),{data:n}=S(),a=ge(),d=U({is_active_trading:be(),trade_rarity_settings:je(U({rarity:_e(Ne),to_collect:K().min(0).max(100),to_keep:K().min(0).max(100)}))}),s=Fe({resolver:Ie(d),values:{is_active_trading:n?.is_active_trading||!1,trade_rarity_settings:n?.trade_rarity_settings||[]}}),o=async i=>{a.mutate({username:n?.username,is_active_trading:i.is_active_trading,trade_rarity_settings:i.trade_rarity_settings},{onSuccess:()=>D({title:t("accountSaved"),variant:"default"}),onError:m=>{console.error("error saving account",m),D({title:t("errorSavingAccount"),variant:"destructive"})}})};return!n||!n.username?e.jsx(Pe,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:t("noAccount")}):e.jsxs("div",{children:[e.jsx(Ae,{...s,children:e.jsxs("form",{onSubmit:s.handleSubmit(o),className:"rounded-md border-1 border-neutral-700 space-y-2 p-4 mx-auto max-w-xl",children:[e.jsx("h2",{className:"text-xl text-center mb-6",children:t("settingsTitle")}),e.jsx(F,{control:s.control,name:"is_active_trading",render:({field:i})=>e.jsx(I,{className:"flex flex-col items-start",children:e.jsx(A,{children:e.jsxs(Me,{className:"flex",children:[t("isActiveTrading"),e.jsx(ee,{className:"ml-2",checked:i.value,onCheckedChange:i.onChange})]})})})}),e.jsxs("div",{className:"grid grid-cols-3 gap-y-2 gap-x-8 w-fit mt-6",children:[e.jsx("span",{children:t("rarity")}),e.jsxs("span",{className:"flex items-center",children:[t("toCollect"),e.jsx(E,{id:"to-collect"}),e.jsx(V,{className:"size-4 ml-1","data-tooltip-id":"to-collect","data-tooltip-content":t("toCollectTooltip")})]}),e.jsxs("span",{className:"flex items-center",children:[t("toKeep"),e.jsx(E,{id:"to-collect"}),e.jsx(V,{className:"size-4 ml-1","data-tooltip-id":"to-collect","data-tooltip-content":t("toKeepTooltip")})]}),s.watch("trade_rarity_settings").map((i,m)=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1",children:i.rarity},`label-${i.rarity}`),e.jsx(F,{control:s.control,name:`trade_rarity_settings.${m}.to_collect`,render:({field:u})=>e.jsx(I,{className:"flex-1",children:e.jsx(A,{children:e.jsx(B,{className:"w-24",type:"number",...u})})})},`to-collect-${i.rarity}`),e.jsx(F,{control:s.control,name:`trade_rarity_settings.${m}.to_keep`,render:({field:u})=>e.jsx(I,{className:"flex-1",children:e.jsx(A,{children:e.jsx(B,{className:"w-24",type:"number",...u})})})},`to-keep-${i.rarity}`)]}))]}),e.jsxs(g,{type:"submit",className:"block ml-auto mt-4",disabled:a.isPending,children:[t("save"),a.isPending&&e.jsx("div",{className:"ml-2 inline-block animate-spin rounded-full size-4 border-2 border-black border-t-transparent"})]})]})}),e.jsx(Ee,{className:"mt-4 mx-auto w-fit"})]})}function mt(){const{t}=N("trade-matches"),n=ve(),a=ye(),d=n.pathname.split("/").pop()||"offers";return _.useEffect(()=>{n.pathname==="/trade"&&a("/trade/offers")},[n.pathname,a]),e.jsxs(ke,{className:"flex flex-col mx-auto max-w-[900px]",value:d,onValueChange:s=>a(`/trade/${s}`),children:[e.jsxs(Se,{className:"gap-4 mb-6 rounded-lg border-b-1 border-neutral-700 border-solid dark:bg-transparent pb-2",children:[e.jsx(w,{className:"text-md",value:"cards",children:t("tabCards")}),e.jsx(w,{className:"text-md",value:"offers",children:t("tabOffers")}),e.jsx(w,{className:"text-md",value:"matches",children:t("tabMatches")}),e.jsx(w,{className:"text-md",value:"settings",children:t("tabSettings")})]}),e.jsxs(Ce,{children:[e.jsx(C,{path:"/",element:e.jsx(Te,{to:"/trade/offers",replace:!0})}),e.jsx(C,{path:"cards",element:e.jsx("p",{children:t("movedToCollectionPage")})}),e.jsx(C,{path:"offers",element:e.jsx(Ze,{})}),e.jsx(C,{path:"matches",element:e.jsx(Ke,{})}),e.jsx(C,{path:"settings",element:e.jsx(Qe,{})}),e.jsx(C,{path:":friendId",element:e.jsx(Ve,{})})]})]})}export{mt as default};
