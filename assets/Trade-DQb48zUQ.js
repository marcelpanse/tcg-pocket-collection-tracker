import{_ as ne,Z as ie,u as C,j as e,r as o,U as E,C as B,l as de,v as Z,O as q,B as b,Q as W,V as oe,W as ce,N as G,X as H,z as le,Y as ue,J as me,K as fe}from"./index-xHJu4A7s.js";import{T as te,a as re,b as I,c as A,C as J}from"./tabs-BYZ5ImXG.js";import{N as Y,M as O,C as L}from"./NumberFilter-CyZLJtNe.js";import{R as xe}from"./useWindowDimensionsHook-TpvckNtz.js";import{C as pe}from"./CardDetail-Dhr_pZw-.js";import{A as K,a as P,b as z}from"./alert-CP5qKTe7.js";import{S as Q}from"./siren-AwiNIljz.js";import{u as _e,a as he,F as ge,b as R,c as V,d as D,e as U,S as ae,f as je,g as be}from"./switch-C0GnCXo7.js";import{i as M}from"./Card-BoujBV7y.js";import"./index-BFcs1jrP.js";function ee(t){return ne(ie,t)}function ve(){const{t}=C("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(K,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx(P,{children:t("noCardsNeeded.title")}),e.jsx(z,{children:t("noCardsNeeded.description")})]})})}function Ce(){const{t}=C("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(K,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx(P,{children:t("noTradeableCards.title")}),e.jsx(z,{children:t("noTradeableCards.description")})]})})}function Ne(){const{t}=C("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(K,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx(P,{children:t("notLoggedIn.title")}),e.jsx(z,{children:t("notLoggedIn.description")})]})})}function ye(){const{t}=C("pages/trade"),{user:f,account:s}=o.use(E),{ownedCards:a,selectedCardId:_,setSelectedCardId:m}=o.use(B),[x,c]=o.useState([]),[d,g]=o.useState(0),[l,p]=o.useState(2),[h,T]=o.useState("looking_for"),N=o.useMemo(()=>de.filter(i=>i.tradeable).map(i=>i.id),[]),y=i=>x.length===0?!0:i.rarity!==""&&x.includes(i.rarity),r=o.useMemo(()=>Z.filter(i=>a.findIndex(u=>u.card_id===i.card_id)===-1||a[a.findIndex(u=>u.card_id===i.card_id)].amount_owned<=d).filter(i=>q[i.rarity]!==null&&N.includes(i.expansion)),[a,d]),j=o.useMemo(()=>r.filter(y),[r,x]),v=o.useMemo(()=>{const i=a.filter(u=>u.amount_owned>=l);return Z.filter(u=>i.findIndex($=>$.card_id===u.card_id)>-1).map(u=>({...u,amount_owned:i.find($=>$.card_id===u.card_id)?.amount_owned})).filter(u=>q[u.rarity]!==null&&N.includes(u.expansion))},[a,l]),S=o.useMemo(()=>v.filter(y),[v,x]),k=()=>{let i="";s?.is_public&&(i+=`${t("publicTradePage")} https://tcgpocketcollectiontracker.com/#/collection/${s?.friend_id}/trade
`),s?.username&&(i+=`${t("friendID")} ${s.friend_id} (${s.username})

`),i+=`${t("lookingForCards")}
`;const u=j.sort((n,F)=>{const X=n.expansion.localeCompare(F.expansion);return X!==0?X:n.rarity.localeCompare(F.rarity)});for(let n=0;n<u.length;n++)(n>0?u[n-1].expansion:"")!==u[n].expansion&&(i+=`
${u[n].set_details}:
`),i+=`${u[n].rarity} ${u[n].card_id} - ${u[n].name}
`;const $=j.map(n=>n.rarity);i+=`

${t("forTradeCards")}
`;const w=S.filter(n=>$.includes(n.rarity)).sort((n,F)=>n.rarity.localeCompare(F.rarity));for(let n=0;n<w.length;n++)(n>0?w[n-1].expansion:"")!==w[n].expansion&&(i+=`
${w[n].set_details}:
`),i+=`${w[n].rarity} ${w[n].card_id} - ${w[n].name}
`;return i},se=async()=>{const i=k();W({title:t("copiedInClipboard"),variant:"default",duration:3e3}),await navigator.clipboard.writeText(i)};return f?e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsxs(te,{defaultValue:h,onValueChange:T,children:[e.jsxs("div",{className:"mx-auto max-w-[900px] flex flex-row flex-wrap align-center gap-x-4 gap-y-2",children:[e.jsxs(re,{className:"flex-grow m-auto flex-wrap h-auto border-1 border-neutral-700 rounded-md",children:[e.jsx(I,{value:"looking_for",children:t("lookingFor")}),e.jsx(I,{value:"for_trade",children:t("forTrade")})]}),e.jsx(xe,{rarityFilter:x,setRarityFilter:c}),e.jsxs("div",{className:"sm:mt-1 flex flex-row flex-wrap align-center gap-x-4 gap-y-1",children:[h==="looking_for"&&e.jsx(Y,{numberFilter:d,setNumberFilter:g,options:[0,1,2,3,4,5],labelKey:"maxNum"}),h==="for_trade"&&e.jsx(Y,{numberFilter:l,setNumberFilter:p,options:[2,3,4,5],labelKey:"minNum"}),e.jsx(b,{variant:"outline",onClick:se,children:"Copy to clipboard"})]})]}),e.jsxs("div",{className:"mx-auto max-w-[900px] mt-6",children:[e.jsx(A,{value:"looking_for",children:r&&r.length>0?e.jsx(J,{cards:j,extraOffset:105}):e.jsx(ve,{})}),e.jsx(A,{value:"for_trade",children:v&&v.length>0?e.jsx(J,{cards:S,extraOffset:105}):e.jsx(Ce,{})})]})]}),_&&e.jsx(pe,{cardId:_,onClose:()=>m("")})]}):e.jsx(Ne,{})}function we(){const{t}=C("trade-matches"),{user:f,account:s,setAccount:a}=o.useContext(E),_=oe({is_active_trading:ce(),min_number_of_cards_to_keep:ee().min(1).max(10),max_number_of_cards_wanted:ee().min(1).max(10)}),m=_e({resolver:he(_),values:{is_active_trading:s?.is_active_trading||!1,min_number_of_cards_to_keep:s?.min_number_of_cards_to_keep||1,max_number_of_cards_wanted:s?.max_number_of_cards_wanted||1}}),x=async c=>{try{const d=await H.from("accounts").upsert({email:f?.user.email,username:s?.username,is_active_trading:c.is_active_trading,min_number_of_cards_to_keep:c.min_number_of_cards_to_keep,max_number_of_cards_wanted:c.max_number_of_cards_wanted}).select().single();if(!d.data)throw console.error("Could not save account",s),new Error("Could not save account");a(d.data),W({title:t("accountSaved"),variant:"default"})}catch(d){console.error("error saving account",d),W({title:t("errorSavingAccount"),variant:"destructive"})}};return e.jsxs("div",{children:[e.jsx(ge,{...m,children:e.jsxs("form",{onSubmit:m.handleSubmit(x),className:"border-1 border-neutral-700 space-y-2 p-4 mx-auto",children:[e.jsx(R,{control:m.control,name:"is_active_trading",render:({field:c})=>e.jsx(V,{className:"flex flex-col items-start",children:e.jsx(D,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(U,{className:"flex sm:w-72",children:t("isActiveTrading")}),e.jsx("div",{className:"grow-1",children:e.jsx(ae,{checked:c.value,onCheckedChange:c.onChange})}),e.jsx(je,{className:"grow",children:c.value?"active":"disabled"}),e.jsx(O,{id:"activeInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(L,{className:"h-4 w-4","data-tooltip-id":"activeInput","data-tooltip-content":t("activeTradingInputTooltip")})]})})})}),e.jsx(R,{control:m.control,name:"min_number_of_cards_to_keep",render:({field:c})=>e.jsx(V,{className:"flex flex-col items-start",children:e.jsx(D,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(U,{className:"flex sm:w-72",children:t("minNumberOfCardsToKeep")}),e.jsx("div",{className:"grow-1",children:e.jsx(G,{className:"w-24",type:"number",...c})}),e.jsx(O,{id:"minInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(L,{className:"h-4 w-4","data-tooltip-id":"minInput","data-tooltip-content":t("minInputTooltip")})]})})})}),e.jsx(R,{control:m.control,name:"max_number_of_cards_wanted",render:({field:c})=>e.jsx(V,{className:"flex flex-col items-start",children:e.jsx(D,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(U,{className:"flex sm:w-72",children:t("maxNumberOfCardsWanted")}),e.jsx("div",{className:"grow-1",children:e.jsx(G,{className:"w-24",type:"number",...c})}),e.jsx(O,{id:"maxInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(L,{className:"h-4 w-4","data-tooltip-id":"maxInput","data-tooltip-content":t("maxInputTooltip")})]})})})}),e.jsx("div",{className:"w-full flex justify-end mt-8",children:e.jsx(b,{type:"submit",children:t("save")})})]})}),e.jsx(be,{className:"mt-4"})]})}const Te=({row:t,selectedTradeId:f,setSelectedTradeId:s})=>{const{account:a}=o.useContext(E),{ownedCards:_}=o.useContext(B);if(!a)return null;const m=t.offering_friend_id===a.friend_id?t.offer_card_id:t.receiver_card_id,x=t.offering_friend_id===a.friend_id?t.receiver_card_id:t.offer_card_id;function c(l){const p=le(l);return p?e.jsxs("span",{className:"flex rounded px-1 w-1/2 bg-zinc-800",children:[e.jsxs("span",{className:"min-w-10",children:[p.rarity," "]}),e.jsxs("span",{className:"min-w-14 me-4",children:[p.card_id," "]}),e.jsx("span",{children:p.name}),e.jsxs("span",{className:"text-neutral-400 ml-auto",children:["×",_.find(h=>h.card_id===p.card_id)?.amount_owned||0]})]}):e.jsx("span",{className:"w-1/2 text-center",children:"?"})}function d(l){f===l.id?s(void 0):s(l.id)}const g=l=>{const p={offered:{icon:l.offering_friend_id===a.friend_id?"→":"←",color:"bg-amber-600"},accepted:{icon:"↔",color:"bg-lime-600"},declined:{icon:"X",color:"bg-stone-600"},finished:{icon:"✓",color:"bg-indigo-600"}};return e.jsxs(e.Fragment,{children:[e.jsx(O,{id:`tooltip-${l.id}`}),e.jsx("span",{className:`rounded-full text-center w-9 ${p[l.status].color}`,"data-tooltip-id":`tooltip-${l.id}`,"data-tooltip-content":l.status,children:p[l.status].icon})]})};return e.jsxs("li",{className:`flex cursor-pointer justify-between rounded gap-4 p-1 my-1 ${f===t.id&&"bg-green-900"} hover:bg-neutral-500`,onClick:()=>d(t),children:[g(t),c(m),c(x)]})};function ke({trades:t,update:f,viewHistory:s}){const{t:a}=C("trade-matches"),{toast:_}=ue();function m(r){return r.offering_friend_id===d?.friend_id&&!r.offerer_ended||r.receiving_friend_id===d?.friend_id&&!r.receiver_ended}const{ownedCards:x,setOwnedCards:c}=o.useContext(B),{account:d,user:g}=o.useContext(E),l=s?t.filter(r=>!m(r)):t.filter(m),[p,h]=o.useState(void 0);if(!d||!g)return null;const T=async r=>{r.offering_friend_id===d.friend_id?(await M([r.offer_card_id],-1,x,c,g),await M([r.receiver_card_id],1,x,c,g),_({title:a("collectionUpdated"),variant:"default"})):r.receiving_friend_id===d.friend_id?(await M([r.offer_card_id],1,x,c,g),await M([r.receiver_card_id],-1,x,c,g),_({title:a("collectionUpdated"),variant:"default"})):console.log(r,"can't match friend id")},N=r=>{const j=async k=>{await f(r.id,{status:k}),h(r.id)},v=async()=>{const k=r.offering_friend_id===d.friend_id?{offerer_ended:!0}:r.receiving_friend_id===d.friend_id?{receiver_ended:!0}:null;if(k===null){console.log(r," doesn't match your friend_id");return}await f(r.id,k),h(void 0)},S=r.offering_friend_id===d.friend_id&&r.offerer_ended||r.receiving_friend_id===d.friend_id&&r.receiver_ended;switch(r.status){case"offered":return e.jsxs(e.Fragment,{children:[r.receiving_friend_id===d.friend_id&&e.jsx(b,{type:"button",onClick:async()=>j("accepted"),children:a("actionAccept")}),e.jsx(b,{type:"button",onClick:async()=>j("declined"),children:r.receiving_friend_id===d.friend_id?a("actionDecline"):a("actionCancel")})]});case"accepted":return e.jsxs(e.Fragment,{children:[e.jsx(b,{type:"button",onClick:async()=>j("finished"),children:a("actionComplete")}),e.jsx(b,{type:"button",onClick:async()=>j("declined"),children:a("actionCancel")})]});case"declined":return S?null:e.jsx(b,{type:"button",onClick:v,children:a("actionHide")});case"finished":return S?null:e.jsxs(e.Fragment,{children:[e.jsx(b,{type:"button",onClick:async()=>{await T(r),await v()},children:a("actionUpdate")}),e.jsx(b,{type:"button",onClick:v,children:a("actionHide")})]});default:return console.log(`Unknown trade status ${r.status}`),null}},y=l.find(r=>r.id===p);return l.length===0?e.jsx("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2 text-center",children:a("noActiveTrades")}):e.jsxs("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2",children:[e.jsxs("div",{className:"flex gap-4 px-1",children:[e.jsx("div",{className:"w-9"}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:a("youGive")}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:a("youReceive")})]}),e.jsx("ul",{children:l.toSorted((r,j)=>r.created_at>j.created_at?-1:1).map(r=>e.jsx(Te,{row:r,selectedTradeId:p,setSelectedTradeId:h},r.id))}),y&&e.jsx("div",{className:"flex gap-4 text-center items-center mt-2",children:N(y)})]})}function Fe(t,f){return Object.groupBy(t,s=>s.offering_friend_id===f?s.receiving_friend_id:s.receiving_friend_id===f?s.offering_friend_id:"undefined")}function Se({friendId:t,initialTrades:f}){const{t:s}=C("trade-matches"),[a,_]=o.useState(null),m=me(),[x,c]=o.useState(f),[d,g]=o.useState(!1);async function l(p,h){const T=new Date,{error:N}=await H.from("trades").update({updated_at:T,...h}).eq("id",p);if(N){console.log("Error updating trades: ",N);return}console.log("successfully updated trade"),c(y=>y.map(r=>r.id===p?{...r,updated_at:T,...h}:r))}return o.useEffect(()=>{a||fe(t).then(_)}),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 mx-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-sm",children:s("tradingWith")}),e.jsxs("span",{className:"text-xl font-medium",children:[" ",a?.username||"loading"," "]}),e.jsxs("span",{className:"text-xs",children:["(",t,")"]})]}),e.jsxs("span",{className:"flex gap-4",children:[e.jsxs("label",{htmlFor:`history-${t}`,className:"my-auto flex items-center",children:["View history",e.jsx(ae,{id:`history-${t}`,className:"ml-2 my-auto",checked:d,onCheckedChange:g})]}),e.jsx(b,{className:"my-auto",onClick:()=>m(`/trade/${t}`),children:s("openTradeWith")})]})]}),a!==null&&e.jsx(ke,{trades:x,update:l,viewHistory:d})]})}function $e(){const{t}=C("trade-matches"),{account:f}=o.useContext(E),[s,a]=o.useState(null);if(o.useEffect(()=>{f&&s===null&&(console.log("Refrehing trades"),H.from("trades").select().then(({data:m,error:x})=>{x?console.log("Error fetching trades: ",x):a(m)}))}),s===null||!f)return null;if(s.length===0)return e.jsx("p",{children:t("noTradeOffers")});const _=Fe(s,f.friend_id);return e.jsx("div",{className:"flex flex-col items-center mx-auto gap-12",children:Object.keys(_).map(m=>e.jsx(Se,{friendId:m,initialTrades:_[m],account:f},m))})}function We(){return e.jsxs(te,{className:"flex flex-col mx-auto max-w-[900px]",defaultValue:"offers",children:[e.jsxs(re,{className:"gap-4 mb-6 rounded-lg border-b-1 border-neutral-700 border-solid dark:bg-transparent pb-2",children:[e.jsx(I,{className:"text-md",value:"cards",children:"Cards"}),e.jsx(I,{className:"text-md",value:"offers",children:"Offers"}),e.jsx(I,{className:"text-md",value:"settings",children:"Settings"})]}),e.jsx(A,{value:"cards",children:e.jsx(ye,{})}),e.jsx(A,{value:"offers",children:e.jsx($e,{})}),e.jsx(A,{value:"settings",children:e.jsx(we,{})})]})}export{We as default};
