import{$ as te,a0 as re,u as g,j as e,a1 as se,a2 as S,n as z,r as _,a3 as ne,a4 as ie,B as h,S as de,a5 as W,a6 as ce,x as oe,F as le,a7 as J,N as me,a8 as ue,a9 as fe,aa as xe,ab as pe,_ as P}from"./index-BmRDUnTb.js";import{T as Y,a as ee,b as w,c as F}from"./tabs-V_jT51Fp.js";import{C as G}from"./CardsTable-toqc8UqI.js";import{t as Q,N as X}from"./index-DluBVc28.js";import{R as _e}from"./RarityFilter-DMWEr_9v.js";import{A as M,a as B,b as D}from"./alert-CvaouFP3.js";import{S as H}from"./siren-B2fWrO5b.js";import{S as ae,u as he,a as ge,F as je,b as O,c as U,d as E,e as R,f as be,g as ve}from"./form-CGi7JL4g.js";import{M as I,C as V}from"./react-tooltip.min-CX2nrY_M.js";import{C as Z}from"./CardLine-BDfstSEQ.js";import"./useWindowDimensionsHook-ADAUYiOq.js";import"./Card-B3ZA3WMa.js";import"./FancyCard-C-NuhvPw.js";import"./index-yhR7PGmH.js";function q(a){return te(re,a)}function Ne(){const{t:a}=g("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(M,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsx(B,{children:a("noCardsNeeded.title")}),e.jsx(D,{children:a("noCardsNeeded.description")})]})})}function Ce(){const{t:a}=g("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(M,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsx(B,{children:a("noTradeableCards.title")}),e.jsx(D,{children:a("noTradeableCards.description")})]})})}function ye(){const{t:a}=g("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(M,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsx(B,{children:a("notLoggedIn.title")}),e.jsx(D,{children:a("notLoggedIn.description")})]})})}function Te(){const{t:a}=g("pages/trade"),{data:c}=se(),{data:n}=S(),{data:r=[]}=z(),[d,o]=_.useState([]),[s,f]=_.useState((n?.max_number_of_cards_wanted??1)-1),[x,m]=_.useState((n?.min_number_of_cards_to_keep??1)+1),[p,T]=_.useState("looking_for"),v=l=>(d.length===0?Q:d).includes(l.rarity),$=l=>{const j=de(l),L=r.find(b=>b.card_id===l)?.amount_owned??0;return{...j,amount_owned:L}},k=_.useMemo(()=>ne(r,s+1).map($),[r,s]),C=_.useMemo(()=>k.filter(v),[k,d]),t=_.useMemo(()=>ie(r,x-1).map($),[r,x]),u=_.useMemo(()=>t.filter(v),[t,d]),N=()=>{let l="";n?.is_public&&(l+=`${a("publicTradePage")} https://tcgpocketcollectiontracker.com/#/trade/${n?.friend_id}
`),n?.username&&(l+=`${a("friendID")} ${n.friend_id} (${n.username})

`),l+=`${a("lookingForCards")}
`;const j=C.sort((i,y)=>{const K=i.expansion.localeCompare(y.expansion);return K!==0?K:i.rarity.localeCompare(y.rarity)});for(let i=0;i<j.length;i++)(i>0?j[i-1].expansion:"")!==j[i].expansion&&(l+=`
${j[i].set_details}:
`),l+=`${j[i].rarity} ${j[i].card_id} - ${j[i].name}
`;const L=C.map(i=>i.rarity);l+=`

${a("forTradeCards")}
`;const b=u.filter(i=>L.includes(i.rarity)).sort((i,y)=>i.rarity.localeCompare(y.rarity));for(let i=0;i<b.length;i++)(i>0?b[i-1].expansion:"")!==b[i].expansion&&(l+=`
${b[i].set_details}:
`),l+=`${b[i].rarity} ${b[i].card_id} - ${b[i].name}
`;return l},A=async()=>{const l=N();W({title:a("copiedInClipboard"),variant:"default",duration:3e3}),await navigator.clipboard.writeText(l)};return c?e.jsx("div",{className:"flex flex-col gap-y-4",children:e.jsxs(Y,{defaultValue:p,onValueChange:T,children:[e.jsxs("div",{className:"mx-auto max-w-[900px] flex flex-row flex-wrap align-center gap-x-4 gap-y-2",children:[e.jsxs(ee,{className:"flex-grow m-auto flex-wrap h-auto border-1 border-neutral-700 rounded-md",children:[e.jsx(w,{value:"looking_for",children:a("lookingFor")}),e.jsx(w,{value:"for_trade",children:a("forTrade")})]}),e.jsx(_e,{rarityFilter:d,setRarityFilter:o,rarities:Q}),e.jsxs("div",{className:"sm:mt-1 flex flex-row flex-wrap align-center gap-x-4 gap-y-1",children:[p==="looking_for"&&e.jsx(X,{numberFilter:s,setNumberFilter:f,options:[0,1,2,3,4,5],labelKey:"maxNum"}),p==="for_trade"&&e.jsx(X,{numberFilter:x,setNumberFilter:m,options:[2,3,4,5],labelKey:"minNum"}),e.jsx(h,{variant:"outline",onClick:A,children:"Copy to clipboard"})]})]}),e.jsxs("div",{className:"mx-auto max-w-[900px] mt-6",children:[e.jsx(F,{value:"looking_for",children:k?e.jsx(G,{cards:C,extraOffset:105,editable:!1}):e.jsx(Ne,{})}),e.jsx(F,{value:"for_trade",children:t?e.jsx(G,{cards:u,extraOffset:105,editable:!1}):e.jsx(Ce,{})})]})]})}):e.jsx(ye,{})}const ke=({row:a,selectedTradeId:c,setSelectedTradeId:n})=>{const{t:r}=g("trade-matches"),{data:d}=S();if(!d)return null;const o=a.offering_friend_id===d.friend_id?a.offer_card_id:a.receiver_card_id,s=a.offering_friend_id===d.friend_id?a.receiver_card_id:a.offer_card_id;function f(m){c===m.id?n(void 0):n(m.id)}const x=m=>{const p={offered:{icon:m.offering_friend_id===d.friend_id?"→":"←",color:"bg-amber-600"},accepted:{icon:"↔",color:"bg-lime-600"},declined:{icon:"X",color:"bg-stone-600"},finished:{icon:"✓",color:"bg-indigo-600"}};return e.jsxs("div",{className:"flex items-center",children:[e.jsx(I,{id:`tooltip-${m.id}`}),e.jsx("span",{className:`rounded-full text-center w-7 md:w-9 ${p[m.status].color}`,"data-tooltip-id":`tooltip-${m.id}`,"data-tooltip-content":r(`status.${m.status}`),children:p[m.status].icon})]})};return e.jsxs("li",{className:`flex cursor-pointer rounded gap-1 md:gap-4 p-1 ${c===a.id&&"bg-green-900"} hover:bg-neutral-500`,onClick:()=>f(a),children:[x(a),e.jsxs("div",{className:"flex flex-col sm:flex-row w-full justify-between gap-1 md:gap-4",children:[e.jsx(Z,{className:"sm:w-1/2",card_id:o,increment:-1}),e.jsx(Z,{className:"sm:w-1/2",card_id:s,increment:1})]})]})};function we({trades:a,update:c,viewHistory:n}){const{t:r}=g("trade-matches"),{toast:d}=ce(),{data:o}=S(),{data:s=[]}=z(),f=oe();function x(t){return t.offering_friend_id===o?.friend_id&&!t.offerer_ended||t.receiving_friend_id===o?.friend_id&&!t.receiver_ended}const m=n?a.filter(t=>!x(t)):a.filter(x),[p,T]=_.useState(void 0);if(!o)return null;const v=(t,u)=>({card_id:t,amount_owned:(s.find(N=>N.card_id===t)?.amount_owned??0)+u}),$=async t=>{if(t.offer_card_id!==t.receiver_card_id)if(t.offering_friend_id===o.friend_id){const u=[v(t.offer_card_id,-1),v(t.receiver_card_id,1)];f.mutate({updates:u}),d({title:r("collectionUpdated"),variant:"default"})}else if(t.receiving_friend_id===o.friend_id){const u=[v(t.offer_card_id,1),v(t.receiver_card_id,-1)];f.mutate({updates:u}),d({title:r("collectionUpdated"),variant:"default"})}else console.log(t,"can't match friend id")},k=t=>{const u=async l=>{await c(t.id,{status:l}),T(t.id)},N=async()=>{const l=t.offering_friend_id===o.friend_id?{offerer_ended:!0}:t.receiving_friend_id===o.friend_id?{receiver_ended:!0}:null;if(l===null){console.log(t," doesn't match your friend_id");return}await c(t.id,l),T(void 0)},A=t.offering_friend_id===o.friend_id&&t.offerer_ended||t.receiving_friend_id===o.friend_id&&t.receiver_ended;switch(t.status){case"offered":return e.jsxs(e.Fragment,{children:[t.receiving_friend_id===o.friend_id&&e.jsx(h,{type:"button",onClick:async()=>u("accepted"),children:r("actionAccept")}),e.jsx(h,{type:"button",onClick:async()=>u("declined"),children:t.receiving_friend_id===o.friend_id?r("actionDecline"):r("actionCancel")})]});case"accepted":return e.jsxs(e.Fragment,{children:[e.jsx(h,{type:"button",onClick:async()=>u("finished"),children:r("actionComplete")}),e.jsx(h,{type:"button",onClick:async()=>u("declined"),children:r("actionCancel")})]});case"declined":return A?null:e.jsx(h,{type:"button",onClick:N,children:r("actionHide")});case"finished":return A?null:e.jsxs(e.Fragment,{children:[e.jsx(h,{type:"button",onClick:async()=>{await $(t),await N()},children:r("actionUpdate")}),e.jsx(h,{type:"button",onClick:N,children:r("actionHide")})]});default:return console.log(`Unknown trade status ${t.status}`),null}},C=m.find(t=>t.id===p);return m.length===0?e.jsx("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2 text-center",children:r("noActiveTrades")}):e.jsxs("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-1 sm:p-2",children:[e.jsxs("div",{className:"hidden sm:flex px-1",children:[e.jsx("div",{className:"w-9"}),e.jsx("h4",{className:"text-lg font-medium w-1/2 ml-8",children:r("youGive")}),e.jsx("h4",{className:"text-lg font-medium w-1/2 ml-8",children:r("youReceive")})]}),e.jsx("ul",{className:"flex flex-col gap-2 sm:gap-0",children:m.toSorted((t,u)=>t.created_at>u.created_at?-1:1).map(t=>e.jsx(ke,{row:t,selectedTradeId:p,setSelectedTradeId:T},t.id))}),C&&e.jsx("div",{className:"flex gap-4 text-center items-center mt-2",children:k(C)})]})}function Fe({friendId:a}){const c=le(),{t:n}=g("trade-matches"),{data:r}=J(),{data:d}=me(a),o=ue(),[s,f]=_.useState(!1);async function x(m,p){o.mutate({id:m,trade:p})}return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 mx-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-md",children:n("tradingWith")}),e.jsxs("span",{className:"text-md font-bold",children:[" ",d?.username||"loading"," "]})]}),e.jsxs("span",{className:"flex gap-4",children:[e.jsxs("label",{htmlFor:`history-${a}`,className:"my-auto flex items-center",children:[n("viewHistory"),e.jsx(ae,{id:`history-${a}`,className:"ml-2 my-auto",checked:s,onCheckedChange:f})]}),e.jsx(h,{className:"my-auto",onClick:()=>c(`/trade/${a}`),children:n("openTradeWith")})]})]}),d!==null&&r&&e.jsx(we,{trades:r.filter(m=>m.offering_friend_id===a||m.receiving_friend_id===a),update:x,viewHistory:s})]})}function Se(){const{t:a}=g("trade-matches"),{data:c}=S(),{data:n}=J();if(!n||!c)return null;if(n.length===0)return e.jsx("p",{children:a("noTradeOffers")});const r=$e(n,c.friend_id),d=Object.fromEntries(Object.entries(r).map(([s,f])=>[s,Math.max(...f.map(x=>new Date(x.updated_at).getTime()))])),o=Object.keys(r).toSorted((s,f)=>d[f]-d[s]);return e.jsx("div",{className:"flex flex-col items-center mx-auto gap-12 sm:px-4 mb-12",children:o.map(s=>e.jsx(Fe,{friendId:s},s))})}function $e(a,c){return Object.groupBy(a,n=>n.offering_friend_id===c?n.receiving_friend_id:n.receiving_friend_id===c?n.offering_friend_id:(console.log("Fetched row does not match user friend_id",n),"undefined"))}function Ae(){const{t:a}=g("trade-matches"),{data:c}=S(),n=fe(),r=xe({is_active_trading:pe(),min_number_of_cards_to_keep:q().min(1).max(10),max_number_of_cards_wanted:q().min(1).max(10)}),d=he({resolver:ge(r),values:{is_active_trading:c?.is_active_trading||!1,min_number_of_cards_to_keep:c?.min_number_of_cards_to_keep||1,max_number_of_cards_wanted:c?.max_number_of_cards_wanted||1}}),o=async s=>{try{n.mutate({username:c?.username,is_active_trading:s.is_active_trading,min_number_of_cards_to_keep:s.min_number_of_cards_to_keep,max_number_of_cards_wanted:s.max_number_of_cards_wanted}),W({title:a("accountSaved"),variant:"default"})}catch(f){console.error("error saving account",f),W({title:a("errorSavingAccount"),variant:"destructive"})}};return!c||!c.username?e.jsx(M,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:a("noAccount")}):e.jsxs("div",{children:[e.jsx(je,{...d,children:e.jsxs("form",{onSubmit:d.handleSubmit(o),className:"border-1 border-neutral-700 space-y-2 p-4 mx-auto",children:[e.jsx(O,{control:d.control,name:"is_active_trading",render:({field:s})=>e.jsx(U,{className:"flex flex-col items-start",children:e.jsx(E,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(R,{className:"flex sm:w-72",children:a("isActiveTrading")}),e.jsx("div",{className:"grow-1",children:e.jsx(ae,{checked:s.value,onCheckedChange:s.onChange})}),e.jsx(be,{className:"grow",children:s.value?"active":"disabled"}),e.jsx(I,{id:"activeInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(V,{className:"h-4 w-4","data-tooltip-id":"activeInput","data-tooltip-content":a("activeTradingInputTooltip")})]})})})}),e.jsx(O,{control:d.control,name:"min_number_of_cards_to_keep",render:({field:s})=>e.jsx(U,{className:"flex flex-col items-start",children:e.jsx(E,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(R,{className:"flex sm:w-72",children:a("minNumberOfCardsToKeep")}),e.jsx("div",{className:"grow-1",children:e.jsx(P,{className:"w-24",type:"number",...s})}),e.jsx(I,{id:"minInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(V,{className:"h-4 w-4","data-tooltip-id":"minInput","data-tooltip-content":a("minInputTooltip")})]})})})}),e.jsx(O,{control:d.control,name:"max_number_of_cards_wanted",render:({field:s})=>e.jsx(U,{className:"flex flex-col items-start",children:e.jsx(E,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(R,{className:"flex sm:w-72",children:a("maxNumberOfCardsWanted")}),e.jsx("div",{className:"grow-1",children:e.jsx(P,{className:"w-24",type:"number",...s})}),e.jsx(I,{id:"maxInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(V,{className:"h-4 w-4","data-tooltip-id":"maxInput","data-tooltip-content":a("maxInputTooltip")})]})})})}),e.jsx("div",{className:"w-full flex justify-end mt-8",children:e.jsx(h,{type:"submit",children:a("save")})})]})}),e.jsx(ve,{className:"mt-4"})]})}function Ge(){const{t:a}=g("trade-matches");return e.jsxs(Y,{className:"flex flex-col mx-auto max-w-[900px]",defaultValue:"offers",children:[e.jsxs(ee,{className:"gap-4 mb-6 rounded-lg border-b-1 border-neutral-700 border-solid dark:bg-transparent pb-2",children:[e.jsx(w,{className:"text-md",value:"cards",children:a("tabCards")}),e.jsx(w,{className:"text-md",value:"offers",children:a("tabOffers")}),e.jsx(w,{className:"text-md",value:"settings",children:a("tabSettings")})]}),e.jsx(F,{value:"cards",children:e.jsx(Te,{})}),e.jsx(F,{value:"offers",children:e.jsx(Se,{})}),e.jsx(F,{value:"settings",children:e.jsx(Ae,{})})]})}export{Ge as default};
