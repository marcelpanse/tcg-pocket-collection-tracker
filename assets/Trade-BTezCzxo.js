import{_ as ae,Z as re,u as C,j as e,r as l,U as I,C as W,E as Z,s as ne,B as N,X as U,Y as se,$ as ie,W as q,a0 as B,J as de,t as oe,a1 as ce,V as le,a2 as ue}from"./index-xn5AZfTo.js";import{T as Y,a as ee,b as S,c as $,C as z}from"./tabs-DQLf4sCg.js";import{N as G,M as E,C as A}from"./NumberFilter-Bm9CBlc-.js";import{t as O,R as me}from"./useWindowDimensionsHook-BBfa867e.js";import{A as D,a as H,b as K}from"./alert-Do1zeksk.js";import{S as P}from"./siren-m7oC74io.js";import{u as fe,a as xe,F as pe,b as L,c as M,d as R,e as V,S as te,f as _e,g as he}from"./switch-D7eeaM8q.js";import"./Card-HeGBVRce.js";import"./FancyCard-Dsg8fX9u.js";import"./index-mRRhoH5_.js";function J(t){return ae(re,t)}function ge(){const{t}=C("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(D,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(P,{className:"h-4 w-4"}),e.jsx(H,{children:t("noCardsNeeded.title")}),e.jsx(K,{children:t("noCardsNeeded.description")})]})})}function je(){const{t}=C("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(D,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(P,{className:"h-4 w-4"}),e.jsx(H,{children:t("noTradeableCards.title")}),e.jsx(K,{children:t("noTradeableCards.description")})]})})}function be(){const{t}=C("pages/trade");return e.jsx("article",{className:"mx-auto grid max-w-4xl gap-5",children:e.jsxs(D,{className:"mb-8 border-1 border-neutral-700 shadow-none",children:[e.jsx(P,{className:"h-4 w-4"}),e.jsx(H,{children:t("notLoggedIn.title")}),e.jsx(K,{children:t("notLoggedIn.description")})]})})}const Q=ne.filter(t=>t.tradeable).map(t=>t.id);function ve(){const{t}=C("pages/trade"),{user:x,account:r}=l.use(I),{ownedCards:i}=l.use(W),[p,f]=l.useState([]),[_,s]=l.useState((r?.max_number_of_cards_wanted??1)-1),[n,j]=l.useState((r?.min_number_of_cards_to_keep??1)+1),[g,y]=l.useState("looking_for"),u=d=>p.length===0?!0:d.rarity!==""&&p.includes(d.rarity),m=l.useMemo(()=>Z.filter(d=>O.includes(d.rarity)&&Q.includes(d.expansion)).filter(d=>{const c=i.findIndex(h=>h.card_id===d.card_id);return c===-1||i[c].amount_owned<=_}),[i,_]),b=l.useMemo(()=>m.filter(u),[m,p]),T=l.useMemo(()=>{const d=i.filter(c=>c.amount_owned>=n);return Z.filter(c=>O.includes(c.rarity)&&Q.includes(c.expansion)).filter(c=>d.findIndex(h=>h.card_id===c.card_id)>-1).map(c=>({...c,amount_owned:d.find(h=>h.card_id===c.card_id)?.amount_owned}))},[i,n]),w=l.useMemo(()=>T.filter(u),[T,p]),a=()=>{let d="";r?.is_public&&(d+=`${t("publicTradePage")} https://tcgpocketcollectiontracker.com/#/collection/${r?.friend_id}/trade
`),r?.username&&(d+=`${t("friendID")} ${r.friend_id} (${r.username})

`),d+=`${t("lookingForCards")}
`;const c=b.sort((o,F)=>{const X=o.expansion.localeCompare(F.expansion);return X!==0?X:o.rarity.localeCompare(F.rarity)});for(let o=0;o<c.length;o++)(o>0?c[o-1].expansion:"")!==c[o].expansion&&(d+=`
${c[o].set_details}:
`),d+=`${c[o].rarity} ${c[o].card_id} - ${c[o].name}
`;const h=b.map(o=>o.rarity);d+=`

${t("forTradeCards")}
`;const k=w.filter(o=>h.includes(o.rarity)).sort((o,F)=>o.rarity.localeCompare(F.rarity));for(let o=0;o<k.length;o++)(o>0?k[o-1].expansion:"")!==k[o].expansion&&(d+=`
${k[o].set_details}:
`),d+=`${k[o].rarity} ${k[o].card_id} - ${k[o].name}
`;return d},v=async()=>{const d=a();U({title:t("copiedInClipboard"),variant:"default",duration:3e3}),await navigator.clipboard.writeText(d)};return x?e.jsx("div",{className:"flex flex-col gap-y-4",children:e.jsxs(Y,{defaultValue:g,onValueChange:y,children:[e.jsxs("div",{className:"mx-auto max-w-[900px] flex flex-row flex-wrap align-center gap-x-4 gap-y-2",children:[e.jsxs(ee,{className:"flex-grow m-auto flex-wrap h-auto border-1 border-neutral-700 rounded-md",children:[e.jsx(S,{value:"looking_for",children:t("lookingFor")}),e.jsx(S,{value:"for_trade",children:t("forTrade")})]}),e.jsx(me,{rarityFilter:p,setRarityFilter:f,rarities:O}),e.jsxs("div",{className:"sm:mt-1 flex flex-row flex-wrap align-center gap-x-4 gap-y-1",children:[g==="looking_for"&&e.jsx(G,{numberFilter:_,setNumberFilter:s,options:[0,1,2,3,4,5],labelKey:"maxNum"}),g==="for_trade"&&e.jsx(G,{numberFilter:n,setNumberFilter:j,options:[2,3,4,5],labelKey:"minNum"}),e.jsx(N,{variant:"outline",onClick:v,children:"Copy to clipboard"})]})]}),e.jsxs("div",{className:"mx-auto max-w-[900px] mt-6",children:[e.jsx($,{value:"looking_for",children:m&&m.length>0?e.jsx(z,{cards:b,extraOffset:105,editable:!1}):e.jsx(ge,{})}),e.jsx($,{value:"for_trade",children:T&&T.length>0?e.jsx(z,{cards:w,extraOffset:105,editable:!1}):e.jsx(je,{})})]})]})}):e.jsx(be,{})}function Ne(){const{t}=C("trade-matches"),{user:x,account:r,setAccount:i}=l.useContext(I),p=se({is_active_trading:ie(),min_number_of_cards_to_keep:J().min(1).max(10),max_number_of_cards_wanted:J().min(1).max(10)}),f=fe({resolver:xe(p),values:{is_active_trading:r?.is_active_trading||!1,min_number_of_cards_to_keep:r?.min_number_of_cards_to_keep||1,max_number_of_cards_wanted:r?.max_number_of_cards_wanted||1}}),_=async s=>{try{const n=await B.from("accounts").upsert({email:x?.user.email,username:r?.username,is_active_trading:s.is_active_trading,min_number_of_cards_to_keep:s.min_number_of_cards_to_keep,max_number_of_cards_wanted:s.max_number_of_cards_wanted}).select().single();if(!n.data)throw console.error("Could not save account",r),new Error("Could not save account");i(n.data),U({title:t("accountSaved"),variant:"default"})}catch(n){console.error("error saving account",n),U({title:t("errorSavingAccount"),variant:"destructive"})}};return e.jsxs("div",{children:[e.jsx(pe,{...f,children:e.jsxs("form",{onSubmit:f.handleSubmit(_),className:"border-1 border-neutral-700 space-y-2 p-4 mx-auto",children:[e.jsx(L,{control:f.control,name:"is_active_trading",render:({field:s})=>e.jsx(M,{className:"flex flex-col items-start",children:e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(V,{className:"flex sm:w-72",children:t("isActiveTrading")}),e.jsx("div",{className:"grow-1",children:e.jsx(te,{checked:s.value,onCheckedChange:s.onChange})}),e.jsx(_e,{className:"grow",children:s.value?"active":"disabled"}),e.jsx(E,{id:"activeInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(A,{className:"h-4 w-4","data-tooltip-id":"activeInput","data-tooltip-content":t("activeTradingInputTooltip")})]})})})}),e.jsx(L,{control:f.control,name:"min_number_of_cards_to_keep",render:({field:s})=>e.jsx(M,{className:"flex flex-col items-start",children:e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(V,{className:"flex sm:w-72",children:t("minNumberOfCardsToKeep")}),e.jsx("div",{className:"grow-1",children:e.jsx(q,{className:"w-24",type:"number",...s})}),e.jsx(E,{id:"minInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(A,{className:"h-4 w-4","data-tooltip-id":"minInput","data-tooltip-content":t("minInputTooltip")})]})})})}),e.jsx(L,{control:f.control,name:"max_number_of_cards_wanted",render:({field:s})=>e.jsx(M,{className:"flex flex-col items-start",children:e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-x-4 flex-wrap",children:[e.jsx(V,{className:"flex sm:w-72",children:t("maxNumberOfCardsWanted")}),e.jsx("div",{className:"grow-1",children:e.jsx(q,{className:"w-24",type:"number",...s})}),e.jsx(E,{id:"maxInput",style:{maxWidth:"300px",whiteSpace:"normal"},clickable:!0}),e.jsx(A,{className:"h-4 w-4","data-tooltip-id":"maxInput","data-tooltip-content":t("maxInputTooltip")})]})})})}),e.jsx("div",{className:"w-full flex justify-end mt-8",children:e.jsx(N,{type:"submit",children:t("save")})})]})}),e.jsx(he,{className:"mt-4"})]})}const Ce=({row:t,selectedTradeId:x,setSelectedTradeId:r})=>{const{t:i,i18n:p}=C("trade-matches"),{account:f}=l.useContext(I),{ownedCards:_}=l.useContext(W);if(!f)return null;const s=t.offering_friend_id===f.friend_id?t.offer_card_id:t.receiver_card_id,n=t.offering_friend_id===f.friend_id?t.receiver_card_id:t.offer_card_id;function j(u){const m=de(u);return m?e.jsxs("span",{className:"flex rounded px-1 w-1/2 bg-zinc-800",children:[e.jsxs("span",{className:"mr-2 sm:min-w-10",children:[m.rarity," "]}),e.jsxs("span",{className:"mr-2 sm:min-w-14 me-4",children:[m.card_id," "]}),e.jsx("span",{children:oe(m,p.language)}),e.jsxs("span",{className:"text-neutral-400 ml-auto",children:["×",_.find(b=>b.card_id===m.card_id)?.amount_owned||0]})]}):e.jsx("span",{className:"w-1/2 text-center",children:"?"})}function g(u){x===u.id?r(void 0):r(u.id)}const y=u=>{const m={offered:{icon:u.offering_friend_id===f.friend_id?"→":"←",color:"bg-amber-600"},accepted:{icon:"↔",color:"bg-lime-600"},declined:{icon:"X",color:"bg-stone-600"},finished:{icon:"✓",color:"bg-indigo-600"}};return e.jsxs(e.Fragment,{children:[e.jsx(E,{id:`tooltip-${u.id}`}),e.jsx("span",{className:`rounded-full text-center w-9 min-w-6 ${m[u.status].color}`,"data-tooltip-id":`tooltip-${u.id}`,"data-tooltip-content":i(`status.${u.status}`),children:m[u.status].icon})]})};return e.jsxs("li",{className:`flex cursor-pointer justify-between rounded gap-1 sm:gap-4 sm:px-1 py-1 my-1 ${x===t.id&&"bg-green-900"} hover:bg-neutral-500`,onClick:()=>g(t),children:[y(t),j(s),j(n)]})};function ye({trades:t,update:x,viewHistory:r}){const{t:i}=C("trade-matches"),{toast:p}=ce();function f(a){return a.offering_friend_id===n?.friend_id&&!a.offerer_ended||a.receiving_friend_id===n?.friend_id&&!a.receiver_ended}const{ownedCards:_,updateCards:s}=l.useContext(W),{account:n,user:j}=l.useContext(I),g=r?t.filter(a=>!f(a)):t.filter(f),[y,u]=l.useState(void 0);if(!n||!j)return null;const m=(a,v)=>({card_id:a,amount_owned:(_.find(d=>d.card_id===a)?.amount_owned??0)+v}),b=async a=>{a.offer_card_id!==a.receiver_card_id&&(a.offering_friend_id===n.friend_id?(await s([m(a.offer_card_id,-1),m(a.receiver_card_id,1)]),p({title:i("collectionUpdated"),variant:"default"})):a.receiving_friend_id===n.friend_id?(await s([m(a.offer_card_id,1),m(a.receiver_card_id,-1)]),p({title:i("collectionUpdated"),variant:"default"})):console.log(a,"can't match friend id"))},T=a=>{const v=async h=>{await x(a.id,{status:h}),u(a.id)},d=async()=>{const h=a.offering_friend_id===n.friend_id?{offerer_ended:!0}:a.receiving_friend_id===n.friend_id?{receiver_ended:!0}:null;if(h===null){console.log(a," doesn't match your friend_id");return}await x(a.id,h),u(void 0)},c=a.offering_friend_id===n.friend_id&&a.offerer_ended||a.receiving_friend_id===n.friend_id&&a.receiver_ended;switch(a.status){case"offered":return e.jsxs(e.Fragment,{children:[a.receiving_friend_id===n.friend_id&&e.jsx(N,{type:"button",onClick:async()=>v("accepted"),children:i("actionAccept")}),e.jsx(N,{type:"button",onClick:async()=>v("declined"),children:a.receiving_friend_id===n.friend_id?i("actionDecline"):i("actionCancel")})]});case"accepted":return e.jsxs(e.Fragment,{children:[e.jsx(N,{type:"button",onClick:async()=>v("finished"),children:i("actionComplete")}),e.jsx(N,{type:"button",onClick:async()=>v("declined"),children:i("actionCancel")})]});case"declined":return c?null:e.jsx(N,{type:"button",onClick:d,children:i("actionHide")});case"finished":return c?null:e.jsxs(e.Fragment,{children:[e.jsx(N,{type:"button",onClick:async()=>{await b(a),await d()},children:i("actionUpdate")}),e.jsx(N,{type:"button",onClick:d,children:i("actionHide")})]});default:return console.log(`Unknown trade status ${a.status}`),null}},w=g.find(a=>a.id===y);return g.length===0?e.jsx("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2 text-center",children:i("noActiveTrades")}):e.jsxs("div",{className:"rounded-lg border-1 border-neutral-700 border-solid p-2",children:[e.jsxs("div",{className:"flex gap-4 px-1",children:[e.jsx("div",{className:"w-9"}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:i("youGive")}),e.jsx("h4",{className:"text-lg font-medium w-1/2 pl-1",children:i("youReceive")})]}),e.jsx("ul",{children:g.toSorted((a,v)=>a.created_at>v.created_at?-1:1).map(a=>e.jsx(Ce,{row:a,selectedTradeId:y,setSelectedTradeId:u},a.id))}),w&&e.jsx("div",{className:"flex gap-4 text-center items-center mt-2",children:T(w)})]})}function we(t,x){return Object.groupBy(t,r=>r.offering_friend_id===x?r.receiving_friend_id:r.receiving_friend_id===x?r.offering_friend_id:(console.log("Fetched row does not match user friend_id",r),"undefined"))}function Te({friendId:t,initialTrades:x}){const{t:r}=C("trade-matches"),[i,p]=l.useState(null),f=le(),[_,s]=l.useState(x),[n,j]=l.useState(!1);async function g(y,u){const m=new Date,{error:b}=await B.from("trades").update({updated_at:m,...u}).eq("id",y);if(b)throw console.log("Error updating trades: ",b),new Error("TradeOffers.tsx:update: Error updating trade");s(T=>T.map(w=>w.id===y?{...w,updated_at:m,...u}:w))}return l.useEffect(()=>{i||ue(t).then(p)}),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2 mx-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-md",children:r("tradingWith")}),e.jsxs("span",{className:"text-md font-bold",children:[" ",i?.username||"loading"," "]})]}),e.jsxs("span",{className:"flex gap-4",children:[e.jsxs("label",{htmlFor:`history-${t}`,className:"my-auto flex items-center",children:[r("viewHistory"),e.jsx(te,{id:`history-${t}`,className:"ml-2 my-auto",checked:n,onCheckedChange:j})]}),e.jsx(N,{className:"my-auto",onClick:()=>f(`/trade/${t}`),children:r("openTradeWith")})]})]}),i!==null&&e.jsx(ye,{trades:_,update:g,viewHistory:n})]})}function ke(){const{t}=C("trade-matches"),{account:x}=l.useContext(I),[r,i]=l.useState(null);if(l.useEffect(()=>{x&&r===null&&(console.log("Refrehing trades"),B.from("trades").select().then(({data:s,error:n})=>{n?console.log("Error fetching trades: ",n):i(s)}))}),r===null||!x)return null;if(r.length===0)return e.jsx("p",{children:t("noTradeOffers")});const p=we(r,x.friend_id),f=Object.fromEntries(Object.entries(p).map(([s,n])=>[s,Math.max(...n.map(j=>new Date(j.updated_at).getTime()))])),_=Object.keys(p).toSorted((s,n)=>f[n]-f[s]);return e.jsx("div",{className:"flex flex-col items-center mx-auto gap-12 sm:px-4 mb-12",children:_.map(s=>e.jsx(Te,{friendId:s,initialTrades:p[s]},s))})}function Ve(){const{t}=C("trade-matches");return e.jsxs(Y,{className:"flex flex-col mx-auto max-w-[900px]",defaultValue:"offers",children:[e.jsxs(ee,{className:"gap-4 mb-6 rounded-lg border-b-1 border-neutral-700 border-solid dark:bg-transparent pb-2",children:[e.jsx(S,{className:"text-md",value:"cards",children:t("tabCards")}),e.jsx(S,{className:"text-md",value:"offers",children:t("tabOffers")}),e.jsx(S,{className:"text-md",value:"settings",children:t("tabSettings")})]}),e.jsx($,{value:"cards",children:e.jsx(ve,{})}),e.jsx($,{value:"offers",children:e.jsx(ke,{})}),e.jsx($,{value:"settings",children:e.jsx(Ne,{})})]})}export{Ve as default};
